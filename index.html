<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOIN - BETA 1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 0.75rem;
        }
        /* Estilos para la pantalla de login */
        #login-page {
            background-color: #E0FFE0; /* Un verde claro y suave */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }
        /* Asegura que la página de login esté completamente oculta cuando se aplica la clase 'hidden' */
        #login-page.hidden {
            display: none !important;
        }

        /* Asegura que la aplicación principal se muestre como flex cuando no esté oculta */
        #main-app:not(.hidden) {
            display: flex;
            flex-direction: column; /* Asumiendo que debe ser un diseño de columna */
            flex-grow: 1; /* Permite que tome la altura disponible */
        }

        .header-container {
            background-color: #1F4740;
            color: #ffffff;
            padding: 0.6rem 0.9rem;
            display: flex;
            flex-direction: column; /* Cambiado a columna para apilar elementos */
            align-items: center; /* Centra los elementos horizontalmente en el contenedor */
            min-height: 70px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }

        .header-main-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Ocupa todo el ancho disponible */
        }

        .header-logo {
            flex-shrink: 0;
            margin-right: 0.4rem;
        }
        .header-logo img {
            height: 50px;
            width: auto;
            border-radius: 0.35rem;
        }
        .header-title {
            flex-grow: 1; /* Permite que el título ocupe el espacio disponible */
            text-align: center;
            margin: 0 0.4rem;
        }
        .header-title h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.05em; }
        .header-title h2 { font-size: 0.9rem; }
        .header-title h3 { font-size: 0.75rem; color: #d1d5db; margin-top: 2px; }

        .header-nav {
            display: flex;
            gap: 0.4rem;
            width: 100%; /* Ocupa todo el ancho disponible */
            justify-content: flex-start; /* Alinea los botones a la izquierda */
            margin-top: 0.5rem; /* Espacio para el "salto de línea" */
            padding-left: 0; /* Asegura que no haya padding extra a la izquierda */
        }
        .header-nav a, .header-nav button {
            color: #ffffff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.35rem;
            transition: background-color 0.3s ease;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        .header-nav a:hover, .header-nav button:hover {
            background-color: #333d4b;
        }
        .main-layout {
            display: flex;
            flex-grow: 1;
            padding: 0.6rem;
            gap: 0.6rem;
            flex-wrap: nowrap;
            align-items: flex-start;
        }
        .sidebar {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.8rem;
            width: 180px;
            flex-shrink: 0;
        }
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
            }
        }
        .sidebar .module-header {
            background-color: #2A5C50;
            color: #ffffff;
            padding: 0.4rem 0.6rem;
            border-radius: 0.3rem;
            margin-bottom: 0.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.75rem;
        }
        .sidebar .module-header:hover {
            background-color: #3A756A;
        }
        .sidebar .module-header svg {
            transition: transform 0.3s ease;
        }
        .sidebar .module-header.collapsed svg {
            transform: rotate(-90deg);
        }
        .sidebar .submodule-list {
            list-style: none;
            padding: 0;
            margin-bottom: 0.4rem;
            padding-left: 0.2rem;
        }
        .sidebar .submodule-list li a {
            display: block;
            padding: 0.2rem 0.6rem;
            color: #4a5568;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.7rem;
        }
        .sidebar .submodule-list li a:hover {
            background-color: #dbe4ed;
            color: #2d3748;
        }
        .sidebar .submodule-list li.active-item a {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
        }
        .content-area {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.9rem;
            flex-grow: 1;
            min-width: calc(100% - 180px - 1.2rem);
            overflow-y: auto;
            height: calc(100vh - 70px - 1.2rem - 0.6rem - 1.2rem);
        }
        @media (max-width: 1024px) {
            .content-area {
                min-width: unset;
                width: 100%;
                height: auto;
            }
        }
        .data-table-container {
            overflow-x: auto;
            margin-top: 0.6rem;
            border-radius: 0.3rem;
            border: 1px solid #e2e8f0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }
        .data-table th, .data-table td {
            padding: 0.35rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border-top: 2px solid #2A5C50;
            border-left: 1px solid #3A756A;
            border-right: 1px solid #3A756A;
            text-align: center;
        }
        .data-table th:first-child {
            border-left: none;
        }
        .data-table th:last-child {
            border-right: none;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f8;
        }
        .data-table tbody tr.selected {
            background-color: #e0f2f7;
            border-left: 3px solid #00796b;
        }
        .footer-container {
            background-color: #ffffff;
            text-align: center;
            padding: 0.6rem;
            margin-top: 0.6rem;
            border-radius: 0.6rem;
            box-shadow: 0 -3px 5px rgba(0, 0, 0, 0.08);
        }
        .footer-container label {
            color: #4a5568;
            font-size: 0.65rem;
        }
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .select-wrapper select {
            appearance: none;
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.25rem 0.9rem 0.25rem 0.6rem;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            cursor: pointer;
            width: 100%;
        }
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #718096;
            font-size: 0.6rem;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            justify-content: flex-start;
        }
        .radio-group label {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            font-size: 0.65rem;
            color: #4a5568;
            min-width: 32px;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group input[type="radio"]:checked + span {
            background-color: #A0522D;
            color: white;
            border-color: #8B4513;
            box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.3);
            font-weight: 600;
        }
        .radio-group label:hover {
            background-color: #e2e8f0;
        }
        .form-field-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        @media (min-width: 768px) {
            .form-field-group.row-layout {
                flex-direction: row;
                align-items: center;
            }
            .form-field-group.row-layout > label {
                width: 18%;
                flex-shrink: 0;
            }
            .form-field-group .flex-grow {
                flex-grow: 1;
            }
        }
        .form-field-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.1rem;
        }
        .institution-filter-container {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .institution-filter-input {
            width: 100%;
            padding: 0.25rem 0.6rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .institution-filter-input:focus {
            border-color: #A0522D;
            box-shadow: 0 0 0 2px rgba(160, 82, 45, 0.2);
        }
        .institution-suggestions {
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.35rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            margin-top: 0.2rem;
            top: 100%;
        }
        .institution-suggestions div {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #4a5568;
            transition: background-color 0.15s ease;
        }
        .institution-suggestions div:hover {
            background-color: #e2e8f0;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.6rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #4a5568;
        }
        .modal-header {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #2d3748;
            text-align: center;
        }
        .modal-form-group {
            margin-bottom: 0.8rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-buttons button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .modal-buttons .btn-save {
            background-color: #2A5C50;
            color: white;
        }
        .modal-buttons .btn-save:hover {
            background-color: #1A3F38;
        }
        .modal-buttons .btn-cancel {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #cbd5e0;
        }
        .modal-buttons .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .modal-buttons .btn-delete:hover {
            background-color: #dc2626;
        }
        .edit-list-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }
        .edit-list-button svg {
            width: 16px;
            height: 16px;
            color: #4a5568;
        }
        .edit-list-button:hover svg {
            color: #2d3748;
        }
        #edit-list-modal-overlay .modal-content {
            max-width: 400px;
        }
        .period-program-modal-content {
            max-width: 800px;
        }
        .period-program-modal-content .grid-item {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            border-radius: 0.4rem;
            padding: 0.8rem;
        }
        .period-program-modal-content .grid-item h5 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #2d3748;
        }
        .period-program-modal-content .selected-institution-info {
            background-color: #e0f2f7;
            border: 1px solid #b2ebf2;
            padding: 0.5rem;
            border-radius: 0.4rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #00796b;
            font-weight: bold;
        }
        #history-modal-overlay .modal-content {
            max-width: 800px;
        }
        #history-modal-overlay .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.3rem;
        }
        #history-modal-overlay .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        #history-modal-overlay .history-table th,
        #history-modal-overlay .history-table td {
            padding: 0.4rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        #history-modal-overlay .history-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.6rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #info-modal p {
            font-size: 0.8rem;
            text-align: center;
            color: #374151;
        }

        .btn-visualizar {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-visualizar:hover {
            background-color: #8B4513;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-visualizar:active {
            background-color: #7A3D0F;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }

        .btn-acceso {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-acceso:hover {
            background-color: #8B4513;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-acceso:active {
            background-color: #7A3D0F;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }
        /* Estilo para el recuadro de usuario y contraseña */
        .credentials-box {
            border: 1px solid #cbd5e0;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-top: 1rem;
            background-color: #f7fafc;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .credentials-box label {
            font-weight: 600;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <!-- Pantalla Principal (Login) -->
    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl">
            <div class="text-center mb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno" class="mx-auto h-16">
                <h2 class="text-lg font-semibold text-gray-700 mt-2">Secretaría Anticorrupción y Buen Gobierno</h2>
                <p class="text-sm text-gray-500">Sistema de Control Interno</p>
            </div>
            <div class="flex items-center justify-center space-x-6 mb-6">
                <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN" class="h-16">
                <div>
                    <div class="mb-2">
                        <label for="username-login" class="text-xs text-gray-600">Usuario:</label>
                        <input type="text" id="username-login" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="admin_user">
                    </div>
                    <div>
                        <label for="password-login" class="text-xs text-gray-600">Contraseña:</label>
                        <input type="password" id="password-login" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="password123">
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mb-6">Aplicación web para la Evaluación del SCII</p>
            <button onclick="accessSystem()" class="w-full btn-acceso">
                Accesar
            </button>
        </div>
    </div>

    <!-- Contenido principal de la aplicación SICOIN (inicialmente oculto) -->
    <div id="main-app" class="hidden">
        <header class="header-container">
            <div class="header-main-content">
                <!-- Logo izquierdo -->
                <div class="header-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno">
                </div>
                <!-- Título central que se expande -->
                <div class="header-title">
                    <h1>SICOIN – MEJORA PROPUESTA</h1>
                    <h2>Sistema de Control Interno Institucional</h2>
                    <h3>V 1.0</h3>
                </div>
                <!-- Logo derecho -->
                <div class="header-logo">
                    <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN">
                </div>
            </div>
            <!-- Botones de navegación alineados a la izquierda en una nueva línea -->
            <nav class="header-nav">
                <a href="#" onclick="goHome(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Inicio
                </a>
                <a href="#" onclick="logout(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Salir
                </a>
                <button onclick="openInfoModal()" title="Acerca de">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                </button>
            </nav>
        </header>
        <div class="main-layout">
            <aside class="sidebar">
                <nav>
                    <ul>
                        <li>
                            <h3 class="module-header" onclick="toggleSubmodules(this)">
                                Consulta SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list">
                                <li class="active-item"><a href="#" onclick="showModule('consulta-instituciones', this)">▪ Consulta Instituciones</a></li>
                                <li><a href="#" onclick="showModule('catalogo-instituciones', this)">▪ Catálogo Instituciones</a></li>
                            </ul>
                        </li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Administración SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('programacion-periodos', this)">▪ Programación de periodos</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-am', this)">▪ Modifica Avance Trimestral AM</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-ac', this)">▪ Modifica Avance Trimestral AC</a></li>
                                <li><a href="#" onclick="showModule('procesos-registrados', this)">▪ Procesos Registrados x Oficio</a></li>
                                <li><a href="#" onclick="showModule('control-usuarios', this)">▪ Control de Usuarios</a></li>
                                <li><a href="#" onclick="showModule('registro-acciones', this)">▪ Registro de Acciones de Usuarios</a></li>
                                <li><a href="#" onclick="showModule('comunicados', this)">▪ Comunicados</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Reportes
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('reporte-avance-institucional', this)">▪ Reporte de Avance Institucional</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-reporte', this)">▪ Acciones de Mejora</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-reporte', this)">▪ Acciones de Control</a></li>
                                <li><a href="#" onclick="showModule('seguimiento-trimestral', this)">▪ Reporte Seguimiento Trimestral</a></li>
                                <li><a href="#" onclick="showModule('conclusion', this)">▪ Conclusión</a></li>
                                <li><a href="#" onclick="showModule('consolidado', this)">▪ Consolidado</a></li>
                                <li><a href="#" onclick="showModule('reporte-acciones-mejora', this)">▪ Reporte Acciones Mejora</a></li>
                                <li><a href="#" onclick="showModule('reporte-ptci-ptar', this)">▪ Reporte PTCI y PTAR (Excel)</a></li>
                                <li><a href="#" onclick="showModule('evaluacion-oic', this)">▪ Evaluación de OIC (Excel)</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-trimestre', this)">▪ Acciones Mejora por Trimestre</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-trimestre', this)">▪ Acciones Control Trimestral</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptci', this)">▪ Imprimir Programa de Trabajo de Control Interno</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptar', this)">▪ Imprimir Programa de Trabajo de Administración de Riesgo</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Usuario
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('cambiar-contrasena', this)">▪ Cambiar Contraseña</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>
            <section class="content-area">
                <div id="module-home" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Bienvenido al Sistema de Control Interno Institucional</h2>
                    <p class="text-center text-gray-600 text-xs">Selecciona una opción del menú lateral para comenzar.</p>
                </div>

                <div id="module-consulta-instituciones" class="module-content">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Elige Institución y Perfil que deseas consultar</h2>
                    </div>
                    <form action="#" method="post" class="space-y-2.5">
                        <div class="form-field-group row-layout">
                            <label for="periodo">Periodo</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="periodo" value="2014"><span>2014</span></label>
                                <label><input type="radio" name="periodo" value="2015"><span>2015</span></label>
                                <label><input type="radio" name="periodo" value="2016"><span>2016</span></label>
                                <label><input type="radio" name="periodo" value="2017"><span>2017</span></label>
                                <label><input type="radio" name="periodo" value="2018"><span>2018</span></label>
                                <label><input type="radio" name="periodo" value="2019"><span>2019</span></label>
                                <label><input type="radio" name="periodo" value="2020"><span>2020</span></label>
                                <label><input type="radio" name="periodo" value="2021"><span>2021</span></label>
                                <label><input type="radio" name="periodo" value="2022"><span>2022</span></label>
                                <label><input type="radio" name="periodo" value="2023"><span>2023</span></label>
                                <label><input type="radio" name="periodo" value="2024" checked><span>2024</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="estatus">Estatus</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="estatus" value="1" checked><span>Activo</span></label>
                                <label><input type="radio" name="estatus" value="0"><span>Inactivo</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="consulta-institucion-filter">Institución</label>
                            <div class="institution-filter-container flex-grow">
                                <input type="text" id="consulta-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off">
                                <input type="hidden" id="consulta-institucion-id" name="institucion_id">
                                <div id="consulta-institucion-suggestions" class="institution-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="perfil">Perfil</label>
                            <div class="select-wrapper flex-grow">
                                 <select id="perfil" name="perfil" class="w-full">
                                    <option value="" selected>Seleccione Perfil</option>
                                    <option value="1">Coordinador de Control Interno</option>
                                    <option value="2">Instancia de Control Interno</option>
                                    <option value="5">Riesgos</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="btn-visualizar">Visualizar</button>
                        </div>
                    </form>
                </div>

                <div id="module-catalogo-instituciones" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Catálogo de Instituciones</h2>
                    </div>

                    <div class="flex justify-end mb-2.5">
                        <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="openInstitutionModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                                <path d="M12 5v14"/><path d="M5 12h14"/>
                            </svg>
                            Agregar
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table" id="institutions-catalog-table">
                            <thead>
                                <tr>
                                    <th>Siglas</th>
                                    <th>Institución</th>
                                    <th>Tipo de Institución</th>
                                    <th>Sector</th>
                                    <th>Estatus</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="institution-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeInstitutionModal()">&times;</button>
                        <h3 class="modal-header" id="institution-modal-title">Agregar Institución</h3>
                        <form id="institution-form">
                            <input type="hidden" id="institution-id-edit">
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-tipo-institucion" style="min-width: 120px;">Tipo de Institución</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-tipo-institucion" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('tipoInstitucion')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-sector" style="min-width: 120px;">Sector</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-sector" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('sector')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-estatus" style="min-width: 120px;">Estatus</label>
                                <div class="radio-group flex-grow">
                                    <label><input type="radio" name="modal-estatus" value="Activa" checked><span>Activa</span></label>
                                    <label><input type="radio" name="modal-estatus" value="Inactiva"><span>Inactiva</span></label>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-siglas" style="min-width: 120px;">Siglas</label>
                                <input type="text" id="modal-siglas" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-institucion-nombre" style="min-width: 120px;">Institución</label>
                                <input type="text" id="modal-institucion-nombre" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" class="btn-cancel" onclick="closeInstitutionModal()">Cancelar</button>
                                <button type="submit" class="btn-save">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="edit-list-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditListModal()">&times;</button>
                        <h3 class="modal-header" id="edit-list-modal-title">Editar Lista</h3>
                        <div id="edit-list-container" class="max-h-60 overflow-y-auto border rounded-md mb-4">
                            </div>
                        <div class="flex gap-2 mt-4">
                            <input type="text" id="new-list-item-input" class="flex-grow p-2 border rounded text-xs" placeholder="Nuevo elemento">
                            <button type="button" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-lg text-xs" onclick="addListItem()">Agregar</button>
                        </div>
                        <div class="modal-buttons mt-4">
                            <button type="button" class="btn-cancel" onclick="closeEditListModal()">Cerrar</button>
                        </div>
                    </div>
                </div>

                <div id="edit-single-list-item-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditSingleListItemModal()">&times;</button>
                        <h3 class="modal-header">Editar Elemento</h3>
                        <input type="hidden" id="edit-single-list-item-index">
                        <input type="hidden" id="edit-single-list-item-type">
                        <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="edit-single-list-item-input" style="min-width: 120px;">Nuevo Valor</label>
                            <input type="text" id="edit-single-list-item-input" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" onclick="closeEditSingleListItemModal()">Cancelar</button>
                            <button type="button" class="btn-save" onclick="saveEditedListItem()">Guardar</button>
                        </div>
                    </div>
                </div>

                <div id="module-programacion-periodos" class="module-content hidden">
                    <div class="bg-gray-200 p-3 rounded-t-lg text-center mb-4 shadow-sm">
                        <h2 class="text-base font-bold text-gray-800">Programación de periodos</h2>
                        <h3 class="text-sm text-gray-700">Para Evaluación, Acciones de Mejora o Acciones de Control</h3>
                        <h4 class="text-xs text-gray-600 mt-1">Consulta APF</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4">
                        <div class="space-y-3">
                            <div class="form-field-group">
                                <label for="tipo-accion-filter">Tipo de Acción</label>
                                <div class="select-wrapper">
                                    <select id="tipo-accion-filter" onchange="renderProgramacionPeriodosTable()"></select>
                                </div>
                            </div>
                            <div class="form-field-group">
                                <label for="programacion-institucion-filter">Institución</label>
                                <div class="institution-filter-container">
                                    <input type="text" id="programacion-institucion-filter" class="institution-filter-input" placeholder="Filtrar por institución..." autocomplete="off">
                                    <button onclick="clearInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                    </button>
                                    <div id="programacion-institucion-suggestions" class="institution-suggestions hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mt-4 md:mt-0">
                            <div class="form-field-group">
                                <label for="ptci-actualizado-filter">Filtrar por PTCI actualizado</label>
                                <div class="select-wrapper">
                                    <select id="ptci-actualizado-filter" onchange="renderProgramacionPeriodosTable()">
                                        <option value="todos">Todos</option>
                                        <option value="Sí">Sí Actualizó PTCI</option>
                                        <option value="No">No Actualizó PTCI</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-end justify-end gap-2 pt-1">
                                 <button id="history-button" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openHistoryModal()" style="display: none;">Historial</button>
                                <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openAperturarModal()">Aperturar Sistema</button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="programacion-periodos-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-institutions" onchange="toggleAllInstitutions(this.checked)"></th>
                                    <th>Periodo</th>
                                    <th>Siglas</th>
                                    <th>Institución</th>
                                    <th>Actualizó PTCI</th>
                                    <th>Trimestre</th>
                                    <th>ACCIÓN PERMITIDA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="aperturar-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content period-program-modal-content">
                        <button class="modal-close-button" onclick="closeAperturarModal()">&times;</button>
                        <h3 class="modal-header">Aperturar Sistema</h3>
                        <div id="selected-institutions-display" class="selected-institution-info mb-4 hidden"></div>
                        <form id="aperturar-form" class="space-y-4"></form>
                    </div>
                </div>

                <div id="history-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeHistoryModal()">&times;</button>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="modal-header flex-grow text-left p-0 m-0">Historial: <span id="history-institution-name"></span></h3>
                            <div class="form-field-group w-1/2">
                                <label for="history-action-filter" class="sr-only">Filtrar por acción</label>
                                <div class="select-wrapper">
                                    <select id="history-action-filter" onchange="renderHistoryTable()"></select>
                                </div>
                            </div>
                        </div>
                        <div class="history-table-container">
                            <table class="history-table">
                                <thead><tr><th>Periodo</th><th>Trimestre</th><th>Acción</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Usuario</th></tr></thead>
                                <tbody id="history-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="module-reporte-avance-institucional" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Reporte Global de Avance Institucional en la Evaluación del SCI</h2>
                    </div>

                    <div class="flex flex-col mb-2.5">
                        <div class="mb-2.5">
                            <label for="estatus_reporte" class="sr-only">Estatus de Institución</label>
                            <div class="radio-group">
                                <label><input type="radio" name="estatus_reporte" value="1" checked onchange="renderReporteAvanceInstitucionalTable()"><span>Activo</span></label>
                                <label><input type="radio" name="estatus_reporte" value="0" onchange="renderReporteAvanceInstitucionalTable()"><span>Inactivo</span></label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="select-wrapper" style="width: auto;">
                                <label for="anio_input" class="sr-only">Elige periodo</label>
                                <select id="anio_input" name="anio_input" style="width: 90px; padding: 0.2rem 0.9rem 0.2rem 0.5rem; font-size: 0.7rem;" onchange="renderReporteAvanceInstitucionalTable()">
                                    <option value="todos">TODOS</option>
                                    <option value="2014">2014</option>
                                    <option value="2015">2015</option>
                                    <option value="2016">2016</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <a href="#" class="export-button" onclick="exportReporteAvanceInstitucional()" style="background-color: #2A5C50; color: white; padding: 0.2rem 0.5rem; border-radius: 0.3rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.2rem; margin-bottom: 0.4rem; transition: background-color 0.3s ease; font-size: 0.7rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Exportar a Excel
                            </a>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <!-- Los encabezados de la tabla se generarán dinámicamente con JavaScript -->
                            </thead>
                            <tbody>
                                <!-- Los datos de la tabla se generarán dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="info-modal" class="modal-overlay hidden">
                    <div class="modal-content max-w-sm">
                         <button class="modal-close-button" onclick="closeInfoModal()">&times;</button>
                         <p>Esta interfaz se creó con el objetivo de visualizar las mejoras propuestas para el Sistema de Control Interno Institucional (SICOIN).</p>
                    </div>
                </div>

                <!-- Nuevo Módulo: Control de Usuarios -->
                <div id="module-control-usuarios" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Control de Usuarios</h2>
                    </div>

                    <div class="flex justify-between items-center mb-2.5">
                        <div class="radio-group">
                            <label><input type="radio" name="user_status_filter" value="todos" checked onchange="renderUsersTable()"><span>Todos</span></label>
                            <label><input type="radio" name="user_status_filter" value="Activo" onchange="renderUsersTable()"><span>Activos</span></label>
                            <label><input type="radio" name="user_status_filter" value="Inactivo" onchange="renderUsersTable()"><span>Inactivos</span></label>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="generateHistoricalAccessReport()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Reporte Histórico de Accesos
                            </button>
                            <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="openUserModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                                    <path d="M12 5v14"/><path d="M5 12h14"/>
                                </svg>
                                Agregar Usuario
                            </button>
                        </div>
                    </div>

                    <div class="mb-2.5">
                        <input type="text" id="user-search-input" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" placeholder="Buscar por siglas, nombre de institución o nombre de usuario..." onkeyup="renderUsersTable()">
                    </div>

                    <div class="data-table-container">
                        <table class="data-table" id="users-table">
                            <thead>
                                <tr>
                                    <th>Siglas Institución</th>
                                    <th>Nombre Institución</th>
                                    <th>Perfil</th>
                                    <th>Usuario</th>
                                    <th>Contraseña</th>
                                    <th>Estatus</th>
                                    <th>Correo</th>
                                    <th>Teléfono</th>
                                    <th>Tipo Usuario</th>
                                    <th>Cargo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal para Agregar/Editar Usuario -->
                <div id="user-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeUserModal()">&times;</button>
                        <h3 class="modal-header" id="user-modal-title">Agregar Usuario</h3>
                        <form id="user-form">
                            <input type="hidden" id="user-id-edit">

                            <div class="modal-form-group">
                                <label for="user-estatus">Estatus</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="user-estatus" value="Activo" checked><span>Activo</span></label>
                                    <label><input type="radio" name="user-estatus" value="Inactivo"><span>Inactivo</span></label>
                                </div>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-tipo-usuario">Tipo Usuario</label>
                                <select id="user-tipo-usuario" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs"></select>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-perfil">Perfil</label>
                                <select id="user-perfil" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required></select>
                            </div>
                             <div class="modal-form-group">
                                <label for="user-siglas-institucion-filter">Siglas Institución</label>
                                <div class="institution-filter-container">
                                    <input type="text" id="user-siglas-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off" required>
                                    <input type="hidden" id="user-siglas-institucion-id">
                                    <div id="user-siglas-institucion-suggestions" class="institution-suggestions hidden"></div>
                                </div>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-nombre">Nombre</label>
                                <input type="text" id="user-nombre" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-cargo">Cargo</label>
                                <select id="user-cargo" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs"></select>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-correo">Correo</label>
                                <input type="email" id="user-correo" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                            </div>
                            <div class="modal-form-group">
                                <label for="user-telefono">Teléfono</label>
                                <input type="text" id="user-telefono" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                            </div>

                            <div class="credentials-box">
                                <h4 class="text-sm font-bold mb-3">Credenciales de Acceso</h4>
                                <div class="modal-form-group">
                                    <label for="user-clave">Nombre de Usuario</label>
                                    <input type="text" id="user-clave" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                                </div>
                                <div class="modal-form-group">
                                    <label for="user-password">Contraseña</label>
                                    <input type="password" id="user-password" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" placeholder="**********" required>
                                </div>
                            </div>

                            <div class="modal-buttons">
                                <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancelar</button>
                                <button type="submit" class="btn-save">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal para Reporte de Acceso de Usuario -->
                <div id="user-access-report-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content period-program-modal-content">
                        <button class="modal-close-button" onclick="closeUserAccessReportModal()">&times;</button>
                        <h3 class="modal-header">Reporte de Acceso para: <span id="report-user-name"></span> (<span id="report-user-clave"></span>)</h3>
                        <div class="flex justify-end mb-2">
                             <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="downloadUserAccessReport()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Descargar CSV
                            </button>
                        </div>
                        <div class="data-table-container">
                            <table class="data-table" id="user-access-report-table">
                                <thead>
                                    <tr>
                                        <th>Año</th>
                                        <th>Siglas</th>
                                        <th>Clave de Usuario</th>
                                        <th>Fecha de Acceso</th>
                                        <th>Hora de Inicio</th>
                                        <th>Hora de Cierre</th>
                                        <th>Duración (min)</th>
                                        <th>Módulo Accedido</th>
                                        <th>Acción Realizada</th>
                                        <th>Campo Modificado</th>
                                        <th>Tipo de Evento</th>
                                        <th>Resultado</th>
                                        <th>Dirección IP</th>
                                        <th>Agente de Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="user-access-report-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="module-modifica-avance-am" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Modifica Avance Trimestral AM</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para modificar avance trimestral AM.</p>
                </div>
                <div id="module-modifica-avance-ac" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Modifica Avance Trimestral AC</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para modificar avance trimestral AC.</p>
                </div>
                <div id="module-procesos-registrados" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Procesos Registrados por Oficio</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para procesos registrados por oficio.</p>
                </div>
                <!-- El módulo de Registro de Acciones de Usuarios se mantiene como placeholder -->
                <div id="module-registro-acciones" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Registro de Acciones de Usuarios</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el registro de acciones de usuarios.</p>
                </div>
                <div id="module-comunicados" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Comunicados</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para comunicados.</p>
                </div>
                <div id="module-acciones-mejora-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Mejora</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de Acciones de Mejora.</p>
                </div>
                <div id="module-acciones-control-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Control</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de Acciones de Control.</p>
                </div>
                <div id="module-seguimiento-trimestral" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Seguimiento Trimestral</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de seguimiento trimestral.</p>
                </div>
                <div id="module-conclusion" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Conclusión</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para la conclusión.</p>
                </div>
                <div id="module-consolidado" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Consolidado</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el consolidado.</p>
                </div>
                <div id="module-reporte-acciones-mejora" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Acciones Mejora</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de acciones de mejora.</p>
                </div>
                <div id="module-reporte-ptci-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte PTCI y PTAR (Excel)</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte PTCI y PTAR.</p>
                </div>
                <div id="module-evaluacion-oic" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Evaluación de OIC (Excel)</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para la evaluación de OIC.</p>
                </div>
                <div id="module-acciones-mejora-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Mejora por Trimestre</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para acciones de mejora por trimestre.</p>
                </div>
                <div id="module-acciones-control-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Control Trimestral</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para acciones de control trimestral.</p>
                </div>
                <div id="module-imprimir-ptci" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Control Interno</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para imprimir PTCI.</p>
                </div>
                <div id="module-imprimir-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Administración de Riesgo</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para imprimir PTAR.</p>
                </div>
                <div id="module-cambiar-contrasena" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Cambiar Contraseña</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para cambiar la contraseña del usuario.</p>
                </div>

            </section>
        </div>

        <footer class="footer-container">
            <label>Insurgentes Sur 1735, Col. Guadalupe Inn Ciudad de México., C.P 01020 - Tel. 2000 3000</label>
            <br>
            <label>Secretaría Anticorrupción y Buen Gobierno, México - algunos derechos reservados © 2016 </label>
        </footer>
    </div>

    <script>
        // --- BASE DE DATOS Y ESTADO GLOBAL ---
        // Datos iniciales para instituciones. En un entorno de producción, estos datos se cargarían desde una base de datos.
        const initialInstitutionsData = [
            { id: '224', siglas: 'APBP', nombre: 'Administración del Patrimonio de la Beneficencia Pública', tipo: 'Organismo Descentralizado', sector: '12 SALUD', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '310', siglas: 'ASPNAC', nombre: 'Administración del Sistema Portuario Nacional Acapulco, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '44', siglas: 'ASPNA', nombre: 'Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '312', siglas: 'ASPNCSL', nombre: 'Administración del Sistema Portuario Nacional Cabo San Lucas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '45', siglas: 'ASPNCO', nombre: 'Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '46', siglas: 'ASPNDB', nombre: 'Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '47', siglas: 'ASPNE', nombre: 'Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '48', siglas: 'ASPNG', nombre: 'Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '49', siglas: 'ASPNLC', nombre: 'Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '50', siglas: 'ASPNM', nombre: 'Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '999', siglas: 'IPPR', nombre: 'Institución de Prueba para el Reporte', tipo: 'Dependencia', sector: '99 Entidad no Coordinada Sectorialmente', estatus: 'Activa', ptciActualizado: 'Sí' }
        ];

        // Listas de opciones predefinidas para los selects.
        const defaultTipoInstitucion = [
            "Dependencia", "Órgano Administrativo Desconcentrado", "Organismo Descentralizado",
            "Empresa de Participación Estatal Mayoritaria", "Organismo Descentralizado No Sectorizado",
            "Fideicomiso Público", "Fideicomiso Público que forma parte del Sistema Financiero Mexicano",
            "Organismo Autónomo"
        ];

        const defaultSector = [
            "04 Gobernación", "05 Relaciones Exteriores", "06 Hacienda y Crédito Público",
            "07 Defensa Nacional", "08 Agricultura y Desarrollo Rural", "09 Infraestructura, Comunicaciones y Transportes",
            "10 Economía", "11 Educación Pública", "12 Salud", "13 Marina",
            "14 Trabajo y Previsión Social", "15 Desarrollo Agrario, Territorial y Urbano",
            "16 Medio Ambiente y Recursos Naturales", "17 Procuraduría General de la República",
            "18 Energía", "20 Bienestar", "21 Turismo",
            "25 Previsiones y Aportaciones para los Sistemas de Educación Básica, Normal, Tecnológica y de Adultos",
            "27 Función Pública", "36 Seguridad y Protección Ciudadana",
            "37 Consejería Jurídica del Ejecutivo Federal", "45 Comisión Reguladora de Energía",
            "46 Comisión Nacional de Hidrocarburos", "47 Entidades no Sectorizadas", "48 Cultura",
            "49 Fiscalía General de la República", "55 Agencia de Transformación Digital y Telecomunicaciones",
            "99 Entidad no Coordinada Sectorialmente"
        ];

        // Definición de las categorías y acciones disponibles para la programación de periodos.
        const availableActionsCategories = {
            "Evaluación Institución": ["Habilitar edición de procesos prioritarios y PTCI actualizado", "Habilitar evaluación del SCII", "Habilitar Captura de Informe Anual Finalizado"],
            "PTCI": ["Habilitar Captura del PTCI", "Habilitar captura del PTCI Actualizado", "Habilitar captura Seguimiento AM", "Habilitar captura Reporte Trimestral AM"],
            "PTAR": ["Habilitar captura Riesgos en el periodo", "Habilitar captura Seguimiento de AC", "Habilitar captura Reporte Trimestral AC"],
            "Evaluación OIC": ["Habilitar evaluación del OIC", "Habilitar OIC-Seguimiento de Acciones Mejora", "Habilitar OIC-Reporte Trimestral AM", "Habilitar OIC-Seguimiento de Acciones Control", "Habilitar OIC-Reporte Trimestral AC"]
        };

        // Datos iniciales para usuarios. Incluye el usuario por defecto para el login.
        const initialUsersData = [
            { id: 'user1', clave: 'admin_user', password: 'password123', nombre: 'Administrador Principal', perfil: 'Coordinador de Control Interno', estatus: 'Activo', correo: 'admin.user@example.com', telefono: '5511112222', tipoUsuario: 'Interno', cargo: 'Director General', siglasInstitucion: 'APBP' },
            { id: 'user2', clave: 'maria_g', password: 'password123', nombre: 'María García', perfil: 'Instancia de Control Interno', estatus: 'Activo', correo: 'maria.garcia@example.com', telefono: '5587654321', tipoUsuario: 'Interno', cargo: 'Jefe de Departamento', siglasInstitucion: 'ASPNAC' },
            { id: 'user3', clave: 'carlos_l', password: 'password123', nombre: 'Carlos López', perfil: 'Riesgos', estatus: 'Inactivo', correo: 'carlos.lopez@example.com', telefono: '5511223344', tipoUsuario: 'Externo', cargo: 'Consultor', siglasInstitucion: 'ASPNA' },
            { id: 'user4', clave: 'ana_d', password: 'password123', nombre: 'Ana Díaz', perfil: 'Coordinador de Control Interno', estatus: 'Activo', correo: 'ana.diaz@example.com', telefono: '5599887766', tipoUsuario: 'Interno', cargo: 'Subdirector', siglasInstitucion: 'ASPNCO' },
        ];

        // Datos iniciales para los registros de acceso de usuarios.
        const initialUserAccessLogs = [
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-20', horaInicio: '09:00:00', horaCierre: '09:30:00', duracionSesion: 30, moduloAccedido: 'Consulta Instituciones', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-20', horaInicio: '09:30:00', horaCierre: '09:35:00', duracionSesion: 5, moduloAccedido: 'Catálogo Instituciones', accionRealizada: 'Modificación', campoModificado: 'Institución APBP', tipoEvento: 'Cierre', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user2', year: 2024, siglas: 'ASPNAC', claveUsuario: 'maria_g', fechaAcceso: '2024-07-21', horaInicio: '10:15:00', horaCierre: '10:45:00', duracionSesion: 30, moduloAccedido: 'Programación de periodos', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.101', agenteUsuario: 'Firefox on macOS' },
            { userId: 'user3', year: 2024, siglas: 'ASPNA', claveUsuario: 'carlos_l', fechaAcceso: '2024-07-22', horaInicio: '11:00:00', horaCierre: '11:01:00', duracionSesion: 1, moduloAccedido: 'Login', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Error', resultado: 'Fallo (Contraseña incorrecta)', direccionIP: '192.168.1.102', agenteUsuario: 'Edge on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-23', horaInicio: '08:00:00', horaCierre: '08:45:00', duracionSesion: 45, moduloAccedido: 'Control de Usuarios', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-23', horaInicio: '08:45:00', horaCierre: '08:50:00', duracionSesion: 5, moduloAccedido: 'Control de Usuarios', accionRealizada: 'Modificación', campoModificado: 'Usuario U001', tipoEvento: 'Cierre', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user4', year: 2024, siglas: 'ASPNCO', claveUsuario: 'ana_d', fechaAcceso: '2024-07-24', horaInicio: '14:00:00', horaCierre: '14:10:00', duracionSesion: 10, moduloAccedido: 'Reporte de Avance Institucional', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.103', agenteUsuario: 'Safari on iOS' },
        ];

        // Listas de opciones para los campos de usuario.
        const defaultPerfiles = ["Coordinador de Control Interno", "Instancia de Control Interno", "Riesgos"];
        const defaultTiposUsuario = ["Interno", "Externo"];
        const defaultCargos = ["Director General", "Director de Área", "Subdirector", "Jefe de Departamento", "Analista", "Consultor"];
        const defaultAccionesRealizadas = ["Ninguna", "Modificación", "Eliminación", "Agregación"];
        const defaultTiposEvento = ["Inicio", "Cierre", "Error"];


        // Carga de datos desde localStorage o uso de datos iniciales.
        // En un entorno de producción, estas variables se inicializarían con datos obtenidos de una base de datos
        // a través de llamadas a una API.
        let institutions = JSON.parse(localStorage.getItem('institutions_v11_1_1')) || initialInstitutionsData;
        let tipoInstitucionList = JSON.parse(localStorage.getItem('tipoInstitucionList_v11_1_1')) || defaultTipoInstitucion;
        let sectorList = JSON.parse(localStorage.getItem('sectorList_v11_1_1')) || defaultSector;
        let programmedPeriods = JSON.parse(localStorage.getItem('programmedPeriods_v11_1_1')) || [];
        let programmedPeriodsHistory = JSON.parse(localStorage.getItem('programmedPeriodsHistory_v11_1_1')) || {};

        let users = JSON.parse(localStorage.getItem('users_v11_1_1')) || initialUsersData;
        let userAccessLogs = JSON.parse(localStorage.getItem('userAccessLogs_v11_1_1')) || initialUserAccessLogs;

        // Variables de estado temporales para la UI.
        let selectedInstitutionsForProgramacion = [];
        let currentEditingListType = '';

        // --- INICIALIZACIÓN Y NAVEGACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicialmente muestra la página de login.
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');

            setupEventListeners();
            populateActionFilters();
            populateAperturarModalActions();
            populateModalSelects();
            populateUserModalSelects();

            // Asegura que el primer módulo de la barra lateral esté expandido por defecto.
            const firstModuleHeader = document.querySelector('.sidebar .module-header');
            if (firstModuleHeader && firstModuleHeader.classList.contains('collapsed')) {
                firstModuleHeader.classList.remove('collapsed');
                const firstSubmoduleList = firstModuleHeader.nextElementSibling;
                if (firstSubmoduleList && firstSubmoduleList.classList.contains('submodule-list')) {
                    firstSubmoduleList.classList.remove('hidden');
                }
            }
        });

        /**
         * Función para manejar el acceso al sistema (login).
         * Valida las credenciales y redirige o muestra un error.
         */
        function accessSystem() {
            const usernameInput = document.getElementById('username-login').value;
            const passwordInput = document.getElementById('password-login').value;

            // Busca el usuario en la lista de usuarios.
            const authenticatedUser = users.find(u => u.clave === usernameInput && u.password === passwordInput);

            if (authenticatedUser) {
                // Si las credenciales son correctas, oculta la página de login y muestra la aplicación principal.
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                // Registra el login exitoso.
                logUserAccess(authenticatedUser.id, authenticatedUser.siglasInstitucion, authenticatedUser.clave, 'Login', 'Ninguna', 'N/A', 'Inicio', 'Éxito');
                // Activa el módulo de "Consulta Instituciones" por defecto.
                const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
                showModule('consulta-instituciones', consultaInstitucionesLink);
            } else {
                // Si las credenciales son incorrectas, muestra una alerta y registra el intento fallido.
                alert('Usuario o contraseña incorrectos.');
                logUserAccess('N/A', 'N/A', usernameInput, 'Login', 'Ninguna', 'N/A', 'Error', 'Fallo (Contraseña incorrecta)');
            }
        }

        /**
         * Función para cerrar sesión y volver a la pantalla de login.
         * @param {Event} event - El evento del click.
         */
        function logout(event) {
            event.preventDefault();
            // En una aplicación real, aquí se borrarían los tokens de sesión y la información de usuario del lado del cliente.
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            // Registra el cierre de sesión.
            const currentUser = users.find(u => u.clave === document.getElementById('username-login').value);
            if (currentUser) {
                logUserAccess(currentUser.id, currentUser.siglasInstitucion, currentUser.clave, 'Login', 'Ninguna', 'N/A', 'Cierre', 'Éxito');
            }
        }

        /**
         * Función para navegar a la pantalla de inicio (Consulta Instituciones).
         * @param {Event} event - El evento del click.
         */
        function goHome(event) {
            event.preventDefault();
            const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
            showModule('consulta-instituciones', consultaInstitucionesLink);
        }

        /**
         * Abre el modal de información.
         */
        function openInfoModal() {
            document.getElementById('info-modal').classList.remove('hidden');
        }

        /**
         * Cierra el modal de información.
         */
        function closeInfoModal() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        /**
         * Muestra el contenido de un módulo específico y actualiza el estado de la barra lateral.
         * @param {string} moduleId - El ID del módulo a mostrar (ej. 'consulta-instituciones').
         * @param {HTMLElement} clickedElement - El elemento de la barra lateral que fue clickeado.
         */
        function showModule(moduleId, clickedElement) {
            // Oculta todos los contenidos de módulos.
            document.querySelectorAll('.module-content').forEach(module => module.classList.add('hidden'));
            const targetModule = document.getElementById('module-' + moduleId);
            if (targetModule) {
                // Muestra el módulo objetivo.
                targetModule.classList.remove('hidden');
                // Realiza acciones específicas al cargar ciertos módulos.
                if (moduleId === 'catalogo-instituciones') {
                    renderInstitutionsTable();
                    populateModalSelects();
                } else if (moduleId === 'programacion-periodos') {
                    selectedInstitutionsForProgramacion = []; // Limpia la selección al entrar al módulo.
                    renderProgramacionPeriodosTable();
                } else if (moduleId === 'reporte-avance-institucional') {
                    renderReporteAvanceInstitucionalTable();
                } else if (moduleId === 'control-usuarios') {
                    renderUsersTable(); // Renderiza la tabla de usuarios al entrar al módulo.
                }
            }
            // Elimina la clase 'active-item' de todos los elementos de la barra lateral.
            document.querySelectorAll('.sidebar .submodule-list li').forEach(li => li.classList.remove('active-item'));
            // Si se hizo clic en un elemento, agrega la clase 'active-item' a su padre <li>.
            if (clickedElement) {
                const parentLi = clickedElement.closest('li');
                if (parentLi) parentLi.classList.add('active-item');

                // Asegura que el módulo padre esté expandido.
                let parentUl = clickedElement.closest('.submodule-list');
                if (parentUl && parentUl.classList.contains('hidden')) {
                    parentUl.classList.remove('hidden');
                    let header = parentUl.previousElementSibling;
                    if (header && header.classList.contains('module-header')) {
                        header.classList.remove('collapsed');
                    }
                }
            }
        }

        /**
         * Alterna la visibilidad de los submódulos en la barra lateral.
         * @param {HTMLElement} headerElement - El encabezado del módulo clickeado.
         */
        function toggleSubmodules(headerElement) {
            headerElement.nextElementSibling.classList.toggle('hidden');
            headerElement.classList.toggle('collapsed');
        }

        /**
         * Configura los event listeners para los campos de filtro de institución.
         */
        function setupEventListeners() {
            const consultaInput = document.getElementById('consulta-institucion-filter');
            if(consultaInput) {
                // Pasa el ID completo del elemento de sugerencias para evitar TypeError.
                consultaInput.addEventListener('input', () => handleInstitutionFilter(consultaInput.value, 'consulta-institucion', institutions));
                consultaInput.addEventListener('click', () => handleInstitutionFilter('', 'consulta-institucion', institutions, true));
            }

            const programacionInput = document.getElementById('programacion-institucion-filter');
            if(programacionInput) {
                // Pasa el ID completo del elemento de sugerencias para evitar TypeError.
                programacionInput.addEventListener('input', () => handleInstitutionFilter(programacionInput.value, 'programacion-institucion', institutions));
                programacionInput.addEventListener('click', () => handleInstitutionFilter('', 'programacion-institucion', institutions, true));
            }

            const userModalInstitutionFilter = document.getElementById('user-siglas-institucion-filter');
            if (userModalInstitutionFilter) {
                // Pasa el ID completo del elemento de sugerencias para evitar TypeError.
                userModalInstitutionFilter.addEventListener('input', () => handleInstitutionFilter(userModalInstitutionFilter.value, 'user-siglas-institucion', institutions));
                userModalInstitutionFilter.addEventListener('click', () => handleInstitutionFilter('', 'user-siglas-institucion', institutions, true));
            }

            const institutionForm = document.getElementById('institution-form');
            if (institutionForm) {
                institutionForm.addEventListener('submit', handleInstitutionFormSubmit);
            }

            const userForm = document.getElementById('user-form');
            if (userForm) {
                userForm.addEventListener('submit', handleUserFormSubmit);
            }

            // Cierra las sugerencias de institución al hacer clic fuera.
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.institution-filter-container')) {
                    document.querySelectorAll('.institution-suggestions').forEach(el => el.classList.add('hidden'));
                }
            });
        }

        /**
         * Maneja el filtrado de instituciones y muestra sugerencias.
         * @param {string} filterValue - El texto de búsqueda.
         * @param {string} contextPrefix - El prefijo del ID del elemento (ej. 'consulta-institucion').
         * @param {Array<Object>} data - La lista de instituciones a filtrar.
         * @param {boolean} showAll - Si se deben mostrar todas las sugerencias al hacer clic.
         */
        function handleInstitutionFilter(filterValue, contextPrefix, data, showAll = false) {
            const suggestionsContainer = document.getElementById(`${contextPrefix}-suggestions`);
            if (!suggestionsContainer) {
                console.error(`Error: Elemento con ID ${contextPrefix}-suggestions no encontrado.`);
                return;
            }
            suggestionsContainer.innerHTML = '';
            const lowerCaseFilter = filterValue.toLowerCase();

            const filtered = data.filter(inst =>
                lowerCaseFilter === '' ||
                inst.nombre.toLowerCase().includes(lowerCaseFilter) ||
                inst.siglas.toLowerCase().includes(lowerCaseFilter)
            );

            if (filtered.length > 0 && (lowerCaseFilter.length > 0 || showAll)) {
                suggestionsContainer.classList.remove('hidden');
                filtered.forEach(inst => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = `${inst.siglas} - ${inst.nombre}`;
                    // Usa onmousedown para evitar que el blur del input oculte las sugerencias antes del click.
                    suggestionItem.onmousedown = () => selectInstitution(inst, contextPrefix);
                    suggestionsContainer.appendChild(suggestionItem);
                });
            } else {
                suggestionsContainer.classList.add('hidden');
            }

            // Si el contexto es para programación de periodos, re-renderiza la tabla.
            if (contextPrefix === 'programacion-institucion') renderProgramacionPeriodosTable();
        }

        /**
         * Selecciona una institución de las sugerencias y actualiza el campo de entrada.
         * @param {Object} inst - El objeto de la institución seleccionada.
         * @param {string} contextPrefix - El prefijo del ID del elemento.
         */
        function selectInstitution(inst, contextPrefix) {
            document.getElementById(`${contextPrefix}-filter`).value = `${inst.siglas} - ${inst.nombre}`;
            // Si existe un input hidden para el ID, actualízalo.
            const hiddenIdInput = document.getElementById(`${contextPrefix}-id`);
            if(hiddenIdInput) {
                hiddenIdInput.value = inst.id;
            }
            // Oculta las sugerencias.
            document.getElementById(`${contextPrefix}-suggestions`).classList.add('hidden');

            // Lógica específica para la selección de institución en el modal de usuario.
            if (contextPrefix === 'user-siglas-institucion') {
                document.getElementById('user-siglas-institucion-id').value = inst.siglas; // Almacena las siglas.
            }

            // Si el contexto es para programación de periodos, re-renderiza la tabla.
            if (contextPrefix === 'programacion-institucion') renderProgramacionPeriodosTable();
        }

        /**
         * Limpia el filtro de institución en el módulo de Programación de Periodos.
         */
        function clearInstitutionFilter() {
            const input = document.getElementById('programacion-institucion-filter');
            input.value = '';
            renderProgramacionPeriodosTable();
        }

        // --- MÓDULO: CATÁLOGO DE INSTITUCIONES ---
        /**
         * Renderiza la tabla de instituciones.
         */
        function renderInstitutionsTable() {
            const tableBody = document.querySelector('#institutions-catalog-table tbody');
            tableBody.innerHTML = '';

            if (institutions.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.classList.add('ui-datatable-empty-message');
                noDataRow.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-3">No se encontraron instituciones.</td>`;
                tableBody.appendChild(noDataRow);
                return;
            }

            institutions.forEach(inst => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td>${inst.tipo}</td>
                    <td>${inst.sector}</td>
                    <td>${inst.estatus}</td>
                    <td class="flex gap-1 justify-center">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="editInstitution('${inst.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="M15 5l4 4"/>
                            </svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="deleteInstitution('${inst.id}')" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Popula los selects de tipo de institución y sector en el modal de institución.
         */
        function populateModalSelects() {
            const tipoSelect = document.getElementById('modal-tipo-institucion');
            const sectorSelect = document.getElementById('modal-sector');

            tipoSelect.innerHTML = '<option value="">Seleccione</option>';
            tipoInstitucionList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                tipoSelect.appendChild(option);
            });
            sectorSelect.innerHTML = '<option value="">Seleccione</option>';
            sectorList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                sectorSelect.appendChild(option);
            });
        }

        /**
         * Abre el modal para agregar o editar una institución.
         * @param {string} [institutionId=null] - El ID de la institución a editar. Si es null, se abre para agregar.
         */
        function openInstitutionModal(institutionId = null) {
            const modalOverlay = document.getElementById('institution-modal-overlay');
            const modalTitle = document.getElementById('institution-modal-title');
            const form = document.getElementById('institution-form');
            form.reset(); // Limpia el formulario.

            document.getElementById('institution-id-edit').value = '';
            populateModalSelects(); // Vuelve a poblar los selects para asegurar que estén actualizados.

            if (institutionId) {
                modalTitle.textContent = 'Editar Institución';
                const institutionToEdit = institutions.find(inst => inst.id === institutionId);
                if (institutionToEdit) {
                    document.getElementById('institution-id-edit').value = institutionToEdit.id;
                    document.getElementById('modal-tipo-institucion').value = institutionToEdit.tipo;
                    document.getElementById('modal-sector').value = institutionToEdit.sector;
                    document.getElementById('modal-siglas').value = institutionToEdit.siglas;
                    document.getElementById('modal-institucion-nombre').value = institutionToEdit.nombre;
                    document.querySelector(`input[name="modal-estatus"][value="${institutionToEdit.estatus}"]`).checked = true;
                }
            } else {
                modalTitle.textContent = 'Agregar Institución';
                document.querySelector('input[name="modal-estatus"][value="Activa"]').checked = true; // Por defecto, activa.
            }
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de institución.
         */
        function closeInstitutionModal() {
            document.getElementById('institution-modal-overlay').classList.add('hidden');
        }

        /**
         * Maneja el envío del formulario de institución (agregar/editar).
         * @param {Event} event - El evento del submit.
         */
        function handleInstitutionFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('institution-id-edit').value;
            const tipo = document.getElementById('modal-tipo-institucion').value;
            const sector = document.getElementById('modal-sector').value;
            const siglas = document.getElementById('modal-siglas').value;
            const nombre = document.getElementById('modal-institucion-nombre').value;
            const estatus = document.querySelector('input[name="modal-estatus"]:checked').value;

            if (id) {
                // Edita una institución existente.
                const index = institutions.findIndex(inst => inst.id === id);
                if (index !== -1) {
                    institutions[index] = { ...institutions[index], tipo, sector, siglas, nombre, estatus };
                }
            } else {
                // Agrega una nueva institución.
                const newId = Date.now().toString(); // Genera un ID único.
                institutions.push({ id: newId, tipo, sector, siglas, nombre, estatus, ptciActualizado: 'No' });
            }

            // Guarda los cambios en localStorage. En producción, se enviaría a la base de datos.
            localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
            renderInstitutionsTable(); // Actualiza la tabla.
            closeInstitutionModal();
        }

        /**
         * Edita una institución existente.
         * @param {string} id - El ID de la institución a editar.
         */
        function editInstitution(id) {
            openInstitutionModal(id);
        }

        /**
         * Elimina una institución.
         * @param {string} id - El ID de la institución a eliminar.
         */
        function deleteInstitution(id) {
            if (confirm('¿Está seguro de que desea eliminar esta institución?')) {
                institutions = institutions.filter(inst => inst.id !== id);
                // Guarda los cambios en localStorage. En producción, se enviaría a la base de datos.
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                renderInstitutionsTable(); // Actualiza la tabla.
            }
        }

        /**
         * Abre el modal para editar las listas de tipo de institución o sector.
         * @param {string} listType - El tipo de lista a editar ('tipoInstitucion' o 'sector').
         */
        function openEditListModal(listType) {
            currentEditingListType = listType;
            const modalOverlay = document.getElementById('edit-list-modal-overlay');
            const modalTitle = document.getElementById('edit-list-modal-title');
            const listContainer = document.getElementById('edit-list-container');
            listContainer.innerHTML = '';

            const listToEdit = listType === 'tipoInstitucion' ? tipoInstitucionList : sectorList;
            modalTitle.textContent = `Editar Lista de ${listType === 'tipoInstitucion' ? 'Tipo de Institución' : 'Sector'}`;
            listToEdit.forEach((item, index) => {
                const listItemDiv = document.createElement('div');
                listItemDiv.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'border-b', 'last:border-b-0');
                listItemDiv.innerHTML = `
                    <span class="text-sm text-gray-700">${item}</span>
                    <div class="flex gap-1">
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-md text-xs" onclick="openEditSingleListItemModal('${listType}', ${index}, '${item}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="removeListItem('${listType}', ${index})" title="Borrar ${listType === 'tipoInstitucion' ? 'Tipo de Institución' : 'Sector'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>`;
                listContainer.appendChild(listItemDiv);
            });
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de edición de listas.
         */
        function closeEditListModal() {
            document.getElementById('edit-list-modal-overlay').classList.add('hidden');
            populateModalSelects(); // Vuelve a poblar los selects después de editar las listas.
        }

        /**
         * Abre el modal para editar un solo elemento de una lista.
         * @param {string} listType - El tipo de lista.
         * @param {number} index - El índice del elemento a editar.
         * @param {string} value - El valor actual del elemento.
         */
        function openEditSingleListItemModal(listType, index, value) {
            document.getElementById('edit-single-list-item-modal-overlay').classList.remove('hidden');
            document.getElementById('edit-single-list-item-index').value = index;
            document.getElementById('edit-single-list-item-type').value = listType;
            document.getElementById('edit-single-list-item-input').value = value;
            document.getElementById('edit-single-list-item-input').focus();
            document.getElementById('edit-list-modal-overlay').classList.add('hidden'); // Oculta el modal de lista mientras se edita un solo elemento.
        }

        /**
         * Cierra el modal de edición de un solo elemento de lista.
         */
        function closeEditSingleListItemModal() {
            document.getElementById('edit-single-list-item-modal-overlay').classList.add('hidden');
            openEditListModal(document.getElementById('edit-single-list-item-type').value); // Vuelve a abrir el modal de lista.
        }

        /**
         * Guarda el elemento de lista editado.
         */
        function saveEditedListItem() {
            const index = document.getElementById('edit-single-list-item-index').value;
            const listType = document.getElementById('edit-single-list-item-type').value;
            const newValue = document.getElementById('edit-single-list-item-input').value.trim();
            if (!newValue) { alert('El nuevo valor no puede estar vacío.'); return; }

            let oldItem;
            if (listType === 'tipoInstitucion') {
                oldItem = tipoInstitucionList[index];
                if (tipoInstitucionList.includes(newValue) && newValue !== oldItem) { alert('Este tipo de institución ya existe.'); return; }
                tipoInstitucionList[index] = newValue;
                // En producción: se enviaría una solicitud de actualización a la base de datos.
                localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                // Actualiza las instituciones que usaban el valor antiguo.
                institutions.forEach(inst => { if (inst.tipo === oldItem) inst.tipo = newValue; });
            } else if (listType === 'sector') {
                oldItem = sectorList[index];
                if (sectorList.includes(newValue) && newValue !== oldItem) { alert('Este sector ya existe.'); return; }
                sectorList[index] = newValue;
                // En producción: se enviaría una solicitud de actualización a la base de datos.
                localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                // Actualiza las instituciones que usaban el valor antiguo.
                institutions.forEach(inst => { if (inst.sector === oldItem) inst.sector = newValue; });
            }
            // En producción: se enviaría una solicitud de actualización masiva o individual a la base de datos para las instituciones.
            localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
            closeEditSingleListItemModal();
            renderInstitutionsTable(); // Vuelve a renderizar la tabla de instituciones para reflejar los cambios.
        }

        /**
         * Agrega un nuevo elemento a una lista de opciones.
         */
        function addListItem() {
            const input = document.getElementById('new-list-item-input');
            const newItem = input.value.trim();
            if (newItem) {
                if (currentEditingListType === 'tipoInstitucion') {
                    if (tipoInstitucionList.includes(newItem)) { alert('Este tipo de institución ya existe.'); return; }
                    tipoInstitucionList.push(newItem);
                    // En producción: se enviaría una solicitud de adición a la base de datos.
                    localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                } else if (currentEditingListType === 'sector') {
                    if (sectorList.includes(newItem)) { alert('Este sector ya existe.'); return; }
                    sectorList.push(newItem);
                    // En producción: se enviaría una solicitud de adición a la base de datos.
                    localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                }
                input.value = '';
                openEditListModal(currentEditingListType); // Recarga la lista en el modal.
            }
        }

        /**
         * Elimina un elemento de una lista de opciones.
         * @param {string} listType - El tipo de lista.
         * @param {number} indexToRemove - El índice del elemento a eliminar.
         */
        function removeListItem(listType, indexToRemove) {
            if (confirm('¿Está seguro de que desea eliminar este elemento? Las instituciones que lo usen quedarán sin un valor asignado.')) {
                let itemToRemove;
                if (listType === 'tipoInstitucion') {
                    itemToRemove = tipoInstitucionList[indexToRemove];
                    tipoInstitucionList.splice(indexToRemove, 1);
                    // En producción: se enviaría una solicitud de eliminación a la base de datos.
                    localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                    // Elimina el tipo de institución de las instituciones que lo usaban.
                    institutions.forEach(inst => { if (inst.tipo === itemToRemove) inst.tipo = ''; });
                } else if (listType === 'sector') {
                    itemToRemove = sectorList[indexToRemove];
                    sectorList.splice(indexToRemove, 1);
                    // En producción: se enviaría una solicitud de eliminación a la base de datos.
                    localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                    // Elimina el sector de las instituciones que lo usaban.
                    institutions.forEach(inst => { if (inst.sector === itemToRemove) inst.sector = ''; });
                }
                // En producción: se enviaría una solicitud de actualización masiva o individual a la base de datos para las instituciones.
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                openEditListModal(listType); // Recarga la lista en el modal.
                renderInstitutionsTable(); // Vuelve a renderizar la tabla de instituciones para reflejar los cambios.
            }
        }


        // --- MÓDULO: PROGRAMACIÓN DE PERIODOS ---
        /**
         * Renderiza la tabla de programación de periodos.
         */
        function renderProgramacionPeriodosTable() {
            const tableBody = document.querySelector('#programacion-periodos-table tbody');
            tableBody.innerHTML = '';

            const institucionFilterText = document.getElementById('programacion-institucion-filter').value.toLowerCase();
            const ptciFilter = document.getElementById('ptci-actualizado-filter').value;
            const tipoAperturaFilter = document.getElementById('tipo-accion-filter').value;

            let institutionsToDisplay = institutions.filter(inst => {
                const instName = inst.nombre.toLowerCase();
                const instSiglas = inst.siglas.toLowerCase();
                // Filtra por siglas o nombre de la institución.
                const matchesInstitucion = institucionFilterText === '' || instName.includes(institucionFilterText) || instSiglas.includes(institucionFilterText);
                const matchesPtci = ptciFilter === 'todos' || inst.ptciActualizado === ptciFilter;

                const programmedPeriod = programmedPeriods.find(pp => pp.institucionId === inst.id);
                const hasMatchingProgrammedPeriod = tipoAperturaFilter === 'todos' || (programmedPeriod && programmedPeriod.accionesPermitidas.includes(tipoAperturaFilter));

                return matchesInstitucion && matchesPtci && (tipoAperturaFilter === 'todos' ? true : hasMatchingProgrammedPeriod);
            });

            if (institutionsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-3">No se encontraron resultados.</td></tr>`;
                updateUiPostSelection();
                return;
            }

            institutionsToDisplay.forEach(inst => {
                const programmedPeriod = programmedPeriods.find(p => p.institucionId === inst.id) || {};
                const isSelected = selectedInstitutionsForProgramacion.some(sInst => sInst.id === inst.id);
                const row = tableBody.insertRow();
                row.classList.toggle('selected', isSelected);
                row.dataset.institutionId = inst.id;
                // Permite seleccionar la fila haciendo clic en cualquier parte excepto en el checkbox o botones.
                row.onclick = (event) => {
                    if (event.target.type !== 'checkbox' && event.target.tagName !== 'BUTTON' && event.target.tagName !== 'SVG' && event.target.tagName !== 'PATH') {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleInstitutionSelection(checkbox, inst.id);
                    }
                };
                row.innerHTML = `
                    <td><input type="checkbox" data-institution-id="${inst.id}" onchange="toggleInstitutionSelection(this, '${inst.id}')" ${isSelected ? 'checked' : ''}></td>
                    <td>${programmedPeriod.periodo || 'N/A'}</td>
                    <td>${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td>${inst.ptciActualizado}</td>
                    <td>${programmedPeriod.trimestre || 'N/A'}</td>
                    <td>${(programmedPeriod.accionesPermitidas || []).join(', ') || 'N/A'}</td>
                    <td>${programmedPeriod.fechaInicio || 'N/A'}</td>
                    <td>${programmedPeriod.fechaFin || 'N/A'}</td>
                `;
            });
            updateUiPostSelection();
        }

        /**
         * Selecciona o deselecciona todas las instituciones visibles en la tabla de programación.
         * @param {boolean} isChecked - Si el checkbox maestro está marcado.
         */
        function toggleAllInstitutions(isChecked) {
            const checkboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                toggleInstitutionSelection(checkbox, checkbox.dataset.institutionId);
            });
        }

        /**
         * Alterna la selección de una institución individual.
         * @param {HTMLElement} checkbox - El checkbox de la fila.
         * @param {string} institutionId - El ID de la institución.
         */
        function toggleInstitutionSelection(checkbox, institutionId) {
            const institution = institutions.find(inst => inst.id === institutionId);
            if (!institution) return;
            if (checkbox.checked) {
                if (!selectedInstitutionsForProgramacion.some(inst => inst.id === institutionId)) {
                    selectedInstitutionsForProgramacion.push(institution);
                }
            } else {
                selectedInstitutionsForProgramacion = selectedInstitutionsForProgramacion.filter(inst => inst.id !== institutionId);
            }
            checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
            updateUiPostSelection();
        }

        /**
         * Actualiza el estado del checkbox "seleccionar todo" y la visibilidad del botón de historial.
         */
        function updateUiPostSelection() {
            const allCheckboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('select-all-institutions');
            if (allCheckboxes.length > 0) {
                const allVisibleChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allVisibleChecked;
                selectAllCheckbox.indeterminate = !allVisibleChecked && Array.from(allCheckboxes).some(cb => cb.checked);
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            // Muestra el botón de historial solo si hay exactamente una institución seleccionada.
            document.getElementById('history-button').style.display = selectedInstitutionsForProgramacion.length === 1 ? 'inline-flex' : 'none';
        }

        // --- MODALES Y LÓGICA DE DATOS ---
        /**
         * Popula los filtros de acción en el módulo de programación de periodos y el modal de historial.
         */
        function populateActionFilters() {
            const mainFilter = document.getElementById('tipo-accion-filter');
            const historyFilter = document.getElementById('history-action-filter');
            mainFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
            historyFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
            for (const category in availableActionsCategories) {
                const mainOptgroup = document.createElement('optgroup');
                mainOptgroup.label = category;
                const historyOptgroup = document.createElement('optgroup');
                historyOptgroup.label = category;
                availableActionsCategories[category].forEach(action => {
                    const mainOption = new Option(action, action);
                    const historyOption = new Option(action, action);
                    mainOptgroup.appendChild(mainOption);
                    historyOptgroup.appendChild(historyOption);
                });
                mainFilter.appendChild(mainOptgroup);
                historyFilter.appendChild(historyOptgroup);
            }
        }

        /**
         * Popula el formulario del modal "Aperturar Sistema" con opciones de periodo y acciones.
         */
        function populateAperturarModalActions() {
            const form = document.getElementById('aperturar-form');
            form.innerHTML = '';

            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];

            const periodosHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-field-group">
                        <label for="aperturar-periodo">Periodo</label>
                        <div class="select-wrapper">
                            <select id="aperturar-periodo" required onchange="updateDatesByPeriodAndTrimestre()">
                                ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-trimestre">Trimestre</label>
                        <div class="select-wrapper">
                            <select id="aperturar-trimestre" onchange="updateDatesByPeriodAndTrimestre()">
                                <option value="1T">1er Trimestre</option>
                                <option value="2T">2do Trimestre</option>
                                <option value="3T">3er Trimestre</option>
                                <option value="4T">4to Trimestre</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-inicio">Fecha Inicio</label>
                        <input type="date" id="aperturar-fecha-inicio" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-fin">Fecha Fin</label>
                        <input type="date" id="aperturar-fecha-fin" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                </div>
                <h4 class="text-md font-bold text-gray-700 mt-4 mb-2">Acciones a Habilitar</h4>`;
            form.insertAdjacentHTML('beforeend', periodosHTML);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            form.appendChild(actionsContainer);
            for (const category in availableActionsCategories) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                let checkboxesHTML = `<h5>${category}</h5>`;
                availableActionsCategories[category].forEach(action => {
                    checkboxesHTML += `<label class="flex items-center text-xs py-1"><input type="checkbox" name="accion-permitida" value="${action}" class="mr-2">${action}</label>`;
                });
                gridItem.innerHTML = checkboxesHTML;
                actionsContainer.appendChild(gridItem);
            }

            const buttonsHTML = `<div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAperturarModal()">Cancelar</button><button type="submit" class="btn-save">Aperturar</button></div>`;
            form.insertAdjacentHTML('beforeend', buttonsHTML);

            form.addEventListener('submit', handleAperturarSubmit);
        }

        /**
         * Maneja el envío del formulario "Aperturar Sistema".
         * @param {Event} event - El evento del submit.
         */
        function handleAperturarSubmit(event) {
            event.preventDefault();
            const periodo = document.getElementById('aperturar-periodo').value;
            const trimestre = document.getElementById('aperturar-trimestre').value;
            const fechaInicio = document.getElementById('aperturar-fecha-inicio').value;
            const fechaFin = document.getElementById('aperturar-fecha-fin').value;
            const accionesPermitidas = Array.from(document.querySelectorAll('input[name="accion-permitida"]:checked')).map(cb => cb.value);

            if (accionesPermitidas.length === 0) {
                alert('Debe seleccionar al menos una acción para habilitar.');
                return;
            }
             if (!fechaInicio || !fechaFin) {
                alert('Debe seleccionar una fecha de inicio y fin.');
                return;
            }

            selectedInstitutionsForProgramacion.forEach(inst => {
                const newAction = {
                    periodo, trimestre, fechaInicio, fechaFin,
                    accionesPermitidas,
                    usuario: 'admin_user', // Usuario por defecto para el log.
                    timestamp: new Date().toISOString()
                };

                const existingIndex = programmedPeriods.findIndex(p => p.institucionId === inst.id);
                if (existingIndex !== -1) {
                    programmedPeriods[existingIndex] = { institucionId: inst.id, ...newAction };
                } else {
                    programmedPeriods.push({ institucionId: inst.id, ...newAction });
                }

                if (!programmedPeriodsHistory[inst.id]) programmedPeriodsHistory[inst.id] = [];
                programmedPeriodsHistory[inst.id].push(newAction);
            });
            // Guarda los cambios en localStorage. En producción, se enviaría a la base de datos.
            localStorage.setItem('programmedPeriods_v11_1_1', JSON.stringify(programmedPeriods));
            localStorage.setItem('programmedPeriodsHistory_v11_1_1', JSON.stringify(programmedPeriodsHistory));

            closeAperturarModal();
            renderProgramacionPeriodosTable();
            alert('Sistema aperturado/actualizado correctamente.');
        }

        /**
         * Abre el modal "Aperturar Sistema".
         */
        function openAperturarModal() {
            if (selectedInstitutionsForProgramacion.length === 0) {
                alert('Por favor, selecciona al menos una institución.');
                return;
            }
            // Resetea los checkboxes de acción al recargar el modal.
            document.querySelectorAll('input[name="accion-permitida"]').forEach(cb => cb.checked = false);
            // Actualiza las fechas al abrir el modal.
            updateDatesByPeriodAndTrimestre();

            const display = document.getElementById('selected-institutions-display');
            display.textContent = `Instituciones seleccionadas: ${selectedInstitutionsForProgramacion.map(i => i.siglas).join(', ')}`;
            display.classList.remove('hidden');
            document.getElementById('aperturar-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal "Aperturar Sistema".
         */
        function closeAperturarModal() { document.getElementById('aperturar-modal-overlay').classList.add('hidden'); }

        /**
         * Calcula y establece automáticamente las fechas de inicio y fin basándose en el periodo y trimestre seleccionados.
         */
        function updateDatesByPeriodAndTrimestre() {
            const year = parseInt(document.getElementById('aperturar-periodo').value);
            const trimestre = document.getElementById('aperturar-trimestre').value;
            const fechaInicioInput = document.getElementById('aperturar-fecha-inicio');
            const fechaFinInput = document.getElementById('aperturar-fecha-fin');

            if (!year || !trimestre) return;

            let lastDayOfQuarter;
            switch (trimestre) {
                case '1T': // Enero-Marzo
                    lastDayOfQuarter = new Date(year, 2, 31); // 31 de marzo
                    break;
                case '2T': // Abril-Junio
                    lastDayOfQuarter = new Date(year, 5, 30); // 30 de junio
                    break;
                case '3T': // Julio-Septiembre
                    lastDayOfQuarter = new Date(year, 8, 30); // 30 de septiembre
                    break;
                case '4T': // Octubre-Diciembre
                    lastDayOfQuarter = new Date(year, 11, 31); // 31 de diciembre
                    break;
                default:
                    return;
            }

            // Fecha Inicio = último día del trimestre + 1 mes
            let startDate = new Date(lastDayOfQuarter);
            startDate.setMonth(startDate.getMonth() + 1);
            startDate.setDate(1); // Establecer al primer día del mes siguiente

            fechaInicioInput.value = startDate.toISOString().split('T')[0];

            // Fecha Fin = Fecha Inicio + 15 días (saltar fines de semana)
            let endDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < 15) {
                endDate.setDate(endDate.getDate() + 1);
                // Si es sábado (6) o domingo (0), no contar el día
                if (endDate.getDay() !== 0 && endDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            fechaFinInput.value = endDate.toISOString().split('T')[0];
        }

        /**
         * Abre el modal de historial para una institución seleccionada.
         */
        function openHistoryModal() {
            if (selectedInstitutionsForProgramacion.length !== 1) return; // Solo si hay una institución seleccionada.
            const inst = selectedInstitutionsForProgramacion[0];
            document.getElementById('history-institution-name').textContent = `${inst.siglas} - ${inst.nombre}`;
            document.getElementById('history-action-filter').value = 'todos'; // Filtro por defecto.
            renderHistoryTable(); // Renderiza la tabla de historial.
            document.getElementById('history-modal-overlay').classList.remove('hidden');
        }

        /**
         * Renderiza la tabla de historial de programación de periodos.
         */
        function renderHistoryTable() {
            const inst = selectedInstitutionsForProgramacion[0];
            if (!inst) return;

            const historyTableBody = document.getElementById('history-table-body');
            historyTableBody.innerHTML = '';
            const actionFilter = document.getElementById('history-action-filter').value;
            const historyForInst = (programmedPeriodsHistory[inst.id] || []).filter(entry =>
                actionFilter === 'todos' || entry.accionesPermitidas.includes(actionFilter)
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Ordena por fecha descendente.
            if (historyForInst.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-3">No hay historial para el filtro seleccionado.</td></tr>`;
                return;
            }

            historyForInst.forEach(entry => {
                const row = historyTableBody.insertRow();
                row.innerHTML = `
                    <td>${entry.periodo}</td>
                    <td>${entry.trimestre}</td>
                    <td>${entry.accionesPermitidas.join(', ')}</td>
                    <td>${entry.fechaInicio}</td>
                    <td>${entry.fechaFin}</td>
                    <td>${entry.usuario}</td>
                `;
            });
        }

        /**
         * Cierra el modal de historial.
         */
        function closeHistoryModal() { document.getElementById('history-modal-overlay').classList.add('hidden'); }

        // --- MÓDULO: REPORTE DE AVANCE INSTITUCIONAL ---
        /**
         * Renderiza la tabla del reporte de avance institucional.
         */
        function renderReporteAvanceInstitucionalTable() {
            const table = document.querySelector('#module-reporte-avance-institucional .data-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            // Limpiar encabezados y cuerpo existentes.
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Obtener valores de los filtros.
            const estatusFilter = document.querySelector('input[name="estatus_reporte"]:checked').value; // '1' o '0'.
            const anioFilter = document.getElementById('anio_input').value; // 'todos' o año.

            // Preparar todas las acciones únicas para los encabezados.
            const allAvailableActions = [];
            for (const category in availableActionsCategories) {
                availableActionsCategories[category].forEach(action => {
                    allAvailableActions.push(action);
                });
            }

            // Crear fila de encabezado.
            let headerRow = '<tr>';
            headerRow += '<th>Periodo</th>';
            headerRow += '<th>Siglas</th>';
            headerRow += '<th>Institución</th>';
            headerRow += '<th>Actualizó PTCI</th>';

            allAvailableActions.forEach(action => {
                headerRow += `<th>${action}</th>`;
            });
            headerRow += '</tr>';
            thead.innerHTML = headerRow;

            // Filtrar instituciones según el estado.
            const filteredInstitutions = institutions.filter(inst => {
                const isActive = inst.estatus === 'Activa';
                return (estatusFilter === '1' && isActive) || (estatusFilter === '0' && !isActive);
            });

            if (filteredInstitutions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${4 + allAvailableActions.length}" class="text-center text-gray-500 py-3">No se encontraron instituciones con el estatus seleccionado.</td></tr>`;
                return;
            }

            // Rellenar el cuerpo de la tabla.
            let hasData = false;
            filteredInstitutions.forEach(inst => {
                // Encontrar el período programado para la institución actual.
                const programmedPeriod = programmedPeriods.find(p => p.institucionId === inst.id && (anioFilter === 'todos' || p.periodo === anioFilter));

                if (programmedPeriod) {
                    hasData = true;
                    let dataRow = '<tr>';
                    dataRow += `<td>${programmedPeriod.periodo || 'N/A'}</td>`;
                    dataRow += `<td>${inst.siglas}</td>`;
                    dataRow += `<td>${inst.nombre}</td>`;
                    dataRow += `<td>${inst.ptciActualizado || 'No'}</td>`; // Usar inst.ptciActualizado directamente.

                    allAvailableActions.forEach(action => {
                        const isActionEnabled = programmedPeriod.accionesPermitidas.includes(action);
                        dataRow += `<td>${isActionEnabled ? 'Sí' : 'No'}</td>`;
                    });
                    dataRow += '</tr>';
                    tbody.innerHTML += dataRow;
                }
            });

            if (!hasData) {
                 tbody.innerHTML = `<tr><td colspan="${4 + allAvailableActions.length}" class="text-center text-gray-500 py-3">No se encontraron datos para el filtro seleccionado.</td></tr>`;
            }
        }

        /**
         * Exporta los datos del reporte de avance institucional a un archivo CSV.
         */
        function exportReporteAvanceInstitucional() {
            const table = document.querySelector('#module-reporte-avance-institucional .data-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));

            let csvContent = headers.join(',') + '\n';

            rows.forEach(row => {
                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent.trim();
                    // Escapar comas y comillas dobles en el texto.
                    if (text.includes(',') || text.includes('"')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                });
                csvContent += rowData.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAvanceInstitucional_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- MÓDULO: CONTROL DE USUARIOS ---

        /**
         * Popula los selects del modal de agregar/editar usuario.
         */
        function populateUserModalSelects() {
            const perfilSelect = document.getElementById('user-perfil');
            const tipoUsuarioSelect = document.getElementById('user-tipo-usuario');
            const cargoSelect = document.getElementById('user-cargo');

            // Perfiles.
            perfilSelect.innerHTML = '<option value="">Seleccione Perfil</option>';
            defaultPerfiles.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                perfilSelect.appendChild(option);
            });

            // Tipos de Usuario.
            tipoUsuarioSelect.innerHTML = '<option value="">Seleccione Tipo</option>';
            defaultTiposUsuario.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                tipoUsuarioSelect.appendChild(option);
            });

            // Cargos.
            cargoSelect.innerHTML = '<option value="">Seleccione Cargo</option>';
            defaultCargos.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                cargoSelect.appendChild(option);
            });
        }

        /**
         * Renderiza la tabla de usuarios en el módulo de control de usuarios.
         */
        function renderUsersTable() {
            const tableBody = document.querySelector('#users-table tbody');
            tableBody.innerHTML = '';

            const statusFilter = document.querySelector('input[name="user_status_filter"]:checked').value;
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();

            const filteredUsers = users.filter(user => {
                const matchesStatus = statusFilter === 'todos' || user.estatus === statusFilter;
                const institution = institutions.find(inst => inst.siglas === user.siglasInstitucion);
                const institutionName = institution ? institution.nombre.toLowerCase() : '';

                const matchesSearch = searchTerm === '' ||
                                      user.clave.toLowerCase().includes(searchTerm) ||
                                      user.nombre.toLowerCase().includes(searchTerm) ||
                                      user.siglasInstitucion.toLowerCase().includes(searchTerm) ||
                                      institutionName.includes(searchTerm); // Busca por nombre de institución también.

                return matchesStatus && matchesSearch;
            });

            if (filteredUsers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-gray-500 py-3">No se encontraron usuarios.</td></tr>`;
                return;
            }

            filteredUsers.forEach(user => {
                const institution = institutions.find(inst => inst.siglas === user.siglasInstitucion);
                const institutionName = institution ? institution.nombre : 'N/A';
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${user.siglasInstitucion}</td>
                    <td>${institutionName}</td>
                    <td>${user.perfil}</td>
                    <td>${user.clave}</td>
                    <td>**********</td> <!-- Contraseña siempre oculta -->
                    <td>${user.estatus}</td>
                    <td>${user.correo || 'N/A'}</td>
                    <td>${user.telefono || 'N/A'}</td>
                    <td>${user.tipoUsuario || 'N/A'}</td>
                    <td>${user.cargo || 'N/A'}</td>
                    <td class="flex gap-1 justify-center">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="openUserModal('${user.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="M15 5l4 4"/>
                            </svg>
                        </button>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-md text-xs" onclick="openUserAccessReportModal('${user.id}')" title="Generar Reporte de Accesos">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="deleteUser('${user.id}')" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Abre el modal para agregar o editar un usuario.
         * @param {string} [userId=null] - El ID del usuario a editar. Si es null, se abre para agregar.
         */
        function openUserModal(userId = null) {
            const modalOverlay = document.getElementById('user-modal-overlay');
            const modalTitle = document.getElementById('user-modal-title');
            const form = document.getElementById('user-form');
            form.reset(); // Limpia el formulario.
            populateUserModalSelects(); // Asegura que los selects estén poblados.

            document.getElementById('user-id-edit').value = '';
            document.getElementById('user-siglas-institucion-filter').value = ''; // Limpia el input del filtro de institución.
            document.getElementById('user-siglas-institucion-id').value = ''; // Limpia el ID oculto de la institución.
            document.getElementById('user-password').value = ''; // Limpia la contraseña para nuevos usuarios.

            if (userId) {
                modalTitle.textContent = 'Editar Usuario';
                const userToEdit = users.find(user => user.id === userId);
                if (userToEdit) {
                    document.getElementById('user-id-edit').value = userToEdit.id;
                    document.getElementById('user-clave').value = userToEdit.clave;
                    document.getElementById('user-nombre').value = userToEdit.nombre;
                    document.getElementById('user-perfil').value = userToEdit.perfil;
                    document.querySelector(`input[name="user-estatus"][value="${userToEdit.estatus}"]`).checked = true;
                    document.getElementById('user-correo').value = userToEdit.correo;
                    document.getElementById('user-telefono').value = userToEdit.telefono;
                    document.getElementById('user-tipo-usuario').value = userToEdit.tipoUsuario;
                    document.getElementById('user-cargo').value = userToEdit.cargo;
                    // Establece el valor para el input del filtro de institución.
                    const institution = institutions.find(inst => inst.siglas === userToEdit.siglasInstitucion);
                    if (institution) {
                        document.getElementById('user-siglas-institucion-filter').value = `${institution.siglas} - ${institution.nombre}`;
                        document.getElementById('user-siglas-institucion-id').value = institution.siglas; // Almacena las siglas.
                    }
                    document.getElementById('user-password').value = userToEdit.password; // Muestra la contraseña para edición.
                }
            } else {
                modalTitle.textContent = 'Agregar Usuario';
                document.querySelector('input[name="user-estatus"][value="Activo"]').checked = true; // Por defecto, activo.
            }
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de agregar/editar usuario.
         */
        function closeUserModal() {
            document.getElementById('user-modal-overlay').classList.add('hidden');
            document.getElementById('user-siglas-institucion-suggestions').classList.add('hidden'); // Oculta las sugerencias.
        }

        /**
         * Maneja el envío del formulario de usuario (agregar/editar).
         * @param {Event} event - El evento del submit.
         */
        function handleUserFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('user-id-edit').value;
            const clave = document.getElementById('user-clave').value.trim();
            const password = document.getElementById('user-password').value.trim();
            const nombre = document.getElementById('user-nombre').value.trim();
            const perfil = document.getElementById('user-perfil').value;
            const estatus = document.querySelector('input[name="user-estatus"]:checked').value;
            const correo = document.getElementById('user-correo').value.trim();
            const telefono = document.getElementById('user-telefono').value.trim();
            const tipoUsuario = document.getElementById('user-tipo-usuario').value;
            const cargo = document.getElementById('user-cargo').value;
            const siglasInstitucion = document.getElementById('user-siglas-institucion-id').value; // Obtiene de input hidden.

            // Validación de campos obligatorios.
            if (!clave || !password || !nombre || !perfil || !siglasInstitucion) {
                alert('Por favor, complete todos los campos obligatorios (Nombre de Usuario, Contraseña, Nombre, Perfil, Siglas Institución).');
                return;
            }

            let modifiedFields = 'N/A';
            if (id) {
                // Edita un usuario existente.
                const index = users.findIndex(user => user.id === id);
                if (index !== -1) {
                    const oldUser = { ...users[index] }; // Copia los datos antiguos del usuario.
                    users[index] = { ...oldUser, clave, password, nombre, perfil, estatus, correo, telefono, tipoUsuario, cargo, siglasInstitucion };

                    // Determina los campos modificados para el log.
                    const changedFields = [];
                    for (const key in users[index]) {
                        if (users[index][key] !== oldUser[key] && key !== 'id') {
                            changedFields.push(key);
                        }
                    }
                    if (changedFields.length > 0) {
                        modifiedFields = `Datos de usuario modificados: ${changedFields.join(', ')}`;
                    } else {
                        modifiedFields = 'Ninguna';
                    }
                }
                // Registra la acción de modificación.
                logUserAccess(id, siglasInstitucion, clave, 'Control de Usuarios', 'Modificación', modifiedFields, 'Edición', 'Éxito');
            } else {
                // Agrega un nuevo usuario.
                const newId = 'user' + Date.now().toString(); // Genera ID único.
                // Verifica si la clave de usuario ya existe.
                if (users.some(user => user.clave === clave)) {
                    alert('La clave de usuario ya existe. Por favor, utilice una clave diferente.');
                    return;
                }
                users.push({ id: newId, clave, password, nombre, perfil, estatus, correo, telefono, tipoUsuario, cargo, siglasInstitucion });
                // Registra la acción de adición.
                logUserAccess(newId, siglasInstitucion, clave, 'Control de Usuarios', 'Agregación', 'Nuevo usuario creado', 'Creación', 'Éxito');
            }

            // Guarda los cambios en localStorage. En producción, se enviaría a la base de datos.
            localStorage.setItem('users_v11_1_1', JSON.stringify(users));
            renderUsersTable(); // Actualiza la tabla.
            closeUserModal();
            alert('Usuario guardado correctamente.');
        }

        /**
         * Elimina un usuario del sistema.
         * @param {string} userId - El ID del usuario a eliminar.
         */
        function deleteUser(userId) {
            if (confirm('¿Está seguro de que desea eliminar este usuario? Esto también eliminará sus registros de acceso.')) {
                const userToDelete = users.find(user => user.id === userId);
                if (userToDelete) {
                    users = users.filter(user => user.id !== userId);
                    userAccessLogs = userAccessLogs.filter(log => log.userId !== userId); // Elimina logs asociados.
                    // Guarda los cambios en localStorage. En producción, se enviaría a la base de datos.
                    localStorage.setItem('users_v11_1_1', JSON.stringify(users));
                    localStorage.setItem('userAccessLogs_v11_1_1', JSON.stringify(userAccessLogs));
                    renderUsersTable(); // Actualiza la tabla.
                    alert('Usuario eliminado correctamente.');
                    // Registra la acción de eliminación.
                    logUserAccess(userToDelete.id, userToDelete.siglasInstitucion, userToDelete.clave, 'Control de Usuarios', 'Eliminación', `Usuario ${userToDelete.clave} eliminado`, 'Eliminación', 'Éxito');
                }
            }
        }

        // --- Logging de Acceso de Usuarios ---
        /**
         * Registra un evento de acceso de usuario.
         * @param {string} userId - ID del usuario.
         * @param {string} siglas - Siglas de la institución del usuario.
         * @param {string} claveUsuario - Clave del usuario.
         * @param {string} moduloAccedido - Módulo al que se accedió.
         * @param {string} accionRealizada - Acción realizada (ej. 'Modificación', 'Agregación').
         * @param {string} campoModificado - Campo o entidad modificada (ej. 'Datos de usuario', 'Institución X').
         * @param {string} tipoEvento - Tipo de evento ('Inicio', 'Cierre', 'Error', 'Edición', 'Creación', 'Eliminación').
         * @param {string} resultado - Resultado de la acción ('Éxito', 'Fallo').
         */
        function logUserAccess(userId, siglas, claveUsuario, moduloAccedido, accionRealizada, campoModificado, tipoEvento, resultado) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            const fechaAcceso = `${year}-${month}-${day}`;
            const horaInicio = `${hours}:${minutes}:${seconds}`;
            const horaCierre = `${hours}:${minutes}:${seconds}`; // Simplificado para el prototipo.

            userAccessLogs.push({
                userId,
                year,
                siglas,
                claveUsuario,
                fechaAcceso,
                horaInicio,
                horaCierre,
                duracionSesion: 0, // Simplificado, en una app real se calcularía.
                moduloAccedido,
                accionRealizada,
                campoModificado, // Nuevo campo.
                tipoEvento,
                resultado,
                direccionIP: '127.0.0.1', // Placeholder. En producción, se obtendría la IP real.
                agenteUsuario: navigator.userAgent // Información del navegador.
            });
            // Guarda los logs en localStorage. En producción, se enviaría a la base de datos.
            localStorage.setItem('userAccessLogs_v11_1_1', JSON.stringify(userAccessLogs));
        }

        /**
         * Abre el modal para mostrar el reporte de acceso de un usuario específico.
         * @param {string} userId - El ID del usuario.
         */
        function openUserAccessReportModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('report-user-name').textContent = user.nombre;
            document.getElementById('report-user-clave').textContent = user.clave;

            const reportTableBody = document.getElementById('user-access-report-table-body');
            reportTableBody.innerHTML = '';

            const userLogs = userAccessLogs.filter(log => log.userId === userId);

            if (userLogs.length === 0) {
                reportTableBody.innerHTML = `<tr><td colspan="14" class="text-center text-gray-500 py-3">No hay registros de acceso para este usuario.</td></tr>`;
            } else {
                userLogs.forEach(log => {
                    const row = reportTableBody.insertRow();
                    row.innerHTML = `
                        <td>${log.year}</td>
                        <td>${log.siglas}</td>
                        <td>${log.claveUsuario}</td>
                        <td>${log.fechaAcceso}</td>
                        <td>${log.horaInicio}</td>
                        <td>${log.horaCierre}</td>
                        <td>${log.duracionSesion}</td>
                        <td>${log.moduloAccedido}</td>
                        <td>${log.accionRealizada}</td>
                        <td>${log.campoModificado || 'N/A'}</td>
                        <td>${log.tipoEvento}</td>
                        <td>${log.resultado}</td>
                        <td>${log.direccionIP}</td>
                        <td>${log.agenteUsuario}</td>
                    `;
                });
            }
            document.getElementById('user-access-report-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal del reporte de acceso de usuario.
         */
        function closeUserAccessReportModal() {
            document.getElementById('user-access-report-modal-overlay').classList.add('hidden');
        }

        /**
         * Descarga el reporte de acceso de un usuario específico como archivo CSV.
         */
        function downloadUserAccessReport() {
            const userId = users.find(u => u.clave === document.getElementById('report-user-clave').textContent)?.id;
            if (!userId) return;

            const user = users.find(u => u.id === userId);
            const logs = userAccessLogs.filter(log => log.userId === userId);

            const headers = ["Año", "Siglas", "Clave de Usuario", "Fecha de Acceso", "Hora de Inicio", "Hora de Cierre", "Duración (min)", "Módulo Accedido", "Acción Realizada", "Campo Modificado", "Tipo de Evento", "Resultado", "Dirección IP", "Agente de Usuario"];
            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';

            logs.forEach(log => {
                const rowData = [
                    log.year,
                    log.siglas,
                    log.claveUsuario,
                    log.fechaAcceso,
                    log.horaInicio,
                    log.horaCierre,
                    log.duracionSesion,
                    log.moduloAccedido,
                    log.accionRealizada,
                    log.campoModificado || 'N/A',
                    log.tipoEvento,
                    log.resultado,
                    log.direccionIP,
                    log.agenteUsuario
                ];
                csvContent += rowData.map(item => {
                    let text = String(item);
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAccesos_${user.clave}_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Genera y descarga el reporte histórico de accesos de todos los usuarios como archivo CSV.
         */
        function generateHistoricalAccessReport() {
            const headers = ["Año", "Siglas", "Clave de Usuario", "Fecha de Acceso", "Hora de Inicio", "Hora de Cierre", "Duración (min)", "Módulo Accedido", "Acción Realizada", "Campo Modificado", "Tipo de Evento", "Resultado", "Dirección IP", "Agente de Usuario"];
            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';

            userAccessLogs.forEach(log => {
                const rowData = [
                    log.year,
                    log.siglas,
                    log.claveUsuario,
                    log.fechaAcceso,
                    log.horaInicio,
                    log.horaCierre,
                    log.duracionSesion,
                    log.moduloAccedido,
                    log.accionRealizada,
                    log.campoModificado || 'N/A',
                    log.tipoEvento,
                    log.resultado,
                    log.direccionIP,
                    log.agenteUsuario
                ];
                csvContent += rowData.map(item => {
                    let text = String(item);
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAccesos_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>

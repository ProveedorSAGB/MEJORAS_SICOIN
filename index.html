<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOIN - BETA 1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 0.75rem;
        }
        /* Estilos para la pantalla de login */
        #login-page {
            background-color: #E0FFE0; /* Un verde claro y suave */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            /* No position: fixed o absolute aquí, se confía en display */
        }
        /* Asegura que la página de login esté completamente oculta cuando se aplica la clase 'hidden' */
        #login-page.hidden {
            display: none !important;
        }

        /* Asegura que la aplicación principal se muestre como flex cuando no esté oculta */
        #main-app:not(.hidden) {
            display: flex;
            flex-direction: column; /* Asumiendo que debe ser un diseño de columna */
            flex-grow: 1; /* Permite que tome la altura disponible */
        }

        .header-container {
            background-color: #1F4740;
            color: #ffffff;
            padding: 0.6rem 0.9rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            min-height: 70px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }
        .header-logo {
            flex-shrink: 0;
            margin-right: 0.4rem;
        }
        .header-logo img {
            height: 50px;
            width: auto;
            border-radius: 0.35rem;
        }
        .header-title {
            flex-grow: 1;
            text-align: center;
            margin: 0 0.4rem;
        }
        .header-title h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.05em; }
        .header-title h2 { font-size: 0.9rem; }
        .header-title h3 { font-size: 0.75rem; color: #d1d5db; margin-top: 2px; }

        .header-nav {
            flex-shrink: 0;
            display: flex;
            gap: 0.4rem;
        }
        .header-nav a, .header-nav button {
            color: #ffffff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.35rem;
            transition: background-color 0.3s ease;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        .header-nav a:hover, .header-nav button:hover {
            background-color: #333d4b;
        }
        .main-layout {
            display: flex;
            flex-grow: 1;
            padding: 0.6rem;
            gap: 0.6rem;
            flex-wrap: nowrap;
            align-items: flex-start;
        }
        .sidebar {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.8rem;
            width: 180px;
            flex-shrink: 0;
        }
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
            }
        }
        .sidebar .module-header {
            background-color: #2A5C50;
            color: #ffffff;
            padding: 0.4rem 0.6rem;
            border-radius: 0.3rem;
            margin-bottom: 0.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.75rem;
        }
        .sidebar .module-header:hover {
            background-color: #3A756A;
        }
        .sidebar .module-header svg {
            transition: transform 0.3s ease;
        }
        .sidebar .module-header.collapsed svg {
            transform: rotate(-90deg);
        }
        .sidebar .submodule-list {
            list-style: none;
            padding: 0;
            margin-bottom: 0.4rem;
            padding-left: 0.2rem;
        }
        .sidebar .submodule-list li a {
            display: block;
            padding: 0.2rem 0.6rem;
            color: #4a5568;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.7rem;
        }
        .sidebar .submodule-list li a:hover {
            background-color: #dbe4ed;
            color: #2d3748;
        }
        .sidebar .submodule-list li.active-item a {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
        }
        .content-area {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.9rem;
            flex-grow: 1;
            min-width: calc(100% - 180px - 1.2rem);
            overflow-y: auto;
            height: calc(100vh - 70px - 1.2rem - 0.6rem - 1.2rem);
        }
        @media (max-width: 1024px) {
            .content-area {
                min-width: unset;
                width: 100%;
                height: auto;
            }
        }
        .data-table-container {
            overflow-x: auto;
            margin-top: 0.6rem;
            border-radius: 0.3rem;
            border: 1px solid #e2e8f0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }
        .data-table th, .data-table td {
            padding: 0.35rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        .data-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border-top: 2px solid #2A5C50;
            border-left: 1px solid #3A756A;
            border-right: 1px solid #3A756A;
            text-align: center;
        }
        .data-table th:first-child {
            border-left: none;
        }
        .data-table th:last-child {
            border-right: none;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f8;
        }
        .data-table tbody tr.selected {
            background-color: #e0f2f7;
            border-left: 3px solid #00796b;
        }
        .footer-container {
            background-color: #ffffff;
            text-align: center;
            padding: 0.6rem;
            margin-top: 0.6rem;
            border-radius: 0.6rem;
            box-shadow: 0 -3px 5px rgba(0, 0, 0, 0.08);
        }
        .footer-container label {
            color: #4a5568;
            font-size: 0.65rem;
        }
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .select-wrapper select {
            appearance: none;
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.25rem 0.9rem 0.25rem 0.6rem;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            cursor: pointer;
            width: 100%;
        }
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #718096;
            font-size: 0.6rem;
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            justify-content: flex-start;
        }
        .radio-group label {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            font-size: 0.65rem;
            color: #4a5568;
            min-width: 32px;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group input[type="radio"]:checked + span {
            background-color: #A0522D;
            color: white;
            border-color: #8B4513;
            box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.3);
            font-weight: 600;
        }
        .radio-group label:hover {
            background-color: #e2e8f0;
        }
        .form-field-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        @media (min-width: 768px) {
            .form-field-group.row-layout {
                flex-direction: row;
                align-items: center;
            }
            .form-field-group.row-layout > label {
                width: 18%;
                flex-shrink: 0;
            }
            .form-field-group .flex-grow {
                flex-grow: 1;
            }
        }
        .form-field-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.1rem;
        }
        .institution-filter-container {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .institution-filter-input {
            width: 100%;
            padding: 0.25rem 0.6rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .institution-filter-input:focus {
            border-color: #A0522D;
            box-shadow: 0 0 0 2px rgba(160, 82, 45, 0.2);
        }
        .institution-suggestions {
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.35rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            margin-top: 0.2rem;
            top: 100%;
        }
        .institution-suggestions div {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #4a5568;
            transition: background-color 0.15s ease;
        }
        .institution-suggestions div:hover {
            background-color: #e2e8f0;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.6rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #4a5568;
        }
        .modal-header {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #2d3748;
            text-align: center;
        }
        .modal-form-group {
            margin-bottom: 0.8rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-buttons button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .modal-buttons .btn-save {
            background-color: #2A5C50;
            color: white;
        }
        .modal-buttons .btn-save:hover {
            background-color: #1A3F38;
        }
        .modal-buttons .btn-cancel {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #cbd5e0;
        }
        .modal-buttons .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .modal-buttons .btn-delete:hover {
            background-color: #dc2626;
        }
        .edit-list-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            flex-shrink: 0;
        }
        .edit-list-button svg {
            width: 16px;
            height: 16px;
            color: #4a5568;
        }
        .edit-list-button:hover svg {
            color: #2d3748;
        }
        #edit-list-modal-overlay .modal-content {
            max-width: 400px;
        }
        .period-program-modal-content {
            max-width: 800px;
        }
        .period-program-modal-content .grid-item {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            border-radius: 0.4rem;
            padding: 0.8rem;
        }
        .period-program-modal-content .grid-item h5 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #2d3748;
        }
        .period-program-modal-content .selected-institution-info {
            background-color: #e0f2f7;
            border: 1px solid #b2ebf2;
            padding: 0.5rem;
            border-radius: 0.4rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #00796b;
            font-weight: bold;
        }
        #history-modal-overlay .modal-content {
            max-width: 800px;
        }
        #history-modal-overlay .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.3rem;
        }
        #history-modal-overlay .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        #history-modal-overlay .history-table th,
        #history-modal-overlay .history-table td {
            padding: 0.4rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        #history-modal-overlay .history-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.6rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #info-modal p {
            font-size: 0.8rem;
            text-align: center;
            color: #374151;
        }

        .btn-visualizar {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-visualizar:hover {
            background-color: #8B4513;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-visualizar:active {
            background-color: #7A3D0F;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }

        .btn-acceso {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-acceso:hover {
            background-color: #8B4513;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-acceso:active {
            background-color: #7A3D0F;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <!-- Pantalla Principal (Login) -->
    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl">
            <div class="text-center mb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno" class="mx-auto h-16">
                <h2 class="text-lg font-semibold text-gray-700 mt-2">Secretaría Anticorrupción y Buen Gobierno</h2>
                <p class="text-sm text-gray-500">Sistema de Control Interno</p>
            </div>
            <div class="flex items-center justify-center space-x-6 mb-6">
                <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN" class="h-16">
                <div>
                    <div class="mb-2">
                        <label for="username" class="text-xs text-gray-600">Usuario:</label>
                        <input type="text" id="username" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="admin_user" disabled>
                    </div>
                    <div>
                        <label for="password" class="text-xs text-gray-600">Contraseña:</label>
                        <input type="password" id="password" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="**********" disabled>
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mb-6">Aplicación web para la Evaluación del SCII</p>
            <button onclick="accessSystem()" class="w-full btn-acceso">
                Accesar
            </button>
        </div>
    </div>

    <!-- Contenido principal de la aplicación SICOIN (inicialmente oculto) -->
    <div id="main-app" class="hidden">
        <header class="header-container">
            <div class="header-logo">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno">
            </div>
            <div class="header-title">
                <h1>SICOIN – MEJORAS PROPUESTAS</h1>
                <h2>Sistema de Control Interno Institucional</h2>
                <h3>VISUALIZACIÓN DE MEJORAS PROPUESTAS AL SICOIN</h3>
            </div>
            <div class="header-logo">
                <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN">
            </div>
            <nav class="header-nav w-full mt-2 justify-center">
                <a href="#" onclick="goHome(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Inicio
                </a>
                <a href="#" onclick="logout(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Salir
                </a>
                <button onclick="openInfoModal()" title="Acerca de">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                </button>
            </nav>
        </header>
        <div class="main-layout">
            <aside class="sidebar">
                <nav>
                    <ul>
                        <li>
                            <h3 class="module-header" onclick="toggleSubmodules(this)">
                                Consulta SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list">
                                <li class="active-item"><a href="#" onclick="showModule('consulta-instituciones', this)">▪ Consulta Instituciones</a></li>
                                <li><a href="#" onclick="showModule('catalogo-instituciones', this)">▪ Catálogo Instituciones</a></li>
                            </ul>
                        </li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Administración SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('programacion-periodos', this)">▪ Programación de periodos</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-am', this)">▪ Modifica Avance Trimestral AM</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-ac', this)">▪ Modifica Avance Trimestral AC</a></li>
                                <li><a href="#" onclick="showModule('procesos-registrados', this)">▪ Procesos Registrados x Oficio</a></li>
                                <li><a href="#" onclick="showModule('control-usuarios', this)">▪ Control de Usuarios</a></li>
                                <li><a href="#" onclick="showModule('registro-acciones', this)">▪ Registro de Acciones de Usuarios</a></li>
                                <li><a href="#" onclick="showModule('comunicados', this)">▪ Comunicados</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Reportes
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('reporte-avance-institucional', this)">▪ Reporte de Avance Institucional</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-reporte', this)">▪ Acciones de Mejora</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-reporte', this)">▪ Acciones de Control</a></li>
                                <li><a href="#" onclick="showModule('seguimiento-trimestral', this)">▪ Reporte Seguimiento Trimestral</a></li>
                                <li><a href="#" onclick="showModule('conclusion', this)">▪ Conclusión</a></li>
                                <li><a href="#" onclick="showModule('consolidado', this)">▪ Consolidado</a></li>
                                <li><a href="#" onclick="showModule('reporte-acciones-mejora', this)">▪ Reporte Acciones Mejora</a></li>
                                <li><a href="#" onclick="showModule('reporte-ptci-ptar', this)">▪ Reporte PTCI y PTAR (Excel)</a></li>
                                <li><a href="#" onclick="showModule('evaluacion-oic', this)">▪ Evaluación de OIC (Excel)</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-trimestre', this)">▪ Acciones Mejora por Trimestre</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-trimestre', this)">▪ Acciones Control Trimestral</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptci', this)">▪ Imprimir Programa de Trabajo de Control Interno</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptar', this)">▪ Imprimir Programa de Trabajo de Administración de Riesgo</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Usuario
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('cambiar-contrasena', this)">▪ Cambiar Contraseña</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>
            <section class="content-area">
                <div id="module-home" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Bienvenido al Sistema de Control Interno Institucional</h2>
                    <p class="text-center text-gray-600 text-xs">Selecciona una opción del menú lateral para comenzar.</p>
                </div>

                <div id="module-consulta-instituciones" class="module-content">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Elige Institución y Perfil que deseas consultar</h2>
                    </div>
                    <form action="#" method="post" class="space-y-2.5">
                        <div class="form-field-group row-layout">
                            <label for="periodo">Periodo</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="periodo" value="2014"><span>2014</span></label>
                                <label><input type="radio" name="periodo" value="2015"><span>2015</span></label>
                                <label><input type="radio" name="periodo" value="2016"><span>2016</span></label>
                                <label><input type="radio" name="periodo" value="2017"><span>2017</span></label>
                                <label><input type="radio" name="periodo" value="2018"><span>2018</span></label>
                                <label><input type="radio" name="periodo" value="2019"><span>2019</span></label>
                                <label><input type="radio" name="periodo" value="2020"><span>2020</span></label>
                                <label><input type="radio" name="periodo" value="2021"><span>2021</span></label>
                                <label><input type="radio" name="periodo" value="2022"><span>2022</span></label>
                                <label><input type="radio" name="periodo" value="2023"><span>2023</span></label>
                                <label><input type="radio" name="periodo" value="2024" checked><span>2024</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="estatus">Estatus</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="estatus" value="1" checked><span>Activo</span></label>
                                <label><input type="radio" name="estatus" value="0"><span>Inactivo</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="consulta-institucion-filter">Institución</label>
                            <div class="institution-filter-container flex-grow">
                                <input type="text" id="consulta-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off">
                                <input type="hidden" id="consulta-institucion-id" name="institucion_id">
                                <div id="consulta-institucion-suggestions" class="institution-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="perfil">Perfil</label>
                            <div class="select-wrapper flex-grow">
                                 <select id="perfil" name="perfil" class="w-full">
                                    <option value="" selected>Seleccione Perfil</option>
                                    <option value="1">Coordinador de Control Interno</option>
                                    <option value="2">Instancia de Control Interno</option>
                                    <option value="5">Riesgos</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="btn-visualizar">Visualizar</button>
                        </div>
                    </form>
                </div>

                <div id="module-catalogo-instituciones" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Catálogo de Instituciones</h2>
                    </div>

                    <div class="flex justify-end mb-2.5">
                        <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="openInstitutionModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                                <path d="M12 5v14"/><path d="M5 12h14"/>
                            </svg>
                            Agregar
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table" id="institutions-catalog-table">
                            <thead>
                                <tr>
                                    <th>Siglas</th>
                                    <th>Institución</th>
                                    <th>Tipo de Institución</th>
                                    <th>Sector</th>
                                    <th>Estatus</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="institution-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeInstitutionModal()">&times;</button>
                        <h3 class="modal-header" id="institution-modal-title">Agregar Institución</h3>
                        <form id="institution-form">
                            <input type="hidden" id="institution-id-edit">
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-tipo-institucion" style="min-width: 120px;">Tipo de Institución</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-tipo-institucion" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('tipoInstitucion')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-sector" style="min-width: 120px;">Sector</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-sector" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('sector')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-estatus" style="min-width: 120px;">Estatus</label>
                                <div class="radio-group flex-grow">
                                    <label><input type="radio" name="modal-estatus" value="Activa" checked><span>Activa</span></label>
                                    <label><input type="radio" name="modal-estatus" value="Inactiva"><span>Inactiva</span></label>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-siglas" style="min-width: 120px;">Siglas</label>
                                <input type="text" id="modal-siglas" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-institucion-nombre" style="min-width: 120px;">Institución</label>
                                <input type="text" id="modal-institucion-nombre" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" class="btn-cancel" onclick="closeInstitutionModal()">Cancelar</button>
                                <button type="submit" class="btn-save">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="edit-list-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditListModal()">&times;</button>
                        <h3 class="modal-header" id="edit-list-modal-title">Editar Lista</h3>
                        <div id="edit-list-container" class="max-h-60 overflow-y-auto border rounded-md mb-4">
                            </div>
                        <div class="flex gap-2 mt-4">
                            <input type="text" id="new-list-item-input" class="flex-grow p-2 border rounded text-xs" placeholder="Nuevo elemento">
                            <button type="button" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-lg text-xs" onclick="addListItem()">Agregar</button>
                        </div>
                        <div class="modal-buttons mt-4">
                            <button type="button" class="btn-cancel" onclick="closeEditListModal()">Cerrar</button>
                        </div>
                    </div>
                </div>

                <div id="edit-single-list-item-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditSingleListItemModal()">&times;</button>
                        <h3 class="modal-header">Editar Elemento</h3>
                        <input type="hidden" id="edit-single-list-item-index">
                        <input type="hidden" id="edit-single-list-item-type">
                        <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="edit-single-list-item-input" style="min-width: 120px;">Nuevo Valor</label>
                            <input type="text" id="edit-single-list-item-input" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" onclick="closeEditSingleListItemModal()">Cancelar</button>
                            <button type="button" class="btn-save" onclick="saveEditedListItem()">Guardar</button>
                        </div>
                    </div>
                </div>

                <div id="module-programacion-periodos" class="module-content hidden">
                    <div class="bg-gray-200 p-3 rounded-t-lg text-center mb-4 shadow-sm">
                        <h2 class="text-base font-bold text-gray-800">Programación de periodos</h2>
                        <h3 class="text-sm text-gray-700">Para Evaluación, Acciones de Mejora o Acciones de Control</h3>
                        <h4 class="text-xs text-gray-600 mt-1">Consulta APF</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4">
                        <div class="space-y-3">
                            <div class="form-field-group">
                                <label for="tipo-accion-filter">Tipo de Acción</label>
                                <div class="select-wrapper">
                                    <select id="tipo-accion-filter" onchange="renderProgramacionPeriodosTable()"></select>
                                </div>
                            </div>
                            <div class="form-field-group">
                                <label for="programacion-institucion-filter">Institución</label>
                                <div class="institution-filter-container">
                                    <input type="text" id="programacion-institucion-filter" class="institution-filter-input" placeholder="Filtrar por institución..." autocomplete="off">
                                    <button onclick="clearInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                    </button>
                                    <div id="programacion-institucion-suggestions" class="institution-suggestions hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mt-4 md:mt-0">
                            <div class="form-field-group">
                                <label for="ptci-actualizado-filter">Filtrar por PTCI actualizado</label>
                                <div class="select-wrapper">
                                    <select id="ptci-actualizado-filter" onchange="renderProgramacionPeriodosTable()">
                                        <option value="todos">Todos</option>
                                        <option value="Sí">Sí Actualizó PTCI</option>
                                        <option value="No">No Actualizó PTCI</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-end justify-end gap-2 pt-1">
                                 <button id="history-button" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openHistoryModal()" style="display: none;">Historial</button>
                                <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openAperturarModal()">Aperturar Sistema</button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="programacion-periodos-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-institutions" onchange="toggleAllInstitutions(this.checked)"></th>
                                    <th>Periodo</th>
                                    <th>Siglas</th>
                                    <th>Institución</th>
                                    <th>Actualizó PTCI</th>
                                    <th>Trimestre</th>
                                    <th>ACCIÓN PERMITIDA</th>
                                    <th>Fecha Inicio</th>
                                    <th>Fecha Fin</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="aperturar-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content period-program-modal-content">
                        <button class="modal-close-button" onclick="closeAperturarModal()">&times;</button>
                        <h3 class="modal-header">Aperturar Sistema</h3>
                        <div id="selected-institutions-display" class="selected-institution-info mb-4 hidden"></div>
                        <form id="aperturar-form" class="space-y-4"></form>
                    </div>
                </div>

                <div id="history-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeHistoryModal()">&times;</button>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="modal-header flex-grow text-left p-0 m-0">Historial: <span id="history-institution-name"></span></h3>
                            <div class="form-field-group w-1/2">
                                <label for="history-action-filter" class="sr-only">Filtrar por acción</label>
                                <div class="select-wrapper">
                                    <select id="history-action-filter" onchange="renderHistoryTable()"></select>
                                </div>
                            </div>
                        </div>
                        <div class="history-table-container">
                            <table class="history-table">
                                <thead><tr><th>Periodo</th><th>Trimestre</th><th>Acción</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Usuario</th></tr></thead>
                                <tbody id="history-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="module-reporte-avance-institucional" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-2.5 text-gray-800">Reporte Global de Avance Institucional en la Evaluación del SCI</h2>

                    <div class="flex flex-col mb-2.5">
                        <div class="mb-2.5">
                            <label for="estatus_reporte" class="sr-only">Estatus de Institución</label>
                            <div class="radio-group">
                                <label><input type="radio" name="estatus_reporte" value="1" checked><span>Activo</span></label>
                                <label><input type="radio" name="estatus_reporte" value="0"><span>Inactivo</span></label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="select-wrapper" style="width: auto;">
                                <label for="anio_input" class="sr-only">Elige periodo</label>
                                <select id="anio_input" name="anio_input" style="width: 90px; padding: 0.2rem 0.9rem 0.2rem 0.5rem; font-size: 0.7rem;">
                                    <option value="todos">TODOS</option>
                                    <option value="2014">2014</option>
                                    <option value="2015">2015</option>
                                    <option value="2016">2016</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <a href="#" class="export-button" style="background-color: #2A5C50; color: white; padding: 0.2rem 0.5rem; border-radius: 0.3rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.2rem; margin-bottom: 0.4rem; transition: background-color 0.3s ease; font-size: 0.7rem;">
                                <img src="https://placehold.co/14x14/ffffff/000000?text=XLS" alt="Exportar a Excel" title="Exportar a Excel" style="height: 14px; width: 14px;">
                                Exportar a Excel
                            </a>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Periodo</th>
                                    <th rowspan="2">Siglas</th>
                                    <th rowspan="2">Institución</th>
                                    <th colspan="8" class="text-center">Evaluación del SCII</th>
                                    <th colspan="5" class="text-center">PTCI Actualizado</th>
                                    <th colspan="4" class="text-center">Seguimiento AM (1T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AM (2T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AM (3T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AM (4T)</th>
                                    <th colspan="5" class="text-center">Riesgos</th>
                                    <th colspan="4" class="text-center">Seguimiento AC (1T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AC (2T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AC (3T)</th>
                                    <th colspan="4" class="text-center">Seguimiento AC (4T)</th>
                                    <th colspan="3" class="text-center">Revisión OIC</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AM (1T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AM (2T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AM (3T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AM (4T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AC (1T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AC (2T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AC (3T)</th>
                                    <th colspan="4" class="text-center">OIC-Seguimiento AC (4T)</th>
                                </tr>
                                <tr>
                                    <th>Restaurar Avance</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Procesos Prioritarios</th>
                                    <th>Config. Evaluación</th>
                                    <th>Evaluación del SCII</th>
                                    <th>Informe Anual</th>
                                    <th>PTCI Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Actualizar</th>
                                    <th>PTCI Act Finalizado</th>
                                    <th>Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Controles</th>
                                    <th>Estrategia</th>
                                    <th>PTAR Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Informe OIC Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>2024</td>
                                    <td>IPPR</td>
                                    <td>Institución de Prueba para el Reporte</td>
                                    <td>Sí</td>
                                    <td>01/01/2024</td>
                                    <td>31/12/2024</td>
                                    <td>5</td>
                                    <td>Sí</td>
                                    <td>Completado</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/01/2024</td>
                                    <td>31/12/2024</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/01/2024</td>
                                    <td>31/03/2024</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/04/2024</td>
                                    <td>30/06/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/07/2024</td>
                                    <td>30/09/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/10/2024</td>
                                    <td>31/12/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/01/2024</td>
                                    <td>31/12/2024</td>
                                    <td>5</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/01/2024</td>
                                    <td>31/03/2024</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/04/2024</td>
                                    <td>30/06/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/07/2024</td>
                                    <td>30/09/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/10/2024</td>
                                    <td>31/12/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/01/2024</td>
                                    <td>31/12/2024</td>
                                    <td>Sí</td>
                                    <td>01/01/2024</td>
                                    <td>31/03/2024</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/04/2024</td>
                                    <td>30/06/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/07/2024</td>
                                    <td>30/09/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/10/2024</td>
                                    <td>31/12/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/01/2024</td>
                                    <td>31/03/2024</td>
                                    <td>Sí</td>
                                    <td>Sí</td>
                                    <td>01/04/2024</td>
                                    <td>30/06/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/07/2024</td>
                                    <td>30/09/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                    <td>01/10/2024</td>
                                    <td>31/12/2024</td>
                                    <td>No</td>
                                    <td>No</td>
                                </tr>
                                <tr class="ui-datatable-empty-message">
                                    <td colspan="55" class="text-center text-gray-500 py-3">No se encontraron más resultados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="info-modal" class="modal-overlay hidden">
                    <div class="modal-content max-w-sm">
                         <button class="modal-close-button" onclick="closeInfoModal()">&times;</button>
                         <p>Esta interfaz se creó con el objetivo de visualizar las mejoras propuestas para el Sistema de Control Interno Institucional (SICOIN).</p>
                    </div>
                </div>

                <div id="module-modifica-avance-am" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Modifica Avance Trimestral AM</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para modificar avance trimestral AM.</p>
                </div>
                <div id="module-modifica-avance-ac" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Modifica Avance Trimestral AC</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para modificar avance trimestral AC.</p>
                </div>
                <div id="module-procesos-registrados" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Procesos Registrados por Oficio</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para procesos registrados por oficio.</p>
                </div>
                <div id="module-control-usuarios" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Control de Usuarios</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el control de usuarios.</p>
                </div>
                <div id="module-registro-acciones" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Registro de Acciones de Usuarios</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el registro de acciones de usuarios.</p>
                </div>
                <div id="module-comunicados" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Comunicados</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para comunicados.</p>
                </div>
                <div id="module-acciones-mejora-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Mejora</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de Acciones de Mejora.</p>
                </div>
                <div id="module-acciones-control-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Control</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de Acciones de Control.</p>
                </div>
                <div id="module-seguimiento-trimestral" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Seguimiento Trimestral</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de seguimiento trimestral.</p>
                </div>
                <div id="module-conclusion" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Conclusión</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para la conclusión.</p>
                </div>
                <div id="module-consolidado" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Consolidado</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el consolidado.</p>
                </div>
                <div id="module-reporte-acciones-mejora" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Acciones Mejora</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte de acciones de mejora.</p>
                </div>
                <div id="module-reporte-ptci-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte PTCI y PTAR (Excel)</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para el reporte PTCI y PTAR.</p>
                </div>
                <div id="module-evaluacion-oic" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Evaluación de OIC (Excel)</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para la evaluación de OIC.</p>
                </div>
                <div id="module-acciones-mejora-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Mejora por Trimestre</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para acciones de mejora por trimestre.</p>
                </div>
                <div id="module-acciones-control-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Control Trimestral</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para acciones de control trimestral.</p>
                </div>
                <div id="module-imprimir-ptci" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Control Interno</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para imprimir PTCI.</p>
                </div>
                <div id="module-imprimir-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Administración de Riesgo</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para imprimir PTAR.</p>
                </div>
                <div id="module-cambiar-contrasena" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Cambiar Contraseña</h2>
                    <p class="text-center text-gray-600 text-xs">Contenido para cambiar la contraseña del usuario.</p>
                </div>

            </section>
        </div>

        <footer class="footer-container">
            <label>Insurgentes Sur 1735, Col. Guadalupe Inn Ciudad de México., C.P 01020 - Tel. 2000 3000</label>
            <br>
            <label>Secretaría Anticorrupción y Buen Gobierno, México - algunos derechos reservados © 2016 </label>
        </footer>
    </div>

    <script>
        // --- BASE DE DATOS Y ESTADO GLOBAL ---
        const initialInstitutionsData = [
            { id: '224', siglas: 'APBP', nombre: 'Administración del Patrimonio de la Beneficencia Pública', tipo: 'Organismo Descentralizado', sector: '12 SALUD', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '310', siglas: 'ASPNAC', nombre: 'Administración del Sistema Portuario Nacional Acapulco, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '44', siglas: 'ASPNA', nombre: 'Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '312', siglas: 'ASPNCSL', nombre: 'Administración del Sistema Portuario Nacional Cabo San Lucas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '45', siglas: 'ASPNCO', nombre: 'Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '46', siglas: 'ASPNDB', nombre: 'Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '47', siglas: 'ASPNE', nombre: 'Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '48', siglas: 'ASPNG', nombre: 'Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '49', siglas: 'ASPNLC', nombre: 'Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '50', siglas: 'ASPNM', nombre: 'Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '999', siglas: 'IPPR', nombre: 'Institución de Prueba para el Reporte', tipo: 'Dependencia', sector: '99 Entidad no Coordinada Sectorialmente', estatus: 'Activa', ptciActualizado: 'Sí' }
        ];

        const defaultTipoInstitucion = [
            "Dependencia", "Órgano Administrativo Desconcentrado", "Organismo Descentralizado",
            "Empresa de Participación Estatal Mayoritaria", "Organismo Descentralizado No Sectorizado",
            "Fideicomiso Público", "Fideicomiso Público que forma parte del Sistema Financiero Mexicano",
            "Organismo Autónomo"
        ];

        const defaultSector = [
            "04 Gobernación", "05 Relaciones Exteriores", "06 Hacienda y Crédito Público",
            "07 Defensa Nacional", "08 Agricultura y Desarrollo Rural", "09 Infraestructura, Comunicaciones y Transportes",
            "10 Economía", "11 Educación Pública", "12 Salud", "13 Marina",
            "14 Trabajo y Previsión Social", "15 Desarrollo Agrario, Territorial y Urbano",
            "16 Medio Ambiente y Recursos Naturales", "17 Procuraduría General de la República",
            "18 Energía", "20 Bienestar", "21 Turismo",
            "25 Previsiones y Aportaciones para los Sistemas de Educación Básica, Normal, Tecnológica y de Adultos",
            "27 Función Pública", "36 Seguridad y Protección Ciudadana",
            "37 Consejería Jurídica del Ejecutivo Federal", "45 Comisión Reguladora de Energía",
            "46 Comisión Nacional de Hidrocarburos", "47 Entidades no Sectorizadas", "48 Cultura",
            "49 Fiscalía General de la República", "55 Agencia de Transformación Digital y Telecomunicaciones",
            "99 Entidad no Coordinada Sectorialmente"
        ];

        const availableActionsCategories = {
            "Evaluación Institución": ["Habilitar edición de procesos prioritarios y PTCI actualizado", "Habilitar evaluación del SCII", "Habilitar Captura de Informe Anual Finalizado"],
            "PTCI": ["Habilitar Captura del PTCI", "Habilitar captura del PTCI Actualizado", "Habilitar captura Seguimiento AM", "Habilitar captura Reporte Trimestral AM"],
            "PTAR": ["Habilitar captura Riesgos en el periodo", "Habilitar captura Seguimiento de AC", "Habilitar captura Reporte Trimestral AC"],
            "Evaluación OIC": ["Habilitar evaluación del OIC", "Habilitar OIC-Seguimiento de Acciones Mejora", "Habilitar OIC-Reporte Trimestral AM", "Habilitar OIC-Seguimiento de Acciones Control", "Habilitar OIC-Reporte Trimestral AC"]
        };

        let institutions = JSON.parse(localStorage.getItem('institutions_v11_1_1')) || initialInstitutionsData;
        let tipoInstitucionList = JSON.parse(localStorage.getItem('tipoInstitucionList_v11_1_1')) || defaultTipoInstitucion;
        let sectorList = JSON.parse(localStorage.getItem('sectorList_v11_1_1')) || defaultSector;
        let programmedPeriods = JSON.parse(localStorage.getItem('programmedPeriods_v11_1_1')) || [];
        let programmedPeriodsHistory = JSON.parse(localStorage.getItem('programmedPeriodsHistory_v11_1_1')) || {};

        let selectedInstitutionsForProgramacion = [];
        let currentEditingListType = '';

        // --- INICIALIZACIÓN Y NAVEGACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicialmente muestra la página de login
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');

            setupEventListeners();
            populateActionFilters();
            populateAperturarModalActions();
            populateModalSelects();

            // Asegura que el primer módulo de la barra lateral esté expandido por defecto
            const firstModuleHeader = document.querySelector('.sidebar .module-header');
            if (firstModuleHeader && firstModuleHeader.classList.contains('collapsed')) {
                firstModuleHeader.classList.remove('collapsed');
                const firstSubmoduleList = firstModuleHeader.nextElementSibling;
                if (firstSubmoduleList && firstSubmoduleList.classList.contains('submodule-list')) {
                    firstSubmoduleList.classList.remove('hidden');
                }
            }
        });

        // Función para acceder al sistema después del login
        function accessSystem() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            // Asegura que el enlace "Consulta Instituciones" esté activo y su módulo visible
            const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
            showModule('consulta-instituciones', consultaInstitucionesLink);
        }

        // Función para cerrar sesión y volver a la pantalla de login
        function logout(event) {
            event.preventDefault();
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
        }

        // Función para ir a la pantalla de inicio (Consulta Instituciones)
        function goHome(event) {
            event.preventDefault();
            const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
            showModule('consulta-instituciones', consultaInstitucionesLink);
        }

        // Funciones para el modal de información
        function openInfoModal() {
            document.getElementById('info-modal').classList.remove('hidden');
        }

        function closeInfoModal() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        function showModule(moduleId, clickedElement) {
            document.querySelectorAll('.module-content').forEach(module => module.classList.add('hidden'));
            const targetModule = document.getElementById('module-' + moduleId);
            if (targetModule) {
                targetModule.classList.remove('hidden');
                if (moduleId === 'catalogo-instituciones') {
                    renderInstitutionsTable();
                    populateModalSelects();
                } else if (moduleId === 'programacion-periodos') {
                    selectedInstitutionsForProgramacion = [];
                    renderProgramacionPeriodosTable();
                }
            }
            // Eliminar la clase 'active-item' de todos los elementos de la barra lateral
            document.querySelectorAll('.sidebar .submodule-list li').forEach(li => li.classList.remove('active-item'));
            // Si se hizo clic en un elemento, agregar la clase 'active-item' a su padre <li>
            if (clickedElement) {
                const parentLi = clickedElement.closest('li');
                if (parentLi) parentLi.classList.add('active-item');

                // Asegurarse de que el módulo padre esté expandido
                let parentUl = clickedElement.closest('.submodule-list');
                if (parentUl && parentUl.classList.contains('hidden')) {
                    parentUl.classList.remove('hidden');
                    let header = parentUl.previousElementSibling;
                    if (header && header.classList.contains('module-header')) {
                        header.classList.remove('collapsed');
                    }
                }
            }
        }

        function toggleSubmodules(headerElement) {
            headerElement.nextElementSibling.classList.toggle('hidden');
            headerElement.classList.toggle('collapsed');
        }

        function setupEventListeners() {
            const consultaInput = document.getElementById('consulta-institucion-filter');
            if(consultaInput) {
                consultaInput.addEventListener('input', () => handleInstitutionFilter(consultaInput.value, 'consulta', institutions));
                consultaInput.addEventListener('click', () => handleInstitutionFilter('', 'consulta', institutions, true));
            }

            const programacionInput = document.getElementById('programacion-institucion-filter');
            if(programacionInput) {
                programacionInput.addEventListener('input', () => handleInstitutionFilter(programacionInput.value, 'programacion', institutions));
                programacionInput.addEventListener('click', () => handleInstitutionFilter('', 'programacion', institutions, true));
            }

            const institutionForm = document.getElementById('institution-form');
            if (institutionForm) {
                institutionForm.addEventListener('submit', handleInstitutionFormSubmit);
            }

            document.addEventListener('click', (event) => {
                if (!event.target.closest('.institution-filter-container')) {
                    document.querySelectorAll('.institution-suggestions').forEach(el => el.classList.add('hidden'));
                }
            });
        }

        // --- LÓGICA DE FILTROS ---
        function handleInstitutionFilter(filterValue, context, data, showAll = false) {
            const suggestionsContainer = document.getElementById(`${context}-institucion-suggestions`);
            suggestionsContainer.innerHTML = '';
            const lowerCaseFilter = filterValue.toLowerCase();

            const filtered = data.filter(inst =>
                lowerCaseFilter === '' || inst.nombre.toLowerCase().includes(lowerCaseFilter) || inst.siglas.toLowerCase().includes(lowerCaseFilter)
            );

            if (filtered.length > 0 && (lowerCaseFilter.length > 0 || showAll)) {
                suggestionsContainer.classList.remove('hidden');
                filtered.forEach(inst => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = `${inst.siglas} - ${inst.nombre}`;
                    suggestionItem.onmousedown = () => selectInstitution(inst, context);
                    suggestionsContainer.appendChild(suggestionItem);
                });
            } else {
                suggestionsContainer.classList.add('hidden');
            }

            if (context === 'programacion') renderProgramacionPeriodosTable();
        }

        function selectInstitution(inst, context) {
            document.getElementById(`${context}-institucion-filter`).value = `${inst.siglas} - ${inst.nombre}`;
            if(document.getElementById(`${context}-institucion-id`)) {
                document.getElementById(`${context}-institucion-id`).value = inst.id;
            }
            document.getElementById(`${context}-institucion-suggestions`).classList.add('hidden');
            if (context === 'programacion') renderProgramacionPeriodosTable();
        }

        // Función para limpiar el filtro de institución en Programación de Periodos
        function clearInstitutionFilter() {
            const input = document.getElementById('programacion-institucion-filter');
            input.value = '';
            renderProgramacionPeriodosTable();
        }

        // --- MÓDULO: CATÁLOGO DE INSTITUCIONES ---
        function renderInstitutionsTable() {
            const tableBody = document.querySelector('#institutions-catalog-table tbody');
            tableBody.innerHTML = '';

            if (institutions.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.classList.add('ui-datatable-empty-message');
                noDataRow.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-3">No se encontraron instituciones.</td>`;
                tableBody.appendChild(noDataRow);
                return;
            }

            institutions.forEach(inst => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td>${inst.tipo}</td>
                    <td>${inst.sector}</td>
                    <td>${inst.estatus}</td>
                    <td class="flex gap-1 justify-center">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="editInstitution('${inst.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="M15 5l4 4"/>
                            </svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="deleteInstitution('${inst.id}')" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateModalSelects() {
            const tipoSelect = document.getElementById('modal-tipo-institucion');
            const sectorSelect = document.getElementById('modal-sector');

            tipoSelect.innerHTML = '<option value="">Seleccione</option>';
            tipoInstitucionList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                tipoSelect.appendChild(option);
            });
            sectorSelect.innerHTML = '<option value="">Seleccione</option>';
            sectorList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                sectorSelect.appendChild(option);
            });
        }

        function openInstitutionModal(institutionId = null) {
            const modalOverlay = document.getElementById('institution-modal-overlay');
            const modalTitle = document.getElementById('institution-modal-title');
            const form = document.getElementById('institution-form');
            form.reset();

            document.getElementById('institution-id-edit').value = '';
            populateModalSelects();

            if (institutionId) {
                modalTitle.textContent = 'Editar Institución';
                const institutionToEdit = institutions.find(inst => inst.id === institutionId);
                if (institutionToEdit) {
                    document.getElementById('institution-id-edit').value = institutionToEdit.id;
                    document.getElementById('modal-tipo-institucion').value = institutionToEdit.tipo;
                    document.getElementById('modal-sector').value = institutionToEdit.sector;
                    document.getElementById('modal-siglas').value = institutionToEdit.siglas;
                    document.getElementById('modal-institucion-nombre').value = institutionToEdit.nombre;
                    document.querySelector(`input[name="modal-estatus"][value="${institutionToEdit.estatus}"]`).checked = true;
                }
            } else {
                modalTitle.textContent = 'Agregar Institución';
                document.querySelector('input[name="modal-estatus"][value="Activa"]').checked = true;
            }
            modalOverlay.classList.remove('hidden');
        }

        function closeInstitutionModal() {
            document.getElementById('institution-modal-overlay').classList.add('hidden');
        }

        function handleInstitutionFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('institution-id-edit').value;
            const tipo = document.getElementById('modal-tipo-institucion').value;
            const sector = document.getElementById('modal-sector').value;
            const siglas = document.getElementById('modal-siglas').value;
            const nombre = document.getElementById('modal-institucion-nombre').value;
            const estatus = document.querySelector('input[name="modal-estatus"]:checked').value;

            if (id) {
                const index = institutions.findIndex(inst => inst.id === id);
                if (index !== -1) {
                    institutions[index] = { ...institutions[index], tipo, sector, siglas, nombre, estatus };
                }
            } else {
                const newId = Date.now().toString();
                institutions.push({ id: newId, tipo, sector, siglas, nombre, estatus, ptciActualizado: 'No' });
            }

            localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
            renderInstitutionsTable();
            closeInstitutionModal();
        }

        function editInstitution(id) {
            openInstitutionModal(id);
        }

        function deleteInstitution(id) {
            if (confirm('¿Está seguro de que desea eliminar esta institución?')) {
                institutions = institutions.filter(inst => inst.id !== id);
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                renderInstitutionsTable();
            }
        }

        function openEditListModal(listType) {
            currentEditingListType = listType;
            const modalOverlay = document.getElementById('edit-list-modal-overlay');
            const modalTitle = document.getElementById('edit-list-modal-title');
            const listContainer = document.getElementById('edit-list-container');
            listContainer.innerHTML = '';

            const listToEdit = listType === 'tipoInstitucion' ? tipoInstitucionList : sectorList;
            modalTitle.textContent = `Editar Lista de ${listType === 'tipoInstitucion' ? 'Tipo de Institución' : 'Sector'}`;
            listToEdit.forEach((item, index) => {
                const listItemDiv = document.createElement('div');
                listItemDiv.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'border-b', 'last:border-b-0');
                listItemDiv.innerHTML = `
                    <span class="text-sm text-gray-700">${item}</span>
                    <div class="flex gap-1">
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-md text-xs" onclick="openEditSingleListItemModal('${listType}', ${index}, '${item}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="removeListItem('${listType}', ${index})" title="Borrar ${listType === 'tipoInstitucion' ? 'Tipo de Institución' : 'Sector'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>`;
                listContainer.appendChild(listItemDiv);
            });
            modalOverlay.classList.remove('hidden');
        }

        function closeEditListModal() {
            document.getElementById('edit-list-modal-overlay').classList.add('hidden');
            populateModalSelects(); // Vuelve a poblar los selects después de editar las listas
        }

        function openEditSingleListItemModal(listType, index, value) {
            document.getElementById('edit-single-list-item-modal-overlay').classList.remove('hidden');
            document.getElementById('edit-single-list-item-index').value = index;
            document.getElementById('edit-single-list-item-type').value = listType;
            document.getElementById('edit-single-list-item-input').value = value;
            document.getElementById('edit-single-list-item-input').focus();
            document.getElementById('edit-list-modal-overlay').classList.add('hidden'); // Oculta el modal de lista mientras se edita un solo elemento
        }

        function closeEditSingleListItemModal() {
            document.getElementById('edit-single-list-item-modal-overlay').classList.add('hidden');
            openEditListModal(document.getElementById('edit-single-list-item-type').value); // Vuelve a abrir el modal de lista
        }

        function saveEditedListItem() {
            const index = document.getElementById('edit-single-list-item-index').value;
            const listType = document.getElementById('edit-single-list-item-type').value;
            const newValue = document.getElementById('edit-single-list-item-input').value.trim();
            if (!newValue) { alert('El nuevo valor no puede estar vacío.'); return; }

            let oldItem;
            if (listType === 'tipoInstitucion') {
                oldItem = tipoInstitucionList[index];
                if (tipoInstitucionList.includes(newValue) && newValue !== oldItem) { alert('Este tipo de institución ya existe.'); return; }
                tipoInstitucionList[index] = newValue;
                localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                // Actualiza las instituciones que usaban el valor antiguo
                institutions.forEach(inst => { if (inst.tipo === oldItem) inst.tipo = newValue; });
            } else if (listType === 'sector') {
                oldItem = sectorList[index];
                if (sectorList.includes(newValue) && newValue !== oldItem) { alert('Este sector ya existe.'); return; }
                sectorList[index] = newValue;
                localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                // Actualiza las instituciones que usaban el valor antiguo
                institutions.forEach(inst => { if (inst.sector === oldItem) inst.sector = newValue; });
            }
            localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
            closeEditSingleListItemModal();
            renderInstitutionsTable(); // Vuelve a renderizar la tabla de instituciones para reflejar los cambios
        }

        function addListItem() {
            const input = document.getElementById('new-list-item-input');
            const newItem = input.value.trim();
            if (newItem) {
                if (currentEditingListType === 'tipoInstitucion') {
                    if (tipoInstitucionList.includes(newItem)) { alert('Este tipo de institución ya existe.'); return; }
                    tipoInstitucionList.push(newItem);
                    localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                } else if (currentEditingListType === 'sector') {
                    if (sectorList.includes(newItem)) { alert('Este sector ya existe.'); return; }
                    sectorList.push(newItem);
                    localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                }
                input.value = '';
                openEditListModal(currentEditingListType); // Recarga la lista en el modal
            }
        }

        function removeListItem(listType, indexToRemove) {
            if (confirm('¿Está seguro de que desea eliminar este elemento? Las instituciones que lo usen quedarán sin un valor asignado.')) {
                let itemToRemove;
                if (listType === 'tipoInstitucion') {
                    itemToRemove = tipoInstitucionList[indexToRemove];
                    tipoInstitucionList.splice(indexToRemove, 1);
                    localStorage.setItem('tipoInstitucionList_v11_1_1', JSON.stringify(tipoInstitucionList));
                    // Elimina el tipo de institución de las instituciones que lo usaban
                    institutions.forEach(inst => { if (inst.tipo === itemToRemove) inst.tipo = ''; });
                } else if (listType === 'sector') {
                    itemToRemove = sectorList[indexToRemove];
                    sectorList.splice(indexToRemove, 1);
                    localStorage.setItem('sectorList_v11_1_1', JSON.stringify(sectorList));
                    // Elimina el sector de las instituciones que lo usaban
                    institutions.forEach(inst => { if (inst.sector === itemToRemove) inst.sector = ''; });
                }
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                openEditListModal(listType); // Recarga la lista en el modal
                renderInstitutionsTable(); // Vuelve a renderizar la tabla de instituciones para reflejar los cambios
            }
        }


        // --- MÓDULO: PROGRAMACIÓN DE PERIODOS ---
        function renderProgramacionPeriodosTable() {
            const tableBody = document.querySelector('#programacion-periodos-table tbody');
            tableBody.innerHTML = '';

            const institucionFilterText = document.getElementById('programacion-institucion-filter').value.toLowerCase();
            const ptciFilter = document.getElementById('ptci-actualizado-filter').value;
            const tipoAperturaFilter = document.getElementById('tipo-accion-filter').value;

            let institutionsToDisplay = institutions.filter(inst => {
                const instName = inst.nombre.toLowerCase();
                const instSiglas = inst.siglas.toLowerCase();
                const filterParts = institucionFilterText.split(' - ');
                const siglaFilter = filterParts[0];
                const nameFilter = filterParts.length > 1 ? filterParts.slice(1).join(' - ') : siglaFilter;

                const matchesInstitucion = institucionFilterText === '' || instName.includes(nameFilter) || instSiglas.includes(siglaFilter);
                const matchesPtci = ptciFilter === 'todos' || inst.ptciActualizado === ptciFilter;

                const programmedPeriod = programmedPeriods.find(pp => pp.institucionId === inst.id);
                const hasMatchingProgrammedPeriod = tipoAperturaFilter === 'todos' || (programmedPeriod && programmedPeriod.accionesPermitidas.includes(tipoAperturaFilter));

                return matchesInstitucion && matchesPtci && (tipoAperturaFilter === 'todos' ? true : hasMatchingProgrammedPeriod);
            });

            if (institutionsToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-3">No se encontraron resultados.</td></tr>`;
                updateUiPostSelection();
                return;
            }

            institutionsToDisplay.forEach(inst => {
                const programmedPeriod = programmedPeriods.find(p => p.institucionId === inst.id) || {};
                const isSelected = selectedInstitutionsForProgramacion.some(sInst => sInst.id === inst.id);
                const row = tableBody.insertRow();
                row.classList.toggle('selected', isSelected);
                row.dataset.institutionId = inst.id;
                row.onclick = (event) => {
                    if (event.target.type !== 'checkbox' && event.target.tagName !== 'BUTTON' && event.target.tagName !== 'SVG' && event.target.tagName !== 'PATH') {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleInstitutionSelection(checkbox, inst.id);
                    }
                };
                row.innerHTML = `
                    <td><input type="checkbox" data-institution-id="${inst.id}" onchange="toggleInstitutionSelection(this, '${inst.id}')" ${isSelected ? 'checked' : ''}></td>
                    <td>${programmedPeriod.periodo || 'N/A'}</td>
                    <td>${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td>${inst.ptciActualizado}</td>
                    <td>${programmedPeriod.trimestre || 'N/A'}</td>
                    <td>${(programmedPeriod.accionesPermitidas || []).join(', ') || 'N/A'}</td>
                    <td>${programmedPeriod.fechaInicio || 'N/A'}</td>
                    <td>${programmedPeriod.fechaFin || 'N/A'}</td>
                `;
            });
            updateUiPostSelection();
        }

        function toggleAllInstitutions(isChecked) {
            const checkboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                toggleInstitutionSelection(checkbox, checkbox.dataset.institutionId);
            });
        }

        function toggleInstitutionSelection(checkbox, institutionId) {
            const institution = institutions.find(inst => inst.id === institutionId);
            if (!institution) return;
            if (checkbox.checked) {
                if (!selectedInstitutionsForProgramacion.some(inst => inst.id === institutionId)) {
                    selectedInstitutionsForProgramacion.push(institution);
                }
            } else {
                selectedInstitutionsForProgramacion = selectedInstitutionsForProgramacion.filter(inst => inst.id !== institutionId);
            }
            checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
            updateUiPostSelection();
        }

        function updateUiPostSelection() {
            const allCheckboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('select-all-institutions');
            if (allCheckboxes.length > 0) {
                const allVisibleChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allVisibleChecked;
                selectAllCheckbox.indeterminate = !allVisibleChecked && Array.from(allCheckboxes).some(cb => cb.checked);
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            document.getElementById('history-button').style.display = selectedInstitutionsForProgramacion.length === 1 ? 'inline-flex' : 'none';
        }

        // --- MODALES Y LÓGICA DE DATOS ---
        function populateActionFilters() {
            const mainFilter = document.getElementById('tipo-accion-filter');
            const historyFilter = document.getElementById('history-action-filter');
            mainFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
            historyFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
            for (const category in availableActionsCategories) {
                const mainOptgroup = document.createElement('optgroup');
                mainOptgroup.label = category;
                const historyOptgroup = document.createElement('optgroup');
                historyOptgroup.label = category;
                availableActionsCategories[category].forEach(action => {
                    const mainOption = new Option(action, action);
                    const historyOption = new Option(action, action);
                    mainOptgroup.appendChild(mainOption);
                    historyOptgroup.appendChild(historyOption);
                });
                mainFilter.appendChild(mainOptgroup);
                historyFilter.appendChild(historyOptgroup);
            }
        }

        function populateAperturarModalActions() {
            const form = document.getElementById('aperturar-form');
            form.innerHTML = '';

            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];

            const periodosHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-field-group">
                        <label for="aperturar-periodo">Periodo</label>
                        <div class="select-wrapper">
                            <select id="aperturar-periodo" required onchange="updateDatesByPeriodAndTrimestre()">
                                ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-trimestre">Trimestre</label>
                        <div class="select-wrapper">
                            <select id="aperturar-trimestre" onchange="updateDatesByPeriodAndTrimestre()">
                                <option value="1T">1er Trimestre</option>
                                <option value="2T">2do Trimestre</option>
                                <option value="3T">3er Trimestre</option>
                                <option value="4T">4to Trimestre</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-inicio">Fecha Inicio</label>
                        <input type="date" id="aperturar-fecha-inicio" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-fin">Fecha Fin</label>
                        <input type="date" id="aperturar-fecha-fin" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                </div>
                <h4 class="text-md font-bold text-gray-700 mt-4 mb-2">Acciones a Habilitar</h4>`;
            form.insertAdjacentHTML('beforeend', periodosHTML);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            form.appendChild(actionsContainer);
            for (const category in availableActionsCategories) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                let checkboxesHTML = `<h5>${category}</h5>`;
                availableActionsCategories[category].forEach(action => {
                    checkboxesHTML += `<label class="flex items-center text-xs py-1"><input type="checkbox" name="accion-permitida" value="${action}" class="mr-2">${action}</label>`;
                });
                gridItem.innerHTML = checkboxesHTML;
                actionsContainer.appendChild(gridItem);
            }

            const buttonsHTML = `<div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAperturarModal()">Cancelar</button><button type="submit" class="btn-save">Aperturar</button></div>`;
            form.insertAdjacentHTML('beforeend', buttonsHTML);

            form.addEventListener('submit', handleAperturarSubmit);
        }

        function handleAperturarSubmit(event) {
            event.preventDefault();
            const periodo = document.getElementById('aperturar-periodo').value;
            const trimestre = document.getElementById('aperturar-trimestre').value;
            const fechaInicio = document.getElementById('aperturar-fecha-inicio').value;
            const fechaFin = document.getElementById('aperturar-fecha-fin').value;
            const accionesPermitidas = Array.from(document.querySelectorAll('input[name="accion-permitida"]:checked')).map(cb => cb.value);

            if (accionesPermitidas.length === 0) {
                alert('Debe seleccionar al menos una acción para habilitar.');
                return;
            }
             if (!fechaInicio || !fechaFin) {
                alert('Debe seleccionar una fecha de inicio y fin.');
                return;
            }

            selectedInstitutionsForProgramacion.forEach(inst => {
                const newAction = {
                    periodo, trimestre, fechaInicio, fechaFin,
                    accionesPermitidas,
                    usuario: 'admin_user',
                    timestamp: new Date().toISOString()
                };

                const existingIndex = programmedPeriods.findIndex(p => p.institucionId === inst.id);
                if (existingIndex !== -1) {
                    programmedPeriods[existingIndex] = { institucionId: inst.id, ...newAction };
                } else {
                    programmedPeriods.push({ institucionId: inst.id, ...newAction });
                }

                if (!programmedPeriodsHistory[inst.id]) programmedPeriodsHistory[inst.id] = [];
                programmedPeriodsHistory[inst.id].push(newAction);
            });
            localStorage.setItem('programmedPeriods_v11_1_1', JSON.stringify(programmedPeriods));
            localStorage.setItem('programmedPeriodsHistory_v11_1_1', JSON.stringify(programmedPeriodsHistory));

            closeAperturarModal();
            renderProgramacionPeriodosTable();
            alert('Sistema aperturado/actualizado correctamente.');
        }

        function openAperturarModal() {
            if (selectedInstitutionsForProgramacion.length === 0) {
                alert('Por favor, selecciona al menos una institución.');
                return;
            }
            // Reset automático de "Acciones" al recargar Aperturar Sistema
            document.querySelectorAll('input[name="accion-permitida"]').forEach(cb => cb.checked = false);
            // Actualizar fechas al abrir el modal
            updateDatesByPeriodAndTrimestre();

            const display = document.getElementById('selected-institutions-display');
            display.textContent = `Instituciones seleccionadas: ${selectedInstitutionsForProgramacion.map(i => i.siglas).join(', ')}`;
            display.classList.remove('hidden');
            document.getElementById('aperturar-modal-overlay').classList.remove('hidden');
        }
        function closeAperturarModal() { document.getElementById('aperturar-modal-overlay').classList.add('hidden'); }

        // Función para calcular y establecer las fechas de inicio y fin automáticamente
        function updateDatesByPeriodAndTrimestre() {
            const year = parseInt(document.getElementById('aperturar-periodo').value);
            const trimestre = document.getElementById('aperturar-trimestre').value;
            const fechaInicioInput = document.getElementById('aperturar-fecha-inicio');
            const fechaFinInput = document.getElementById('aperturar-fecha-fin');

            if (!year || !trimestre) return;

            let lastDayOfQuarter;
            switch (trimestre) {
                case '1T': // Enero-Marzo
                    lastDayOfQuarter = new Date(year, 2, 31); // 31 de marzo
                    break;
                case '2T': // Abril-Junio
                    lastDayOfQuarter = new Date(year, 5, 30); // 30 de junio
                    break;
                case '3T': // Julio-Septiembre
                    lastDayOfQuarter = new Date(year, 8, 30); // 30 de septiembre
                    break;
                case '4T': // Octubre-Diciembre
                    lastDayOfQuarter = new Date(year, 11, 31); // 31 de diciembre
                    break;
                default:
                    return;
            }

            // Fecha Inicio = último día del trimestre + 1 mes
            let startDate = new Date(lastDayOfQuarter);
            startDate.setMonth(startDate.getMonth() + 1);
            startDate.setDate(1); // Establecer al primer día del mes siguiente

            fechaInicioInput.value = startDate.toISOString().split('T')[0];

            // Fecha Fin = Fecha Inicio + 15 días (saltar fines de semana)
            let endDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < 15) {
                endDate.setDate(endDate.getDate() + 1);
                // Si es sábado (6) o domingo (0), no contar el día
                if (endDate.getDay() !== 0 && endDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            fechaFinInput.value = endDate.toISOString().split('T')[0];
        }


        function openHistoryModal() {
            if (selectedInstitutionsForProgramacion.length !== 1) return;
            const inst = selectedInstitutionsForProgramacion[0];
            document.getElementById('history-institution-name').textContent = `${inst.siglas} - ${inst.nombre}`;
            document.getElementById('history-action-filter').value = 'todos';
            renderHistoryTable();
            document.getElementById('history-modal-overlay').classList.remove('hidden');
        }

        function renderHistoryTable() {
            const inst = selectedInstitutionsForProgramacion[0];
            if (!inst) return;

            const historyTableBody = document.getElementById('history-table-body');
            historyTableBody.innerHTML = '';
            const actionFilter = document.getElementById('history-action-filter').value;
            const historyForInst = (programmedPeriodsHistory[inst.id] || []).filter(entry =>
                actionFilter === 'todos' || entry.accionesPermitidas.includes(actionFilter)
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (historyForInst.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-3">No hay historial para el filtro seleccionado.</td></tr>`;
                return;
            }

            historyForInst.forEach(entry => {
                const row = historyTableBody.insertRow();
                row.innerHTML = `
                    <td>${entry.periodo}</td>
                    <td>${entry.trimestre}</td>
                    <td>${entry.accionesPermitidas.join(', ')}</td>
                    <td>${entry.fechaInicio}</td>
                    <td>${entry.fechaFin}</td>
                    <td>${entry.usuario}</td>
                `;
            });
        }

        function closeHistoryModal() { document.getElementById('history-modal-overlay').classList.add('hidden'); }
    </script>
</body>
</html>

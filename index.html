<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales para el cuerpo y la fuente */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 0.75rem;
        }
        /* Estilos para la pantalla de login */
        #login-page {
            background-color: #E0FFE0; /* Un verde claro y suave */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }
        /* Asegura que la página de login esté completamente oculta cuando se aplica la clase 'hidden' */
        #login-page.hidden {
            display: none !important;
        }

        /* Asegura que la aplicación principal se muestre como flex cuando no esté oculta */
        #main-app:not(.hidden) {
            display: flex;
            flex-direction: column; /* Asumiendo que debe ser un diseño de columna */
            flex-grow: 1; /* Permite que tome la altura disponible */
        }

        /* Estilos para el encabezado de la aplicación */
        .header-container {
            background-color: #1F4740;
            color: #ffffff;
            padding: 0.6rem 0.9rem;
            display: flex;
            flex-direction: column; /* Cambiado a columna para apilar elementos */
            align-items: center; /* Centra los elementos horizontalmente en el contenedor */
            min-height: 70px;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.15);
        }

        .header-main-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            width: 100%; /* Ocupa todo el ancho disponible */
        }

        .header-logo {
            flex-shrink: 0;
            margin-right: 0.4rem;
        }
        .header-logo img {
            height: 50px;
            width: auto;
            border-radius: 0.35rem;
        }
        .header-title {
            flex-grow: 1; /* Permite que el título ocupe el espacio disponible */
            text-align: center;
            margin: 0 0.4rem;
        }
        .header-title h1 { font-size: 1.1rem; font-weight: 600; letter-spacing: 0.05em; }
        .header-title h2 { font-size: 0.9rem; }
        .header-title h3 { font-size: 0.75rem; color: #d1d5db; margin-top: 2px; }

        .header-nav {
            display: flex;
            gap: 0.4rem;
            width: 100%; /* Ocupa todo el ancho disponible */
            justify-content: flex-start; /* Alinea los botones a la izquierda */
            margin-top: 0.5rem; /* Espacio para el "salto de línea" */
            padding-left: 0; /* Asegura que no haya padding extra a la izquierda */
        }
        .header-nav a, .header-nav button {
            color: #ffffff;
            padding: 0.2rem 0.5rem;
            border-radius: 0.35rem;
            transition: background-color 0.3s ease;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: none;
            border: none;
            cursor: pointer;
        }
        .header-nav a:hover, .header-nav button:hover {
            background-color: #333d4b;
        }
        /* Estilos para el diseño principal de la aplicación */
        .main-layout {
            display: flex;
            flex-grow: 1;
            padding: 0.6rem;
            gap: 0.6rem;
            flex-wrap: nowrap;
            align-items: flex-start;
        }
        /* Estilos para la barra lateral (sidebar) */
        .sidebar {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.8rem;
            width: 180px;
            flex-shrink: 0;
        }
        @media (max-width: 1024px) {
            .sidebar {
                width: 100%;
            }
        }
        .sidebar .module-header {
            background-color: #2A5C50;
            color: #ffffff;
            padding: 0.4rem 0.6rem;
            border-radius: 0.3rem;
            margin-bottom: 0.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.75rem;
        }
        .sidebar .module-header:hover {
            background-color: #3A756A;
        }
        .sidebar .module-header svg {
            transition: transform 0.3s ease;
        }
        .sidebar .module-header.collapsed svg {
            transform: rotate(-90deg);
        }
        .sidebar .submodule-list {
            list-style: none;
            padding: 0;
            margin-bottom: 0.4rem;
            padding-left: 0.2rem;
        }
        .sidebar .submodule-list li a {
            display: block;
            padding: 0.2rem 0.6rem;
            color: #4a5568;
            border-radius: 0.3rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.7rem;
        }
        .sidebar .submodule-list li a:hover {
            background-color: #dbe4ed;
            color: #2d3748;
        }
        .sidebar .submodule-list li.active-item a {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
        }
        /* Estilos para el área de contenido principal */
        .content-area {
            background-color: #ffffff;
            border-radius: 0.6rem;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);
            padding: 0.9rem;
            flex-grow: 1;
            min-width: calc(100% - 180px - 1.2rem);
            overflow-y: auto;
            height: calc(100vh - 70px - 1.2rem - 0.6rem - 1.2rem);
        }
        @media (max-width: 1024px) {
            .content-area {
                min-width: unset;
                width: 100%;
                height: auto;
            }
        }
        /* Estilos para las tablas de datos */
        .data-table-container {
            overflow-x: auto; /* Permite scroll horizontal */
            margin-top: 0.6rem;
            border-radius: 0.3rem;
            border: 1px solid #e2e8f0;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
        }
        .data-table th, .data-table td {
            padding: 0.35rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            /* white-space: nowrap; */ /* Se elimina para permitir saltos de línea en acciones */
        }
        .data-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border-top: 2px solid #2A5C50;
            border-left: 1px solid #3A756A;
            border-right: 1px solid #3A756A;
            text-align: center;
            position: sticky; /* Fija los encabezados */
            top: 0; /* Fija en la parte superior del contenedor de scroll */
            z-index: 2; /* Asegura que esté por encima del contenido de la tabla */
        }
        .data-table th:first-child {
            border-left: none;
        }
        .data-table th:last-child {
            border-right: none;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f8;
        }
        .data-table tbody tr.selected {
            background-color: #e0f2f7;
            border-left: 3px solid #00796b;
        }
        /* Estilos para el pie de página */
        .footer-container {
            background-color: #ffffff;
            text-align: center;
            padding: 0.6rem;
            margin-top: 0.6rem;
            border-radius: 0.6rem;
            box-shadow: 0 -3px 5px rgba(0, 0, 0, 0.08);
        }
        .footer-container label {
            color: #4a5568;
            font-size: 0.65rem;
        }
        /* Estilos para selectores personalizados */
        .select-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        .select-wrapper select {
            appearance: none;
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.25rem 0.9rem 0.25rem 0.6rem;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            cursor: pointer;
            width: 100%;
        }
        .select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #718096;
            font-size: 0.6rem;
        }
        /* Estilos para grupos de radio buttons */
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            justify-content: flex-start;
        }
        .radio-group label {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            font-size: 0.65rem;
            color: #4a5568;
            min-width: 32px;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .radio-group input[type="radio"] {
            display: none;
        }
        .radio-group input[type="radio"]:checked + span {
            background-color: #A0522D;
            color: white;
            border-color: #8B4513;
            box-shadow: 0 0 0 3px rgba(160, 82, 45, 0.3);
            font-weight: 600;
        }
        .radio-group label:hover {
            background-color: #e2e8f0;
        }
        /* Estilos para grupos de campos de formulario */
        .form-field-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        @media (min-width: 768px) {
            .form-field-group.row-layout {
                flex-direction: row;
                align-items: center;
            }
            .form-field-group.row-layout > label {
                width: 18%;
                flex-shrink: 0;
            }
            .form-field-group .flex-grow {
                flex-grow: 1;
            }
        }
        .form-field-group label {
            font-size: 0.75rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 0.1rem;
        }
        /* Estilos para el filtro de institución con sugerencias */
        .institution-filter-container {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .institution-filter-input {
            width: 100%;
            padding: 0.25rem 0.6rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.35rem;
            font-size: 0.75rem;
            color: #2d3748;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .institution-filter-input:focus {
            border-color: #A0522D;
            box-shadow: 0 0 0 2px rgba(160, 82, 45, 0.2);
        }
        .institution-suggestions {
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.35rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
            margin-top: 0.2rem;
            top: 100%;
        }
        .institution-suggestions div {
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: #4a5568;
            transition: background-color 0.15s ease;
        }
        .institution-suggestions div:hover {
            background-color: #e2e8f0;
        }
        /* Estilos para modales (pop-ups) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Base z-index for all modals */
        }
        
        #edit-list-modal-overlay {
            z-index: 102; 
        }
        #edit-single-list-item-modal-overlay {
            z-index: 103; 
        }
        #custom-confirm-modal-overlay {
            z-index: 105; 
        }
        /* MEJORA 1: Asegurar que el modal de alerta esté siempre al frente. */
        #custom-alert-modal-overlay {
            z-index: 110;
        }


        .modal-content {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.6rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close-button {
            position: absolute;
            top: 0.8rem;
            right: 0.8rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #4a5568;
        }
        .modal-header {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #2d3748;
            text-align: center;
        }
        .modal-form-group {
            margin-bottom: 0.8rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-buttons button {
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .modal-buttons .btn-save {
            background-color: #2A5C50;
            color: white;
        }
        .modal-buttons .btn-save:hover {
            background-color: #1A3F38;
        }
        .modal-buttons .btn-cancel {
            background-color: #e2e8f0;
            color: #2d3748;
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #cbd5e0;
        }
        .modal-buttons .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .modal-buttons .btn-delete:hover {
            background-color: #dc2626;
        }
        /* Estilos específicos para botones de edición de listas */
        .edit-list-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 0.5rem;
            flex-shrink: 0;
            z-index: 10; /* Ensure button is on top of input/select */
            position: relative; /* Needed for z-index to work */
        }
        .edit-list-button svg {
            width: 16px;
            height: 16px;
            color: #4a5568;
        }
        .edit-list-button:hover svg {
            color: #2d3748;
        }
        #edit-list-modal-overlay .modal-content {
            max-width: 400px;
        }
        .period-program-modal-content {
            max-width: 800px;
        }
        .period-program-modal-content .grid-item {
            background-color: #f7fafc;
            border: 1px solid #cbd5e0;
            border-radius: 0.4rem;
            padding: 0.8rem;
        }
        .period-program-modal-content .grid-item h5 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: #2d3748;
        }
        .period-program-modal-content .selected-institution-info {
            background-color: #e0f2f7;
            border: 1px solid #b2ebf2;
            padding: 0.5rem;
            border-radius: 0.4rem;
            margin-bottom: 1rem;
            font-size: 0.75rem;
            color: #00796b;
            font-weight: bold;
        }
        #history-modal-overlay .modal-content {
            max-width: 800px;
        }
        #history-modal-overlay .history-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.3rem;
        }
        #history-modal-overlay .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
        }
        .data-table-container table.data-table thead th.quarter-header {
            background-color: #3A756A; /* Un tono más oscuro para los trimestres */
            color: white;
            font-size: 0.5rem;
            padding: 0.2rem;
            text-align: center;
        }
        #history-modal-overlay .history-table th,
        #history-modal-overlay .history-table td {
            padding: 0.4rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap;
        }
        #history-modal-overlay .history-table th {
            background-color: #2A5C50;
            color: white;
            font-size: 0.6rem;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #info-modal p {
            font-size: 0.8rem;
            text-align: center;
            color: #374151;
        }

        /* Estilos para botones de acceso y visualización */
        .btn-visualizar, .btn-acceso {
            background-color: #A0522D;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: none;
        }
        .btn-visualizar:hover, .btn-acceso:hover {
            background-color: #8B4513;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .btn-visualizar:active, .btn-acceso:active {
            background-color: #7A3D0F;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }
        /* Estilo para el recuadro de usuario y contraseña */
        .credentials-box {
            border: 1px solid #cbd5e0;
            border-radius: 0.35rem;
            padding: 1rem;
            margin-top: 1rem;
            background-color: #f7fafc;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .credentials-box label {
            font-weight: 600;
            color: #2d3748;
        }

        /* Estilos para el modal de alerta/confirmación personalizado */
        .custom-modal-content {
            max-width: 400px;
            text-align: center;
        }
        .custom-modal-content .modal-header {
            font-size: 1rem;
            margin-bottom: 0.8rem;
        }
        .custom-modal-content p {
            font-size: 0.85rem;
            color: #374151;
            margin-bottom: 1.2rem;
        }

        /* Estilos para centrar contenido en tablas */
        .data-table .text-center-col {
            text-align: center;
        }
        
        /* MEJORA 2: Estilos para el modal de avance */
        .advance-modal-content {
            max-width: 500px;
        }
        .advance-modal-content .input-group {
            display: flex;
            flex-direction: column; /* Apilar elementos verticalmente */
            gap: 0.5rem; /* Espacio entre elementos */
            margin-bottom: 0.75rem;
        }
        .advance-modal-content .input-group .label-and-input {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .advance-modal-content .input-group label {
            font-size: 0.8rem;
            font-weight: 500;
        }
        .advance-modal-content .input-group .input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .advance-modal-content .input-group input[type="number"] {
            width: 60px; /* Ancho fijo para el input numérico */
            padding: 0.2rem 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            text-align: center;
        }
        .advance-modal-content .input-group span {
            font-size: 0.75rem;
            color: #4a5568;
        }
        .advance-modal-content input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .advance-modal-content input[type="range"]:hover {
            opacity: 1;
        }
        .advance-modal-content input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #A0522D;
            border-radius: 50%;
            cursor: pointer;
        }
        .advance-modal-content input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #A0522D;
            border-radius: 50%;
            cursor: pointer;
        }
        .advance-modal-content .total-row {
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Alinear a la derecha */
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e2e8f0;
            font-weight: bold;
        }
        .advance-modal-content .total-row label {
            font-size: 0.85rem;
            margin-right: 1rem;
        }
        .advance-modal-content .total-row span {
            font-size: 0.9rem;
            color: #2A5C50;
            min-width: 50px;
            text-align: right;
        }
    </style>
</head>
<body>
    <!-- Pantalla Principal (Login) -->
    <div id="login-page" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl">
            <div class="text-center mb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno" class="mx-auto h-16">
                <h2 class="text-lg font-semibold text-gray-700 mt-2">Secretaría Anticorrupción y Buen Gobierno</h2>
                <p class="text-sm text-gray-500">Sistema de Control Interno</p>
            </div>
            <div class="flex items-center justify-center space-x-6 mb-6">
                <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN" class="h-16">
                <div>
                    <div class="mb-2">
                        <label for="username-login" class="text-xs text-gray-600">Usuario:</label>
                        <input type="text" id="username-login" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="admin_user">
                    </div>
                    <div>
                        <label for="password-login" class="text-xs text-gray-600">Contraseña:</label>
                        <input type="password" id="password-login" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" value="password123">
                    </div>
                </div>
            </div>
            <p class="text-center text-xs text-gray-500 mb-6">Aplicación web para la Evaluación del SCII</p>
            <button onclick="accessSystem()" class="w-full btn-acceso">
                Accesar
            </button>
        </div>
    </div>

    <!-- Contenido principal de la aplicación SICOIN (inicialmente oculto) -->
    <div id="main-app" class="hidden">
        <header class="header-container">
            <div class="header-main-content">
                <!-- Logo izquierdo -->
                <div class="header-logo">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/Buen_gobierno.svg" alt="Logo Buen Gobierno">
                </div>
                <!-- Título central que se expande -->
                <div class="header-title">
                    <h1>SICOIN – MEJORA PROPUESTA</h1>
                    <h2>Sistema de Control Interno Institucional</h2>
                    <h3>V 1.7</h3>
                </div>
                <!-- Logo derecho -->
                <div class="header-logo">
                    <img src="https://controlinterno.buengobierno.gob.mx/ESCII/img/logo_sicoin.jpg" alt="Logo SICOIN">
                </div>
            </div>
            <!-- Botones de navegación alineados a la izquierda en una nueva línea -->
            <nav class="header-nav">
                <a href="#" onclick="goHome(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Inicio
                </a>
                <a href="#" onclick="logout(event)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Salir
                </a>
                <button onclick="openInfoModal()" title="Acerca de">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                </button>
            </nav>
        </header>
        <div class="main-layout">
            <aside class="sidebar">
                <nav>
                    <ul>
                        <li>
                            <h3 class="module-header" onclick="toggleSubmodules(this)">
                                Consulta SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list">
                                <li class="active-item"><a href="#" onclick="showModule('consulta-instituciones', this)">▪ Consulta Instituciones</a></li>
                                <li><a href="#" onclick="showModule('catalogo-instituciones', this)">▪ Catálogo Instituciones</a></li>
                            </ul>
                        </li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Administración SCII
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('programacion-periodos', this)">▪ Programación de periodos</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-am', this)">▪ Modifica Avance Trimestral AM</a></li>
                                <li><a href="#" onclick="showModule('modifica-avance-ac', this)">▪ Modifica Avance Trimestral AC</a></li>
                                <!-- "Procesos Registrados x Oficio" y "Registro de Acciones de Usuarios" eliminados -->
                                <li><a href="#" onclick="showModule('control-usuarios', this)">▪ Control de Usuarios</a></li>
                                <li><a href="#" onclick="showModule('comunicados', this)">▪ Comunicados</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Reportes
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('reporte-avance-institucional', this)">▪ Reporte de Avance Institucional</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-reporte', this)">▪ Acciones de Mejora</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-reporte', this)">▪ Acciones de Control</a></li>
                                <li><a href="#" onclick="showModule('seguimiento-trimestral', this)">▪ Reporte Seguimiento Trimestral</a></li>
                                <li><a href="#" onclick="showModule('conclusion', this)">▪ Conclusión</a></li>
                                <li><a href="#" onclick="showModule('consolidado', this)">▪ Consolidado</a></li>
                                <li><a href="#" onclick="showModule('reporte-acciones-mejora', this)">▪ Reporte Acciones Mejora</a></li>
                                <li><a href="#" onclick="showModule('reporte-ptci-ptar', this)">▪ Reporte PTCI y PTAR (Excel)</a></li>
                                <li><a href="#" onclick="showModule('evaluacion-oic', this)">▪ Evaluación de OIC (Excel)</a></li>
                                <li><a href="#" onclick="showModule('acciones-mejora-trimestre', this)">▪ Acciones Mejora por Trimestre</a></li>
                                <li><a href="#" onclick="showModule('acciones-control-trimestre', this)">▪ Acciones Control Trimestral</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptci', this)">▪ Imprimir Programa de Trabajo de Control Interno</a></li>
                                <li><a href="#" onclick="showModule('imprimir-ptar', this)">▪ Imprimir Programa de Trabajo de Administración de Riesgo</a></li>
                            </ul>
                        </li>
                        <li class="my-2"></li>
                        <li>
                            <h3 class="module-header collapsed" onclick="toggleSubmodules(this)">
                                Usuario
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </h3>
                            <ul class="submodule-list hidden">
                                <li><a href="#" onclick="showModule('cambiar-contrasena', this)">▪ Cambiar Contraseña</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
            </aside>
            <section class="content-area">
                <div id="module-home" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Bienvenido al Sistema de Control Interno Institucional</h2>
                    <p class="text-center text-gray-600 text-xs">Selecciona una opción del menú lateral para comenzar.</p>
                </div>

                <div id="module-consulta-instituciones" class="module-content">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Elige Institución y Perfil que deseas consultar</h2>
                    </div>
                    <form action="#" method="post" class="space-y-2.5">
                        <div class="form-field-group row-layout">
                            <label for="periodo">Periodo</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="periodo" value="2014"><span>2014</span></label>
                                <label><input type="radio" name="periodo" value="2015"><span>2015</span></label>
                                <label><input type="radio" name="periodo" value="2016"><span>2016</span></label>
                                <label><input type="radio" name="periodo" value="2017"><span>2017</span></label>
                                <label><input type="radio" name="periodo" value="2018"><span>2018</span></label>
                                <label><input type="radio" name="periodo" value="2019"><span>2019</span></label>
                                <label><input type="radio" name="periodo" value="2020"><span>2020</span></label>
                                <label><input type="radio" name="periodo" value="2021"><span>2021</span></label>
                                <label><input type="radio" name="periodo" value="2022"><span>2022</span></label>
                                <label><input type="radio" name="periodo" value="2023"><span>2023</span></label>
                                <label><input type="radio" name="periodo" value="2024" checked><span>2024</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="estatus">Estatus</label>
                            <div class="radio-group flex-grow">
                                <label><input type="radio" name="estatus" value="1" checked><span>Activo</span></label>
                                <label><input type="radio" name="estatus" value="0"><span>Inactivo</span></label>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="consulta-institucion-filter">Institución</label>
                            <div class="institution-filter-container flex-grow">
                                <input type="text" id="consulta-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off">
                                <input type="hidden" id="consulta-institucion-id" name="institucion_id">
                                <button type="button" onclick="clearConsultaInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                </button>
                                <div id="consulta-institucion-suggestions" class="institution-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="perfil">Perfil</label>
                            <div class="select-wrapper flex-grow">
                                 <select id="perfil" name="perfil" class="w-full">
                                    <option value="" selected>Seleccione Perfil</option>
                                    <option value="Coordinador de Control Interno">Coordinador de Control Interno</option>
                                    <option value="Instancia de Control Interno">Instancia de Control Interno</option>
                                    <option value="Riesgos">Riesgos</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="btn-visualizar">Visualizar</button>
                        </div>
                    </form>
                </div>

                <div id="module-catalogo-instituciones" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Catálogo de Instituciones</h2>
                    </div>

                    <div class="form-field-group mb-2.5">
                        <label for="catalogo-institucion-filter" class="sr-only">Filtrar Institución</label>
                        <div class="institution-filter-container">
                            <input type="text" id="catalogo-institucion-filter" class="institution-filter-input" placeholder="Filtrar por siglas o nombre de institución..." autocomplete="off">
                            <input type="hidden" id="catalogo-institucion-id" name="institucion_id">
                            <button type="button" onclick="clearCatalogoInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                            </button>
                            <div id="catalogo-institucion-suggestions" class="institution-suggestions hidden"></div>
                        </div>
                    </div>

                    <div class="flex justify-end mb-2.5">
                        <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="openInstitutionModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                                <path d="M12 5v14"/><path d="M5 12h14"/>
                            </svg>
                            Agregar
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table" id="institutions-catalog-table">
                            <thead>
                                <tr>
                                    <th class="text-center-col">Siglas</th>
                                    <th>Institución</th>
                                    <th>Tipo de Institución</th>
                                    <th>Sector</th>
                                    <th class="text-center-col">Estatus</th>
                                    <th class="text-center-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="institution-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeInstitutionModal()">&times;</button>
                        <h3 class="modal-header" id="institution-modal-title">Agregar Institución</h3>
                        <form id="institution-form">
                            <input type="hidden" id="institution-id-edit">
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-tipo-institucion" style="min-width: 120px;">Tipo de Institución</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-tipo-institucion" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('tipoInstitucion')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-sector" style="min-width: 120px;">Sector</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="modal-sector" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('sector')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-estatus" style="min-width: 120px;">Estatus</label>
                                <div class="radio-group flex-grow">
                                    <label><input type="radio" name="modal-estatus" value="Activa" checked><span>Activa</span></label>
                                    <label><input type="radio" name="modal-estatus" value="Inactiva"><span>Inactiva</span></label>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-siglas" style="min-width: 120px;">Siglas</label>
                                <input type="text" id="modal-siglas" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="modal-institucion-nombre" style="min-width: 120px;">Institución</label>
                                <input type="text" id="modal-institucion-nombre" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" class="btn-cancel" onclick="closeInstitutionModal()">Cancelar</button>
                                <button type="submit" class="btn-save">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="edit-list-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditListModal()">&times;</button>
                        <h3 class="modal-header" id="edit-list-modal-title">Editar Lista</h3>
                        <div id="edit-list-container" class="max-h-60 overflow-y-auto border rounded-md mb-4">
                            </div>
                        <div class="flex gap-2 mt-4">
                            <input type="text" id="new-list-item-input" class="flex-grow p-2 border rounded text-xs" placeholder="Nuevo elemento">
                            <button type="button" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-lg text-xs" onclick="addListItem()">Agregar</button>
                        </div>
                        <div class="modal-buttons mt-4">
                            <button type="button" class="btn-cancel" onclick="closeEditListModal()">Cerrar</button>
                        </div>
                    </div>
                </div>

                <div id="edit-single-list-item-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeEditSingleListItemModal()">&times;</button>
                        <h3 class="modal-header">Editar Elemento</h3>
                        <input type="hidden" id="edit-single-list-item-index">
                        <input type="hidden" id="edit-single-list-item-type">
                        <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                            <label for="edit-single-list-item-input" style="min-width: 120px;">Nuevo Valor</label>
                            <input type="text" id="edit-single-list-item-input" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="btn-cancel" onclick="closeEditSingleListItemModal()">Cancelar</button>
                            <button type="button" class="btn-save" onclick="saveEditedListItem()">Guardar</button>
                        </div>
                    </div>
                </div>

                <div id="module-programacion-periodos" class="module-content hidden">
                    <div class="bg-gray-200 p-3 rounded-t-lg text-center mb-4 shadow-sm">
                        <h2 class="text-base font-bold text-gray-800">Programación de periodos</h2>
                        <h3 class="text-sm text-gray-700">Para Evaluación, Acciones de Mejora o Acciones de Control</h3>
                        <h4 class="text-xs text-gray-600 mt-1">Consulta APF</h4>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4">
                        <div class="space-y-3">
                            <div class="form-field-group">
                                <label for="tipo-accion-filter">Tipo de Acción</label>
                                <div class="select-wrapper">
                                    <select id="tipo-accion-filter" onchange="renderProgramacionPeriodosTable()"></select>
                                </div>
                            </div>
                            <div class="form-field-group">
                                <label for="programacion-institucion-filter">Institución</label>
                                <div class="institution-filter-container">
                                    <input type="text" id="programacion-institucion-filter" class="institution-filter-input" placeholder="Filtrar por institución..." autocomplete="off">
                                    <input type="hidden" id="programacion-institucion-id" name="institucion_id">
                                    <button onclick="clearProgramacionInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                    </button>
                                    <div id="programacion-institucion-suggestions" class="institution-suggestions hidden"></div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3 mt-4 md:mt-0">
                            <div class="form-field-group">
                                <label for="ptci-actualizado-filter">Filtrar por PTCI actualizado</label>
                                <div class="select-wrapper">
                                    <select id="ptci-actualizado-filter" onchange="renderProgramacionPeriodosTable()">
                                        <option value="todos">Todos</option>
                                        <option value="Sí">Sí Actualizó PTCI</option>
                                        <option value="No">No Actualizó PTCI</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex items-end justify-end gap-2 pt-1">
                                 <button id="history-button" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openHistoryModal()" style="display: none;">Historial</button>
                                <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md" onclick="openAperturarModal()">Aperturar Sistema</button>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="programacion-periodos-table">
                            <thead>
                                <tr>
                                    <th class="text-center-col"><input type="checkbox" id="select-all-institutions" onchange="toggleAllInstitutions(this.checked)"></th>
                                    <th class="text-center-col">Periodo</th>
                                    <th class="text-center-col">Siglas</th>
                                    <th>Institución</th>
                                    <th class="text-center-col">Actualizó PTCI</th>
                                    <th class="text-center-col">Trimestre</th>
                                    <th>ACCIÓN PERMITIDA</th>
                                    <th class="text-center-col">Fecha Inicio</th>
                                    <th class="text-center-col">Fecha Fin</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="aperturar-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content period-program-modal-content">
                        <button class="modal-close-button" onclick="closeAperturarModal()">&times;</button>
                        <h3 class="modal-header">Aperturar Sistema</h3>
                        <div id="selected-institutions-display" class="selected-institution-info mb-4 hidden"></div>
                        <form id="aperturar-form" class="space-y-4"></form>
                    </div>
                </div>

                <div id="history-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeHistoryModal()">&times;</button>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="modal-header flex-grow text-left p-0 m-0">Historial: <span id="history-institution-name"></span></h3>
                            <div class="form-field-group w-1/2">
                                <label for="history-action-filter" class="sr-only">Filtrar por acción</label>
                                <div class="select-wrapper">
                                    <select id="history-action-filter" onchange="renderHistoryTable()"></select>
                                </div>
                            </div>
                        </div>
                        <div class="history-table-container">
                            <table class="history-table">
                                <thead><tr><th>Periodo</th><th>Trimestre</th><th>Acción</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Usuario</th></tr></thead>
                                <tbody id="history-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="module-reporte-avance-institucional" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Reporte Global de Avance Institucional en la Evaluación del SCI</h2>
                    </div>

                    <div class="flex flex-col mb-2.5">
                        <div class="mb-2.5">
                            <label for="estatus_reporte" class="sr-only">Estatus de Institución</label>
                            <div class="radio-group">
                                <label><input type="radio" name="estatus_reporte" value="1" checked onchange="renderReporteAvanceInstitucionalTable()"><span>Activo</span></label>
                                <label><input type="radio" name="estatus_reporte" value="0" onchange="renderReporteAvanceInstitucionalTable()"><span>Inactivo</span></label>
                            </div>
                        </div>

                        <div class="flex justify-between items-center">
                            <div class="select-wrapper" style="width: auto;">
                                <label for="anio_input" class="text-xs font-medium text-gray-700 mr-1">Periodo:</label>
                                <select id="anio_input" name="anio_input" style="width: 90px; padding: 0.2rem 0.9rem 0.2rem 0.5rem; font-size: 0.7rem;" onchange="renderReporteAvanceInstitucionalTable()">
                                    <option value="todos">TODOS</option>
                                    <option value="2014">2014</option>
                                    <option value="2015">2015</option>
                                    <option value="2016">2016</option>
                                    <option value="2017">2017</option>
                                    <option value="2018">2018</option>
                                    <option value="2019">2019</option>
                                    <option value="2020">2020</option>
                                    <option value="2021">2021</option>
                                    <option value="2022">2022</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                </select>
                            </div>
                            <div class="select-wrapper" style="width: auto; margin-left: 0.5rem;">
                                <label for="trimestre_reporte_input" class="text-xs font-medium text-gray-700 mr-1">Trimestre:</label>
                                <select id="trimestre_reporte_input" name="trimestre_reporte_input" style="width: 120px; padding: 0.2rem 0.9rem 0.2rem 0.5rem; font-size: 0.7rem;" onchange="renderReporteAvanceInstitucionalTable()">
                                    <option value="todos">TODOS</option>
                                    <option value="1T">1er Trimestre</option>
                                    <option value="2T">2do Trimestre</option>
                                    <option value="3T">3er Trimestre</option>
                                    <option value="4T">4to Trimestre</option>
                                </select>
                            </div>
                            <a href="#" class="export-button" onclick="exportReporteAvanceInstitucional()" style="background-color: #2A5C50; color: white; padding: 0.2rem 0.5rem; border-radius: 0.3rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.2rem; margin-bottom: 0.4rem; transition: background-color 0.3s ease; font-size: 0.7rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Exportar a Excel
                            </a>
                        </div>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th rowspan="3">Periodo</th>
                                    <th rowspan="3">Trimestre</th>
                                    <th rowspan="3">Siglas</th>
                                    <th rowspan="3">Institución</th>
                                    <th colspan="23">Evaluación de la Institución</th>
                                    <th colspan="11">Evaluación del OIC</th>
                                </tr>
                                <tr>
                                    <th colspan="4">Evaluación del SCII</th>
                                    <th colspan="6">PTCI</th>
                                    <th colspan="4">Seguimiento de Acciones de Mejora</th>
                                    <th colspan="5">PTAR</th>
                                    <th colspan="4">Seguimiento de Acciones de Control</th>
                                    <th colspan="3">Revisión OIC</th>
                                    <th colspan="4">OIC - Seguimiento de Acciones de Mejora</th>
                                    <th colspan="4">OIC - Seguimiento de Acciones de Control</th>
                                </tr>
                                <tr>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Procesos Prioritarios</th>
                                    <th>Evaluación del SCII</th>
                                    <th>Informe Anual</th>
                                    <th>PTCI Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Actualizar PTCI</th>
                                    <th>PTCI Act Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Controles</th>
                                    <th>Estrategia</th>
                                    <th>PTAR Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Informe OIC Finalizado</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                    <th>Periodo Captura</th>
                                    <th>Abierto Hasta</th>
                                    <th>Finalizado</th>
                                    <th>Reporte Trimestral</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los datos de la tabla se generarán dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="info-modal" class="modal-overlay hidden">
                    <div class="modal-content max-w-sm">
                         <button class="modal-close-button" onclick="closeInfoModal()">&times;</button>
                         <p>Esta interfaz se creó con el objetivo de visualizar las mejoras propuestas para el Sistema de Control Interno Institucional (SICOIN).</p>
                    </div>
                </div>

                <!-- Nuevo Módulo: Control de Usuarios -->
                <div id="module-control-usuarios" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Control de Usuarios</h2>
                    </div>

                    <div class="flex justify-between items-center mb-2.5">
                        <div class="radio-group">
                            <label><input type="radio" name="user_status_filter" value="todos" checked onchange="renderUsersTable()"><span>Todos</span></label>
                            <label><input type="radio" name="user_status_filter" value="Activo" onchange="renderUsersTable()"><span>Activos</span></label>
                            <label><input type="radio" name="user_status_filter" value="Inactivo" onchange="renderUsersTable()"><span>Inactivos</span></label>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="generateHistoricalAccessReport()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Reporte Histórico de Accesos
                            </button>
                            <button type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="openUserModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                                    <path d="M12 5v14"/><path d="M5 12h14"/>
                                </svg>
                                Agregar Usuario
                            </button>
                        </div>
                    </div>

                    <div class="mb-2.5 flex items-center gap-2">
                        <input type="text" id="user-search-input" class="w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-xs" placeholder="Buscar por siglas, nombre de institución o nombre de usuario..." onkeyup="renderUsersTable()">
                        <button type="button" onclick="clearUserSearchFilter()" class="flex-shrink-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" title="Limpiar filtro">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                            Limpiar
                        </button>
                    </div>

                    <div class="data-table-container">
                        <table class="data-table" id="users-table">
                            <thead>
                                <tr>
                                    <th class="text-center-col">Siglas Institución</th>
                                    <th>Nombre Institución</th>
                                    <th>Nombre</th> 
                                    <th>Perfil</th>
                                    <th class="text-center-col">Usuario</th>
                                    <th class="text-center-col">Contraseña</th>
                                    <th class="text-center-col">Estatus</th>
                                    <th>Correo</th>
                                    <th>Teléfono</th>
                                    <th>Tipo Usuario</th>
                                    <th>Cargo</th>
                                    <th class="text-center-col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal para Agregar/Editar Usuario -->
                <div id="user-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content">
                        <button class="modal-close-button" onclick="closeUserModal()">&times;</button>
                        <h3 class="modal-header" id="user-modal-title">Agregar Usuario</h3>
                        <form id="user-form">
                            <input type="hidden" id="user-id-edit">

                            <div class="modal-form-group">
                                <label for="user-estatus">Estatus</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="user-estatus" value="Activo" checked><span>Activo</span></label>
                                    <label><input type="radio" name="user-estatus" value="Inactivo"><span>Inactivo</span></label>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="user-tipo-usuario" style="min-width: 120px;">Tipo Usuario</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="user-tipo-usuario" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required></select>
                                </div>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="user-perfil" style="min-width: 120px;">Perfil</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="user-perfil" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required></select>
                                </div>
                            </div>
                             <div class="modal-form-group">
                                <label for="user-siglas-institucion-filter">Siglas Institución</label>
                                <div class="institution-filter-container">
                                    <input type="text" id="user-siglas-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off" required>
                                    <input type="hidden" id="user-siglas-institucion-id">
                                    <div id="user-siglas-institucion-suggestions" class="institution-suggestions hidden"></div>
                                </div>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-nombre">Nombre</label>
                                <input type="text" id="user-nombre" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                            </div>
                            <div class="modal-form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                <label for="user-cargo" style="min-width: 120px;">Cargo</label>
                                <div class="flex-grow flex items-center gap-2">
                                    <select id="user-cargo" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required></select>
                                    <button type="button" class="edit-list-button" onclick="openEditListModal('cargo')">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                            <path d="M15 5l4 4"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-no-oficio">No. de Oficio de Designación</label>
                                <input type="text" id="user-no-oficio" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                            </div>
                            <div class="modal-form-group">
                                <label for="user-file-upload">Cargar Archivo</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="user-file-name" class="flex-grow px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" placeholder="Ningún archivo seleccionado" readonly>
                                    <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-2 rounded-md text-xs" onclick="document.getElementById('user-file-input').click()">
                                        Examinar
                                    </button>
                                    <input type="file" id="user-file-input" class="hidden" onchange="document.getElementById('user-file-name').value = this.files[0] ? this.files[0].name : ''">
                                </div>
                            </div>
                            <div class="modal-form-group">
                                <label for="user-correo">Correo</label>
                                <input type="email" id="user-correo" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                            </div>
                            <div class="modal-form-group">
                                <label for="user-telefono">Teléfono</label>
                                <input type="text" id="user-telefono" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs">
                            </div>

                            <div class="credentials-box">
                                <h4 class="text-sm font-bold mb-3">Credenciales de Acceso</h4>
                                <div class="modal-form-group">
                                    <label for="user-clave">Nombre de Usuario</label>
                                    <input type="text" id="user-clave" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" required>
                                </div>
                                <div class="modal-form-group">
                                    <label for="user-password">Contraseña</label>
                                    <input type="password" id="user-password" class="w-full px-2 py-0.5 border border-gray-300 rounded-md shadow-sm text-xs" placeholder="**********" required>
                                </div>
                            </div>

                            <div class="modal-buttons">
                                <button type="button" class="btn-cancel" onclick="closeUserModal()">Cancelar</button>
                                <button type="submit" class="btn-save">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Modal para Reporte de Acceso de Usuario -->
                <div id="user-access-report-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content period-program-modal-content">
                        <button class="modal-close-button" onclick="closeUserAccessReportModal()">&times;</button>
                        <h3 class="modal-header">Reporte de Acceso para: <span id="report-user-name"></span> (<span id="report-user-clave"></span>)</h3>
                        <div class="flex justify-end mb-2">
                             <button type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-lg shadow-md transition duration-300 ease-in-out flex items-center gap-1 text-xs" onclick="downloadUserAccessReport()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                                Descargar CSV
                            </button>
                        </div>
                        <div class="data-table-container">
                            <table class="data-table" id="user-access-report-table">
                                <thead>
                                    <tr>
                                        <th class="text-center-col">Año</th>
                                        <th class="text-center-col">Siglas</th>
                                        <th class="text-center-col">Clave de Usuario</th>
                                        <th class="text-center-col">Fecha de Acceso</th>
                                        <th class="text-center-col">Hora de Inicio</th>
                                        <th class="text-center-col">Hora de Cierre</th>
                                        <th class="text-center-col">Duración (min)</th>
                                        <th>Módulo Accedido</th>
                                        <th>Acción Realizada</th>
                                        <th>Campo Modificado</th>
                                        <th>Tipo de Evento</th>
                                        <th>Resultado</th>
                                        <th>Dirección IP</th>
                                        <th>Agente de Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="user-access-report-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- MEJORA 3: Módulo: Modifica Avance Trimestral AM actualizado -->
                <div id="module-modifica-avance-am" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Modifica Avance Trimestral AM</h2>
                    </div>
                    <form action="#" method="post" class="space-y-2.5">
                        <div class="form-field-group row-layout">
                            <label for="am-periodo-select">Periodo</label>
                            <div class="select-wrapper flex-grow">
                                <select id="am-periodo-select" class="w-full">
                                    <!-- Opciones de periodo se cargarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="am-institucion-filter">Institución</label>
                            <div class="institution-filter-container flex-grow">
                                <input type="text" id="am-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off">
                                <input type="hidden" id="am-institucion-id" name="institucion_id">
                                <button type="button" onclick="clearAMInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                </button>
                                <div id="am-institucion-suggestions" class="institution-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="btn-visualizar" onclick="renderAvanceAMTable()">Visualizar</button>
                        </div>
                    </form>

                    <div class="data-table-container">
                        <table class="data-table" id="avance-am-table">
                            <thead>
                                <tr>
                                    <th>Periodo</th>
                                    <th>No.</th>
                                    <th>Actividad (s) Realizada (s)</th>
                                    <th class="quarter-header">1T</th>
                                    <th class="quarter-header">2T</th>
                                    <th class="quarter-header">3T</th>
                                    <th class="quarter-header">4T</th>
                                    <th class="text-center-col">Editar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Datos de la tabla se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MEJORA 2: Modal para Modificar Avance (AM) actualizado -->
                <div id="am-advance-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content advance-modal-content">
                        <button class="modal-close-button" onclick="closeAMAdvanceModal()">&times;</button>
                        <h3 class="modal-header">Modifica Avance</h3>
                        <h4 id="am-advance-modal-subtitle" class="text-center text-sm text-gray-600 -mt-3 mb-4"></h4>
                        
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Primer Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="am-avance-1t" value="0" min="0" max="100" oninput="syncSlider('am-avance-1t', 'am-slider-1t'); calculateAMAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="am-slider-1t" min="0" max="100" value="0" oninput="syncNumberInput('am-slider-1t', 'am-avance-1t'); calculateAMAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Segundo Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="am-avance-2t" value="0" min="0" max="100" oninput="syncSlider('am-avance-2t', 'am-slider-2t'); calculateAMAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="am-slider-2t" min="0" max="100" value="0" oninput="syncNumberInput('am-slider-2t', 'am-avance-2t'); calculateAMAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Tercer Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="am-avance-3t" value="0" min="0" max="100" oninput="syncSlider('am-avance-3t', 'am-slider-3t'); calculateAMAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="am-slider-3t" min="0" max="100" value="0" oninput="syncNumberInput('am-slider-3t', 'am-avance-3t'); calculateAMAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Cuarto Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="am-avance-4t" value="0" min="0" max="100" oninput="syncSlider('am-avance-4t', 'am-slider-4t'); calculateAMAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="am-slider-4t" min="0" max="100" value="0" oninput="syncNumberInput('am-slider-4t', 'am-avance-4t'); calculateAMAccumulated();">
                        </div>

                        <div class="total-row">
                            <label>% Acumulado</label>
                            <span id="am-avance-acumulado">0%</span>
                        </div>
                        <div class="modal-buttons justify-center mt-6">
                            <button type="button" class="btn-save" onclick="saveAMAdvance()">Guardar</button>
                        </div>
                    </div>
                </div>

                <!-- MEJORA 3: Módulo: Modifica Avance Trimestral AC actualizado -->
                <div id="module-modifica-avance-ac" class="module-content hidden">
                    <div class="bg-gray-200 p-1.5 rounded-t-lg text-center mb-2.5">
                        <h2 class="text-sm font-bold text-gray-800">Modifica Avance Trimestral AC</h2>
                    </div>
                    <form action="#" method="post" class="space-y-2.5">
                        <div class="form-field-group row-layout">
                            <label for="ac-periodo-select">Periodo</label>
                            <div class="select-wrapper flex-grow">
                                <select id="ac-periodo-select" class="w-full">
                                    <!-- Opciones de periodo se cargarán dinámicamente -->
                                </select>
                            </div>
                        </div>
                        <div class="form-field-group row-layout">
                            <label for="ac-institucion-filter">Institución</label>
                            <div class="institution-filter-container flex-grow">
                                <input type="text" id="ac-institucion-filter" class="institution-filter-input" placeholder="Buscar institución..." autocomplete="off">
                                <input type="hidden" id="ac-institucion-id" name="institucion_id">
                                <button type="button" onclick="clearACInstitutionFilter()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600" title="Limpiar filtro">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 5H3"/><path d="M10 5a2 2 0 0 1 4 0"/><path d="M12 2v3"/><path d="M3 9h18"/><path d="M18 9l-1.81 10.86a2 2 0 0 1-2 1.14H9.81a2 2 0 0 1-2-1.14L6 9"/></svg>
                                </button>
                                <div id="ac-institucion-suggestions" class="institution-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-3">
                            <button type="button" class="btn-visualizar" onclick="renderAvanceACTable()">Visualizar</button>
                        </div>
                    </form>

                    <div class="data-table-container">
                        <table class="data-table" id="avance-ac-table">
                            <thead>
                                <tr>
                                    <th>Periodo</th>
                                    <th>No.</th>
                                    <th>Actividad (s) Realizada (s)</th>
                                    <th class="quarter-header">1T</th>
                                    <th class="quarter-header">2T</th>
                                    <th class="quarter-header">3T</th>
                                    <th class="quarter-header">4T</th>
                                    <th class="text-center-col">Editar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Datos de la tabla se cargarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MEJORA 2: Modal para Modificar Avance (AC) actualizado -->
                <div id="ac-advance-modal-overlay" class="modal-overlay hidden">
                    <div class="modal-content advance-modal-content">
                        <button class="modal-close-button" onclick="closeACAdvanceModal()">&times;</button>
                        <h3 class="modal-header">Modifica Avance</h3>
                        <h4 id="ac-advance-modal-subtitle" class="text-center text-sm text-gray-600 -mt-3 mb-4"></h4>

                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Primer Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="ac-avance-1t" value="0" min="0" max="100" oninput="syncSlider('ac-avance-1t', 'ac-slider-1t'); calculateACAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="ac-slider-1t" min="0" max="100" value="0" oninput="syncNumberInput('ac-slider-1t', 'ac-avance-1t'); calculateACAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Segundo Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="ac-avance-2t" value="0" min="0" max="100" oninput="syncSlider('ac-avance-2t', 'ac-slider-2t'); calculateACAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="ac-slider-2t" min="0" max="100" value="0" oninput="syncNumberInput('ac-slider-2t', 'ac-avance-2t'); calculateACAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Tercer Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="ac-avance-3t" value="0" min="0" max="100" oninput="syncSlider('ac-avance-3t', 'ac-slider-3t'); calculateACAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="ac-slider-3t" min="0" max="100" value="0" oninput="syncNumberInput('ac-slider-3t', 'ac-avance-3t'); calculateACAccumulated();">
                        </div>
                        <div class="input-group">
                            <div class="label-and-input">
                                <label>Cuarto Trimestre</label>
                                <div class="input-container">
                                    <input type="number" id="ac-avance-4t" value="0" min="0" max="100" oninput="syncSlider('ac-avance-4t', 'ac-slider-4t'); calculateACAccumulated();">
                                    <span>%</span>
                                </div>
                            </div>
                            <input type="range" id="ac-slider-4t" min="0" max="100" value="0" oninput="syncNumberInput('ac-slider-4t', 'ac-avance-4t'); calculateACAccumulated();">
                        </div>

                        <div class="total-row">
                            <label>% Acumulado</label>
                            <span id="ac-avance-acumulado">0%</span>
                        </div>
                        <div class="modal-buttons justify-center mt-6">
                            <button type="button" class="btn-save" onclick="saveACAdvance()">Guardar</button>
                        </div>
                    </div>
                </div>

                <!-- Módulo 'Procesos Registrados x Oficio' eliminado -->
                <!-- Módulo 'Registro de Acciones de Usuarios' eliminado -->
                <div id="module-comunicados" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Comunicados</h2>
                    <!-- Código para el módulo 'Comunicados' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-acciones-mejora-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Mejora</h2>
                    <!-- Código para el módulo 'Reporte: Acciones de Mejora' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-acciones-control-reporte" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte: Acciones de Control</h2>
                    <!-- Código para el módulo 'Reporte: Acciones de Control' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-seguimiento-trimestral" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Seguimiento Trimestral</h2>
                    <!-- Código para el módulo 'Reporte Seguimiento Trimestral' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-conclusion" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Conclusión</h2>
                    <!-- Código para el módulo 'Conclusión' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-consolidado" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Consolidado</h2>
                    <!-- Código para el módulo 'Consolidado' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-reporte-acciones-mejora" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte Acciones Mejora</h2>
                    <!-- Código para el módulo 'Reporte Acciones Mejora' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-reporte-ptci-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Reporte PTCI y PTAR (Excel)</h2>
                    <!-- Código para el módulo 'Reporte PTCI y PTAR (Excel)' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-evaluacion-oic" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Evaluación de OIC (Excel)</h2>
                    <!-- Código para el módulo 'Evaluación de OIC (Excel)' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-acciones-mejora-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Mejora por Trimestre</h2>
                    <!-- Código para el módulo 'Acciones Mejora por Trimestre' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-acciones-control-trimestre" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Acciones Control Trimestral</h2>
                    <!-- Código para el módulo 'Acciones Control Trimestral' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-imprimir-ptci" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Control Interno</h2>
                    <!-- Código para el módulo 'Imprimir Programa de Trabajo de Control Interno' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-imprimir-ptar" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Imprimir Programa de Trabajo de Administración de Riesgo</h2>
                    <!-- Código para el módulo 'Imprimir Programa de Trabajo de Administración de Riesgo' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>
                <div id="module-cambiar-contrasena" class="module-content hidden">
                    <h2 class="text-base font-bold text-center mb-3 text-gray-800">Cambiar Contraseña</h2>
                    <!-- Código para el módulo 'Cambiar Contraseña' irá aquí. -->
                    <!-- Este espacio está reservado para la implementación futura de la lógica y la interfaz de usuario. -->
                </div>

            </section>
        </div>

        <footer class="footer-container">
            <label>Insurgentes Sur 1735, Col. Guadalupe Inn Ciudad de México., C.P 01020 - Tel. 2000 3000</label>
            <br>
            <label>Secretaría Anticorrupción y Buen Gobierno, México - algunos derechos reservados © 2025 </label>
        </footer>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content custom-modal-content">
            <h3 class="modal-header">Mensaje del Sistema</h3>
            <p id="custom-alert-message"></p>
            <div class="modal-buttons justify-center">
                <button type="button" class="btn-save" onclick="closeAlertModal()">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content custom-modal-content">
            <h3 class="modal-header">Confirmación Requerida</h3>
            <p id="custom-confirm-message"></p>
            <div class="modal-buttons justify-center">
                <button type="button" class="btn-cancel" onclick="handleConfirmNo()">No</button>
                <button type="button" class="btn-save" onclick="handleConfirmYes()">Sí</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS Y ESTADO GLOBAL ---
        // Datos iniciales para instituciones. En un entorno de producción, estos datos se cargarían desde una base de datos.
        const initialInstitutionsData = [
            { id: '224', siglas: 'APBP', nombre: 'Administración del Patrimonio de la Beneficencia Pública', tipo: 'Organismo Descentralizado', sector: '12 SALUD', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '310', siglas: 'ASIPONA ACAPULCO', nombre: 'Administración del Sistema Portuario Nacional Acapulco, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '44', siglas: 'ASIPONA ALTAMIRA', nombre: 'Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '312', siglas: 'ASIPONA SAN LUCAS', nombre: 'Administración del Sistema Portuario Nacional Cabo San Lucas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '45', siglas: 'ASIPONA COATZACOALCOS', nombre: 'Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '46', siglas: 'ASIPONA DOS BOCAS', nombre: 'Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '47', siglas: 'ASIPONA ENSENADA', nombre: 'Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '48', siglas: 'ASIPONA GUAYMAS', nombre: 'Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '49', siglas: 'ASIPONA LÁZARO CÁRDENAS', nombre: 'Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: '50', siglas: 'ASIPONA MANZANILLO', nombre: 'Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.', tipo: 'Empresa de Participación Estatal Mayoritaria', sector: '09 Infraestructura, Comunicaciones y Transportes', estatus: 'Activa', ptciActualizado: 'No' },
            { id: '999', siglas: 'IPPR', nombre: 'Institución de Prueba para el Reporte', tipo: 'Dependencia', sector: '99 Entidad no Coordinada Sectorialmente', estatus: 'Activa', ptciActualizado: 'Sí' },
            // NUEVOS REGISTROS DE EJEMPLO PARA REPORTE DE AVANCE INSTITUCIONAL
            { id: 'REP01', siglas: 'INST_REP1', nombre: 'Institución de Reporte Ejemplo 1', tipo: 'Organismo Descentralizado', sector: '11 Educación Pública', estatus: 'Activa', ptciActualizado: 'Sí' },
            { id: 'REP02', siglas: 'INST_REP2', nombre: 'Institución de Reporte Ejemplo 2', tipo: 'Dependencia', sector: '12 SALUD', estatus: 'Activa', ptciActualizado: 'No' }
        ];

        // Listas de opciones predefinidas para los selects.
        let defaultTipoInstitucion = [
            "Dependencia", "Órgano Administrativo Desconcentrado", "Organismo Descentralizado",
            "Empresa de Participación Estatal Mayoritaria", "Organismo Descentralizado No Sectorizado",
            "Fideicomiso Público", "Fideicomiso Público que forma parte del Sistema Financiero Mexicano",
            "Organismo Autónomo"
        ];

        let defaultSector = [
            "04 Gobernación", "05 Relaciones Exteriores", "06 Hacienda y Crédito Público",
            "07 Defensa Nacional", "08 Agricultura y Desarrollo Rural", "09 Infraestructura, Comunicaciones y Transportes",
            "10 Economía", "11 Educación Pública", "12 Salud", "13 Marina",
            "14 Trabajo y Previsión Social", "15 Desarrollo Agrario, Territorial y Urbano",
            "16 Medio Ambiente y Recursos Naturales", "17 Procuraduría General de la República",
            "18 Energía", "20 Bienestar", "21 Turismo",
            "25 Previsiones y Aportaciones para los Sistemas de Educación Básica, Normal, Tecnológica y de Adultos",
            "27 Función Pública", "36 Seguridad y Protección Ciudadana",
            "37 Consejería Jurídica del Ejecutivo Federal", "45 Comisión Reguladora de Energía",
            "46 Comisión Nacional de Hidrocarburos", "47 Entidades no Sectorizadas", "48 Cultura",
            "49 Fiscalía General de la República", "55 Agencia de Transformación Digital y Telecomunicaciones",
            "99 Entidad no Coordinada Sectorialmente"
        ];

        // Definición de las categorías y acciones disponibles para la programación de periodos.
        const availableActionsCategories = {
            "Evaluación Institución": ["Habilitar edición de procesos prioritarios y PTCI actualizado", "Habilitar evaluación del SCII", "Habilitar Captura de Informe Anual Finalizado"],
            "PTCI": ["Habilitar Captura del PTCI", "Habilitar captura del PTCI Actualizado", "Habilitar captura Seguimiento AM", "Habilitar captura Reporte Trimestral AM"],
            "PTAR": ["Habilitar captura Riesgos en el periodo", "Habilitar captura Seguimiento de AC", "Habilitar captura Reporte Trimestral AC"],
            "Evaluación OIC": ["Habilitar evaluación del OIC", "Habilitar OIC-Seguimiento de Acciones Mejora", "Habilitar OIC-Reporte Trimestral AM", "Habilitar OIC-Seguimiento de Acciones Control", "Habilitar OIC-Reporte Trimestral AC"]
        };

        // Datos iniciales para usuarios. Incluye el usuario por defecto para el login.
        const initialUsersData = [
            { id: 'user1', clave: 'admin_user', password: 'password123', nombre: 'Administrador Principal', perfil: 'Coordinador de Control Interno', estatus: 'Activo', correo: 'admin.user@example.com', telefono: '5511112222', tipoUsuario: 'Interno', cargo: 'Director General', siglasInstitucion: 'APBP', noOficioDesignacion: 'OF-001-2024' },
            { id: 'user2', clave: 'maria_g', password: 'password123', nombre: 'María García', perfil: 'Instancia de Control Interno', estatus: 'Activo', correo: 'maria.garcia@example.com', telefono: '5587654321', tipoUsuario: 'Interno', cargo: 'Jefe de Departamento', siglasInstitucion: 'ASIPONA ACAPULCO', noOficioDesignacion: 'OF-002-2024' },
            { id: 'user3', clave: 'carlos_l', password: 'password123', nombre: 'Carlos López', perfil: 'Riesgos', estatus: 'Inactivo', correo: 'carlos.lopez@example.com', telefono: '5511223344', tipoUsuario: 'Externo', cargo: 'Consultor', siglasInstitucion: 'ASIPONA ALTAMIRA', noOficioDesignacion: 'N/A' },
            { id: 'user4', clave: 'ana_d', password: 'password123', nombre: 'Ana Díaz', perfil: 'Coordinador de Control Interno', estatus: 'Activo', correo: 'ana.diaz@example.com', telefono: '5599887766', tipoUsuario: 'Interno', cargo: 'Subdirector', siglasInstitucion: 'ASIPONA COATZACOALCOS', noOficioDesignacion: 'OF-004-2024' },
        ];

        // Datos iniciales para los registros de acceso de usuarios.
        const initialUserAccessLogs = [
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-20', horaInicio: '09:00:00', horaCierre: '09:30:00', duracionSesion: 30, moduloAccedido: 'Consulta Instituciones', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-20', horaInicio: '09:30:00', horaCierre: '09:35:00', duracionSesion: 5, moduloAccedido: 'Catálogo Instituciones', accionRealizada: 'Modificación', campoModificado: 'Institución APBP', tipoEvento: 'Cierre', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user2', year: 2024, siglas: 'ASIPONA ACAPULCO', claveUsuario: 'maria_g', fechaAcceso: '2024-07-21', horaInicio: '10:15:00', horaCierre: '10:45:00', duracionSesion: 30, moduloAccedido: 'Programación de periodos', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.101', agenteUsuario: 'Firefox on macOS' },
            { userId: 'user3', year: 2024, siglas: 'ASIPONA ALTAMIRA', claveUsuario: 'carlos_l', fechaAcceso: '2024-07-22', horaInicio: '11:00:00', horaCierre: '11:01:00', duracionSesion: 1, moduloAccedido: 'Login', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Error', resultado: 'Fallo (Contraseña incorrecta)', direccionIP: '192.168.1.102', agenteUsuario: 'Edge on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-23', horaInicio: '08:00:00', horaCierre: '08:45:00', duracionSesion: 45, moduloAccedido: 'Control de Usuarios', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user1', year: 2024, siglas: 'APBP', claveUsuario: 'admin_user', fechaAcceso: '2024-07-23', horaInicio: '08:45:00', horaCierre: '08:50:00', duracionSesion: 5, moduloAccedido: 'Control de Usuarios', accionRealizada: 'Modificación', campoModificado: 'Usuario U001', tipoEvento: 'Cierre', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user4', year: 2024, siglas: 'ASIPONA COATZACOALCOS', claveUsuario: 'ana_d', fechaAcceso: '2024-07-24', horaInicio: '14:00:00', horaCierre: '14:10:00', duracionSesion: 10, moduloAccedido: 'Reporte de Avance Institucional', accionRealizada: 'Ninguna', campoModificado: 'N/A', tipoEvento: 'Inicio', resultado: 'Éxito', direccionIP: '192.168.1.103', agenteUsuario: 'Safari on iOS' },
            // Nuevos logs para las instituciones de ejemplo en el reporte de avance institucional
            { userId: 'user1', year: 2024, siglas: 'INST_REP1', claveUsuario: 'admin_user', fechaAcceso: '2024-07-25', horaInicio: '10:00:00', horaCierre: '10:15:00', duracionSesion: 15, moduloAccedido: 'Reporte de Avance Institucional', accionRealizada: 'Visualización', campoModificado: 'N/A', tipoEvento: 'Consulta', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' },
            { userId: 'user1', year: 2024, siglas: 'INST_REP2', claveUsuario: 'admin_user', fechaAcceso: '2024-07-25', horaInicio: '10:20:00', horaCierre: '10:30:00', duracionSesion: 10, moduloAccedido: 'Reporte de Avance Institucional', accionRealizada: 'Visualización', campoModificado: 'N/A', tipoEvento: 'Consulta', resultado: 'Éxito', direccionIP: '192.168.1.100', agenteUsuario: 'Chrome on Windows' }
        ];

        // Listas de opciones para los campos de usuario.
        let defaultPerfiles = ["Coordinador de Control Interno", "Instancia de Control Interno", "Riesgos", "Consulta"];
        let defaultTiposUsuario = ["Interno", "OR"];
        let defaultCargos = ["Director General", "Director de Área", "Subdirector", "Jefe de Departamento", "Analista", "Consultor"];
        const defaultAccionesRealizadas = ["Ninguna", "Modificación", "Eliminación", "Agregación"];
        const defaultTiposEvento = ["Inicio", "Cierre", "Error"];


        // Carga de datos desde localStorage o uso de datos iniciales.
        let institutions = JSON.parse(localStorage.getItem('institutions_v11_1_1')) || initialInstitutionsData;
        let tipoInstitucionList = JSON.parse(localStorage.getItem('tipoInstitucionList_v11_1_1')) || defaultTipoInstitucion;
        let sectorList = JSON.parse(localStorage.getItem('sectorList_v11_1_1')) || defaultSector;
        let programmedPeriods = JSON.parse(localStorage.getItem('programmedPeriods_v11_1_1')) || [];
        let programmedPeriodsHistory = JSON.parse(localStorage.getItem('programmedPeriodsHistory_v11_1_1')) || {};

        // Añadir datos de ejemplo para las nuevas instituciones en el reporte de avance institucional
        const exampleProgrammedPeriods = [
            {
                institucionId: 'REP01',
                periodo: '2024',
                trimestre: '2T',
                fechaInicio: '2024-04-01',
                fechaFin: '2024-06-30',
                accionesPermitidas: ["Habilitar evaluación del SCII", "Habilitar Captura del PTCI"]
            },
            {
                institucionId: 'REP02',
                periodo: '2024',
                trimestre: '2T',
                fechaInicio: '2024-04-01',
                fechaFin: '2024-06-30',
                accionesPermitidas: ["Habilitar evaluación del SCII"]
            }
        ];
        // Merge example programmed periods with existing ones, avoiding duplicates based on institutionId and period/trimestre
        exampleProgrammedPeriods.forEach(newPeriod => {
            const exists = programmedPeriods.some(existingPeriod =>
                existingPeriod.institucionId === newPeriod.institucionId &&
                existingPeriod.periodo === newPeriod.periodo &&
                existingPeriod.trimestre === newPeriod.trimestre
            );
            if (!exists) {
                programmedPeriods.push(newPeriod);
            }
        });


        let users = JSON.parse(localStorage.getItem('users_v11_1_1')) || initialUsersData;
        let userAccessLogs = JSON.parse(localStorage.getItem('userAccessLogs_v11_1_1')) || initialUserAccessLogs;

        // Nuevas variables para las listas editables de usuario
        let perfilesList = JSON.parse(localStorage.getItem('perfilesList_v11_1_1')) || defaultPerfiles;
        let tiposUsuarioList = JSON.parse(localStorage.getItem('tiposUsuarioList_v11_1_1')) || defaultTiposUsuario;
        let cargosList = JSON.parse(localStorage.getItem('cargosList_v11_1_1')) || defaultCargos;

        // Datos para los módulos de avance trimestral (AM y AC)
        let avanceAMData = JSON.parse(localStorage.getItem('avanceAMData_v1_6')) || [
            { id: 'am1', actividad: 'Difundir al personal de la entidad los objetivos, misión y visión.', avances: { '1T': 96, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'am2', actividad: 'Confirmar con el funcionamiento del Código de Ética y Prevención de conflictos de interés.', avances: { '1T': 10, '2T': 30, '3T': 60, '4T': 0 } },
            { id: 'am3', actividad: 'Modernizar el microciclo con acceso a todo el personal para mejor difusión de las actividades del Comité.', avances: { '1T': 20, '2T': 0, '3T': 50, '4T': 0 } },
            { id: 'am4', actividad: 'Definir y ejecutar el programa que resulte de la encargada de clima y cultura organizacional con la intervención de los titulares de las áreas, para establecer compromisos reales.', avances: { '1T': 0, '2T': 30, '3T': 50, '4T': 30 } },
            { id: 'am5', actividad: 'Actualizar y difundir los perfiles de puestos.', avances: { '1T': 20, '2T': 30, '3T': 40, '4T': 20 } },
            { id: 'am6', actividad: 'Revisión y en su caso actualización del procedimiento asignación y seguimiento de contratos de cesión parcial de derechos y de prestación de servicios portuarios', avances: { '1T': 0, '2T': 0, '3T': 50, '4T': 50 } },
            { id: 'am7', actividad: 'Dar seguimiento a las acciones comprometidas en el PTAR-2024.', avances: { '1T': 30, '2T': 40, '3T': 0, '4T': 0 } },
            { id: 'am8', actividad: 'Se realizarán reuniones con la alta dirección para exponer la cartera de proyectos al inicio del año y al cierre del programa se realizará reunión para informar del estado final de los proyectos definidos.', avances: { '1T': 50, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'am9', actividad: 'Difundir los medios para el registro, atención y respuesta de quejas y denuncias ante el Comité de Ética y de Prevención de Conflictos de Interés.', avances: { '1T': 30, '2T': 70, '3T': 0, '4T': 0 } },
            { id: 'am10', actividad: 'Nueva Actividad de Mejora de Ejemplo', avances: { '1T': 0, '2T': 0, '3T': 0, '4T': 0 } }
        ];

        let avanceACData = JSON.parse(localStorage.getItem('avanceACData_v1_6')) || [
            { id: 'ac1', actividad: 'Difusión interna y seguimiento puntual del procedimiento ADMN-DBO-GAF-P-00-010 Adquisiciones.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac2', actividad: 'Emisión de circular a las áreas requirentes en relación a la correcta aplicación del procedimiento de adquisiciones.', avances: { '1T': 20, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac3', actividad: 'Ajuste en costos operativos y administrativos (verificación de contratos de servicios, ajustes en viáticos, ajuste de bienes de uso recurrente).', avances: { '1T': 100, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac4', actividad: 'Ajuste en asignación de combustible para vehículos operativos y de oficina.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac5', actividad: 'Mantenimientos prioritarios a los bienes muebles e inmuebles.', avances: { '1T': 20, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac6', actividad: 'Buscar alternativas de otros mercados que no sea gasolineras.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac7', actividad: 'Establecer acuerdos para recuperar la cobranza de los clientes que no pueden pagar en los plazos establecidos en su contrato vigente.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac8', actividad: 'Generar los reportes por daños a la infraestructura portuaria.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac9', actividad: 'Generar los reportes de salidas no conformes.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac10', actividad: 'Atención y seguimiento a los daños ocasionados a la infraestructura.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac11', actividad: 'Modificaciones a los programas de obra pública a partir de que se tenga la disponibilidad del recurso.', avances: { '1T': 25, '2T': 0, '3T': 0, '4T': 0 } },
            { id: 'ac12', actividad: 'Nueva Actividad de Control de Ejemplo', avances: { '1T': 0, '2T': 0, '3T': 0, '4T': 0 } }
        ];

        let currentEditingAdvanceItem = null; // Para guardar el item que se está editando en el modal de avance.
        let currentAdvanceType = ''; // 'AM' o 'AC'

        // Variables de estado temporales para la UI.
        let selectedInstitutionsForProgramacion = [];
        let currentEditingListType = '';
        let confirmCallback = null; // Para el modal de confirmación personalizado.

        // --- FUNCIONES DE MODALES PERSONALIZADOS (ALERTA Y CONFIRMACIÓN) ---
        /**
         * Muestra un modal de alerta personalizado con un mensaje dado.
         * @param {string} message - El mensaje a mostrar en la alerta.
         */
        function showAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            document.getElementById('custom-alert-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal de alerta personalizado.
         */
        function closeAlertModal() {
            document.getElementById('custom-alert-modal-overlay').classList.add('hidden');
        }

        /**
         * Muestra un modal de confirmación personalizado con un mensaje y un callback.
         * @param {string} message - El mensaje a mostrar en la confirmación.
         * @param {function} callback - La función a ejecutar si el usuario confirma.
         */
        function showConfirm(message, callback) {
            document.getElementById('custom-confirm-message').textContent = message;
            confirmCallback = callback; // Almacena el callback para su ejecución posterior.
            document.getElementById('custom-confirm-modal-overlay').classList.remove('hidden');
        }

        /**
         * Maneja la acción de "Sí" en el modal de confirmación.
         * Ejecuta el callback almacenado y cierra el modal.
         */
        function handleConfirmYes() {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        }

        /**
         * Maneja la acción de "No" en el modal de confirmación.
         * Simplemente cierra el modal sin ejecutar el callback.
         */
        function handleConfirmNo() {
            closeConfirmModal();
        }

        /**
         * Cierra el modal de confirmación personalizado.
         */
        function closeConfirmModal() {
            document.getElementById('custom-confirm-modal-overlay').classList.add('hidden');
            confirmCallback = null; // Limpia el callback.
        }


        // --- INICIALIZACIÓN Y NAVEGACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicialmente muestra la página de login.
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');

            setupEventListeners();
            populateActionFilters();
            populateAperturarModalActions();
            populateModalSelects();
            populateUserModalSelects(); 
            populateAvancePeriodoSelects(); 

            // Asegura que el primer módulo de la barra lateral esté expandido por defecto.
            const firstModuleHeader = document.querySelector('.sidebar .module-header');
            if (firstModuleHeader && firstModuleHeader.classList.contains('collapsed')) {
                firstModuleHeader.classList.remove('collapsed');
                const firstSubmoduleList = firstModuleHeader.nextElementSibling;
                if (firstSubmoduleList && firstSubmoduleList.classList.contains('submodule-list')) {
                    firstSubmoduleList.classList.remove('hidden');
                }
            }
        });

        /**
         * Función para manejar el acceso al sistema (login).
         * Valida las credenciales y redirige o muestra un error.
         */
        function accessSystem() {
            const usernameInput = document.getElementById('username-login').value;
            const passwordInput = document.getElementById('password-login').value;

            // Busca el usuario en la lista de usuarios.
            const authenticatedUser = users.find(u => u.clave === usernameInput && u.password === passwordInput);

            if (authenticatedUser) {
                // Si las credenciales son correctas, oculta la página de login y muestra la aplicación principal.
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                // Registra el login exitoso.
                logUserAccess(authenticatedUser.id, authenticatedUser.siglasInstitucion, authenticatedUser.clave, 'Login', 'Ninguna', 'N/A', 'Inicio', 'Éxito');
                // Activa el módulo de "Consulta Instituciones" por defecto.
                const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
                showModule('consulta-instituciones', consultaInstitucionesLink);
            } else {
                // Si las credenciales son incorrectas, muestra una alerta y registra el intento fallido.
                showAlert('Usuario o contraseña incorrectos.');
                logUserAccess('N/A', 'N/A', usernameInput, 'Login', 'Ninguna', 'N/A', 'Error', 'Fallo (Contraseña incorrecta)');
            }
        }

        /**
         * Función para cerrar sesión y volver a la pantalla de login.
         * @param {Event} event - El evento del click.
         */
        function logout(event) {
            event.preventDefault();
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            const currentUser = users.find(u => u.clave === document.getElementById('username-login').value);
            if (currentUser) {
                logUserAccess(currentUser.id, currentUser.siglasInstitucion, currentUser.clave, 'Login', 'Ninguna', 'N/A', 'Cierre', 'Éxito');
            }
        }

        /**
         * Función para navegar a la pantalla de inicio (Consulta Instituciones).
         * @param {Event} event - El evento del click.
         */
        function goHome(event) {
            event.preventDefault();
            const consultaInstitucionesLink = document.querySelector('.sidebar .submodule-list li a');
            showModule('consulta-instituciones', consultaInstitucionesLink);
        }

        /**
         * Abre el modal de información.
         */
        function openInfoModal() {
            document.getElementById('info-modal').classList.remove('hidden');
        }

        /**
         * Cierra el modal de información.
         */
        function closeInfoModal() {
            document.getElementById('info-modal').classList.add('hidden');
        }

        /**
         * Muestra el contenido de un módulo específico y actualiza el estado de la barra lateral.
         * @param {string} moduleId - El ID del módulo a mostrar (ej. 'consulta-instituciones').
         * @param {HTMLElement} clickedElement - El elemento de la barra lateral que fue clickeado.
         */
        function showModule(moduleId, clickedElement) {
            const currentModuleId = document.querySelector('.module-content:not(.hidden)')?.id;
            if (currentModuleId === 'module-programacion-periodos' && moduleId !== 'programacion-periodos') {
                selectedInstitutionsForProgramacion = []; 
                const allCheckboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = false; 
                    checkbox.closest('tr').classList.remove('selected'); 
                });
                updateUiPostSelection(); 
            }

            document.querySelectorAll('.module-content').forEach(module => module.classList.add('hidden'));
            const targetModule = document.getElementById('module-' + moduleId);
            if (targetModule) {
                targetModule.classList.remove('hidden');
                if (moduleId === 'catalogo-instituciones') {
                    renderInstitutionsTable();
                    populateModalSelects();
                    document.getElementById('catalogo-institucion-filter').value = '';
                    document.getElementById('catalogo-institucion-id').value = '';
                } else if (moduleId === 'programacion-periodos') {
                    renderProgramacionPeriodosTable();
                } else if (moduleId === 'reporte-avance-institucional') {
                    renderReporteAvanceInstitucionalTable();
                } else if (moduleId === 'control-usuarios') {
                    renderUsersTable(); 
                    document.getElementById('user-search-input').value = '';
                    document.querySelector('input[name="user_status_filter"][value="todos"]').checked = true;
                } else if (moduleId === 'modifica-avance-am') {
                    populateAvancePeriodoSelects();
                    document.getElementById('am-institucion-filter').value = '';
                    document.getElementById('am-institucion-id').value = '';
                    renderAvanceAMTable();
                } else if (moduleId === 'modifica-avance-ac') {
                    populateAvancePeriodoSelects();
                    document.getElementById('ac-institucion-filter').value = '';
                    document.getElementById('ac-institucion-id').value = '';
                    renderAvanceACTable();
                }
            }
            document.querySelectorAll('.sidebar .submodule-list li').forEach(li => li.classList.remove('active-item'));
            if (clickedElement) {
                const parentLi = clickedElement.closest('li');
                if (parentLi) parentLi.classList.add('active-item');

                let parentUl = clickedElement.closest('.submodule-list');
                if (parentUl && parentUl.classList.contains('hidden')) {
                    parentUl.classList.remove('hidden');
                    let header = parentUl.previousElementSibling;
                    if (header && header.classList.contains('module-header')) {
                        header.classList.remove('collapsed');
                    }
                }
            }
        }

        /**
         * Alterna la visibilidad de los submódulos en la barra lateral.
         * @param {HTMLElement} headerElement - El encabezado del módulo clickeado.
         */
        function toggleSubmodules(headerElement) {
            headerElement.nextElementSibling.classList.toggle('hidden');
            headerElement.classList.toggle('collapsed');
        }

        /**
         * Configura los event listeners para los campos de filtro de institución.
         */
        function setupEventListeners() {
            const consultaInput = document.getElementById('consulta-institucion-filter');
            if(consultaInput) {
                consultaInput.addEventListener('input', () => handleInstitutionFilter(consultaInput.value, 'consulta-institucion', institutions));
                consultaInput.addEventListener('click', () => handleInstitutionFilter('', 'consulta-institucion', institutions, true));
            }

            const estatusRadios = document.querySelectorAll('#module-consulta-instituciones input[name="estatus"]');
            estatusRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    const input = document.getElementById('consulta-institucion-filter');
                    const hiddenIdInput = document.getElementById('consulta-institucion-id');
                    input.value = '';
                    hiddenIdInput.value = '';
                    document.getElementById('consulta-institucion-suggestions').classList.add('hidden');
                });
            });

            const programacionInput = document.getElementById('programacion-institucion-filter');
            if(programacionInput) {
                programacionInput.addEventListener('input', () => {
                    document.getElementById('programacion-institucion-id').value = '';
                    handleInstitutionFilter(programacionInput.value, 'programacion-institucion', institutions);
                    renderProgramacionPeriodosTable();
                });
                programacionInput.addEventListener('click', () => handleInstitutionFilter('', 'programacion-institucion', institutions, true));
            }

            const catalogoInput = document.getElementById('catalogo-institucion-filter');
            if(catalogoInput) {
                catalogoInput.addEventListener('input', () => {
                    document.getElementById('catalogo-institucion-id').value = '';
                    handleInstitutionFilter(catalogoInput.value, 'catalogo-institucion', institutions);
                    renderInstitutionsTable(); 
                });
                catalogoInput.addEventListener('click', () => handleInstitutionFilter('', 'catalogo-institucion', institutions, true));
            }

            // MEJORA 3: Se eliminan los listeners que actualizaban la tabla automáticamente.
            const amInstitucionInput = document.getElementById('am-institucion-filter');
            if(amInstitucionInput) {
                amInstitucionInput.addEventListener('input', () => {
                    document.getElementById('am-institucion-id').value = '';
                    handleInstitutionFilter(amInstitucionInput.value, 'am-institucion', institutions);
                });
                amInstitucionInput.addEventListener('click', () => handleInstitutionFilter('', 'am-institucion', institutions, true));
            }

            const acInstitucionInput = document.getElementById('ac-institucion-filter');
            if(acInstitucionInput) {
                acInstitucionInput.addEventListener('input', () => {
                    document.getElementById('ac-institucion-id').value = '';
                    handleInstitutionFilter(acInstitucionInput.value, 'ac-institucion', institutions);
                });
                acInstitucionInput.addEventListener('click', () => handleInstitutionFilter('', 'ac-institucion', institutions, true));
            }


            const userModalInstitutionFilter = document.getElementById('user-siglas-institucion-filter');
            if (userModalInstitutionFilter) {
                userModalInstitutionFilter.addEventListener('input', () => handleInstitutionFilter(userModalInstitutionFilter.value, 'user-siglas-institucion', institutions));
                userModalInstitutionFilter.addEventListener('click', () => handleInstitutionFilter('', 'user-siglas-institucion', institutions, true));
            }

            const institutionForm = document.getElementById('institution-form');
            if (institutionForm) {
                institutionForm.addEventListener('submit', handleInstitutionFormSubmit);
            }

            const userForm = document.getElementById('user-form');
            if (userForm) {
                userForm.addEventListener('submit', handleUserFormSubmit);
            }

            document.addEventListener('click', (event) => {
                if (!event.target.closest('.institution-filter-container')) {
                    document.querySelectorAll('.institution-suggestions').forEach(el => el.classList.add('hidden'));
                }
            });
        }

        /**
         * Maneja el filtrado de instituciones y muestra sugerencias.
         * @param {string} filterValue - El texto de búsqueda.
         * @param {string} contextPrefix - El prefijo del ID del elemento (ej. 'consulta-institucion').
         * @param {Array<Object>} data - La lista de instituciones a filtrar.
         * @param {boolean} showAll - Si se deben mostrar todas las sugerencias al hacer clic.
         */
        function handleInstitutionFilter(filterValue, contextPrefix, data, showAll = false) {
            const suggestionsContainer = document.getElementById(`${contextPrefix}-suggestions`);
            if (!suggestionsContainer) {
                console.error(`Error: Elemento con ID ${contextPrefix}-suggestions no encontrado.`);
                return;
            }
            suggestionsContainer.innerHTML = '';
            const lowerCaseFilter = filterValue.toLowerCase();

            let institutionsToFilter = data;
            if (contextPrefix === 'consulta-institucion') {
                const estatusRadio = document.querySelector('#module-consulta-instituciones input[name="estatus"]:checked');
                if (estatusRadio) {
                    const estatusString = estatusRadio.value === '1' ? 'Activa' : 'Inactiva';
                    institutionsToFilter = data.filter(inst => inst.estatus === estatusString);
                }
            } else if (contextPrefix === 'programacion-institucion') {
                institutionsToFilter = data.filter(inst => inst.estatus === 'Activa');
            }

            const filtered = institutionsToFilter.filter(inst =>
                lowerCaseFilter === '' ||
                inst.nombre.toLowerCase().includes(lowerCaseFilter) ||
                inst.siglas.toLowerCase().includes(lowerCaseFilter)
            );

            if (filtered.length > 0 && (lowerCaseFilter.length > 0 || showAll)) {
                suggestionsContainer.classList.remove('hidden');
                filtered.forEach(inst => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = `${inst.siglas} - ${inst.nombre}`;
                    suggestionItem.onmousedown = () => selectInstitution(inst, contextPrefix);
                    suggestionsContainer.appendChild(suggestionItem);
                });
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }

        /**
         * Selecciona una institución de las sugerencias y actualiza el campo de entrada.
         * @param {Object} inst - El objeto de la institución seleccionada.
         * @param {string} contextPrefix - El prefijo del ID del elemento.
         */
        function selectInstitution(inst, contextPrefix) {
            document.getElementById(`${contextPrefix}-filter`).value = `${inst.siglas} - ${inst.nombre}`;
            const hiddenIdInput = document.getElementById(`${contextPrefix}-id`);
            if(hiddenIdInput) {
                hiddenIdInput.value = inst.id;
            }
            document.getElementById(`${contextPrefix}-suggestions`).classList.add('hidden');

            if (contextPrefix === 'user-siglas-institucion') {
                document.getElementById('user-siglas-institucion-id').value = inst.siglas; 
            }

            if (contextPrefix === 'programacion-institucion') {
                renderProgramacionPeriodosTable();
            }
            if (contextPrefix === 'catalogo-institucion') {
                renderInstitutionsTable();
            }
            // MEJORA 3: Se elimina la actualización automática de la tabla al seleccionar institución.
            // La actualización ahora solo se dispara con el botón "Visualizar".
        }

        /**
         * Limpia el filtro de institución en el módulo de Programación de Periodos.
         */
        function clearProgramacionInstitutionFilter() {
            const input = document.getElementById('programacion-institucion-filter');
            const hiddenIdInput = document.getElementById('programacion-institucion-id');

            if (input) {
                input.value = '';
            }
            if (hiddenIdInput) {
                hiddenIdInput.value = ''; 
            }
            renderProgramacionPeriodosTable(); 
        }

        /**
         * Limpia el filtro de institución en el módulo de Consulta Institución.
         */
        function clearConsultaInstitutionFilter() {
            const input = document.getElementById('consulta-institucion-filter');
            const hiddenIdInput = document.getElementById('consulta-institucion-id');

            if (input) {
                input.value = '';
            }
            if (hiddenIdInput) {
                hiddenIdInput.value = ''; 
            }
        }

        /**
         * Limpia el filtro de institución en el módulo de Catálogo de Instituciones.
         */
        function clearCatalogoInstitutionFilter() {
            const input = document.getElementById('catalogo-institucion-filter');
            const hiddenIdInput = document.getElementById('catalogo-institucion-id');

            if (input) {
                input.value = '';
            }
            if (hiddenIdInput) {
                hiddenIdInput.value = ''; 
            }
            renderInstitutionsTable(); 
        }

        /**
         * Limpia el filtro de institución en el módulo de Modifica Avance Trimestral AM.
         */
        function clearAMInstitutionFilter() {
            document.getElementById('am-institucion-filter').value = '';
            document.getElementById('am-institucion-id').value = '';
            renderAvanceAMTable();
        }

        /**
         * Limpia el filtro de institución en el módulo de Modifica Avance Trimestral AC.
         */
        function clearACInstitutionFilter() {
            document.getElementById('ac-institucion-filter').value = '';
            document.getElementById('ac-institucion-id').value = '';
            renderAvanceACTable();
        }

        // --- MÓDULO: CATÁLOGO DE INSTITUCIONES ---
        /**
         * Renderiza la tabla de instituciones.
         */
        function renderInstitutionsTable() {
            const tableBody = document.querySelector('#institutions-catalog-table tbody');
            tableBody.innerHTML = '';

            const catalogoFilterInput = document.getElementById('catalogo-institucion-filter');
            const catalogoFilterText = catalogoFilterInput ? catalogoFilterInput.value.toLowerCase() : '';
            const catalogoFilterId = document.getElementById('catalogo-institucion-id').value; 

            const filteredInstitutions = institutions.filter(inst => {
                const instName = inst.nombre.toLowerCase();
                const instSiglas = inst.siglas.toLowerCase();
                if (catalogoFilterId) {
                    return inst.id === catalogoFilterId;
                } else {
                    return catalogoFilterText === '' || instName.includes(catalogoFilterText) || instSiglas.includes(catalogoFilterText);
                }
            });


            if (filteredInstitutions.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.classList.add('ui-datatable-empty-message');
                noDataRow.innerHTML = `<td colspan="6" class="text-center text-gray-500 py-3">No se encontraron instituciones.</td>`;
                tableBody.appendChild(noDataRow);
                return;
            }

            filteredInstitutions.forEach(inst => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="text-center-col">${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td>${inst.tipo}</td>
                    <td>${inst.sector}</td>
                    <td class="text-center-col">${inst.estatus}</td>
                    <td class="flex gap-1 justify-center text-center-col">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="editInstitution('${inst.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="M15 5l4 4"/>
                            </svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="deleteInstitution('${inst.id}')" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * Popula los selects de tipo de institución y sector en el modal de institución.
         */
        function populateModalSelects() {
            const tipoSelect = document.getElementById('modal-tipo-institucion');
            const sectorSelect = document.getElementById('modal-sector');

            tipoSelect.innerHTML = ''; // Eliminar la opción "Seleccione"
            tipoInstitucionList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                tipoSelect.appendChild(option);
            });
            sectorSelect.innerHTML = ''; // Eliminar la opción "Seleccione"
            sectorList.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                sectorSelect.appendChild(option);
            });
        }

        /**
         * Abre el modal para agregar o editar una institución.
         * @param {string} [institutionId=null] - El ID de la institución a editar. Si es null, se abre para agregar.
         */
        function openInstitutionModal(institutionId = null) {
            const modalOverlay = document.getElementById('institution-modal-overlay');
            const modalTitle = document.getElementById('institution-modal-title');
            const form = document.getElementById('institution-form');
            form.reset(); // Limpia el formulario.

            document.getElementById('institution-id-edit').value = '';
            populateModalSelects(); // Vuelve a poblar los selects para asegurar que estén actualizados.

            if (institutionId) {
                modalTitle.textContent = 'Editar Institución';
                const institutionToEdit = institutions.find(inst => inst.id === institutionId);
                if (institutionToEdit) {
                    document.getElementById('institution-id-edit').value = institutionToEdit.id;
                    document.getElementById('modal-tipo-institucion').value = institutionToEdit.tipo;
                    document.getElementById('modal-sector').value = institutionToEdit.sector;
                    document.getElementById('modal-siglas').value = institutionToEdit.siglas;
                    document.getElementById('modal-institucion-nombre').value = institutionToEdit.nombre;
                    document.querySelector(`input[name="modal-estatus"][value="${institutionToEdit.estatus}"]`).checked = true;
                }
            } else {
                modalTitle.textContent = 'Agregar Institución';
                document.querySelector('input[name="modal-estatus"][value="Activa"]').checked = true; // Por defecto, activa.
            }
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de institución.
         */
        function closeInstitutionModal() {
            document.getElementById('institution-modal-overlay').classList.add('hidden');
        }

        /**
         * Maneja el envío del formulario de institución (agregar/editar).
         * @param {Event} event - El evento del submit.
         */
        function handleInstitutionFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('institution-id-edit').value;
            const tipo = document.getElementById('modal-tipo-institucion').value;
            const sector = document.getElementById('modal-sector').value;
            const siglas = document.getElementById('modal-siglas').value;
            const nombre = document.getElementById('modal-institucion-nombre').value;
            const estatus = document.querySelector('input[name="modal-estatus"]:checked').value;

            if (id) {
                // Edita una institución existente.
                const index = institutions.findIndex(inst => inst.id === id);
                if (index !== -1) {
                    institutions[index] = { ...institutions[index], tipo, sector, siglas, nombre, estatus };
                }
            } else {
                // Agrega una nueva institución.
                const newId = Date.now().toString(); // Genera un ID único.
                institutions.push({ id: newId, tipo, sector, siglas, nombre, estatus, ptciActualizado: 'No' });
            }

            localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
            renderInstitutionsTable(); 
            closeInstitutionModal();
        }

        /**
         * Edita una institución existente.
         * @param {string} id - El ID de la institución a editar.
         */
        function editInstitution(id) {
            openInstitutionModal(id);
        }

        /**
         * Elimina una institución.
         * @param {string} id - El ID de la institución a eliminar.
         */
        function deleteInstitution(id) {
            showConfirm('¿Está seguro de que desea eliminar esta institución?', () => {
                institutions = institutions.filter(inst => inst.id !== id);
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                renderInstitutionsTable(); 
            });
        }

        /**
         * Abre el modal para editar las listas de tipo de institución o sector.
         * @param {string} listType - El tipo de lista a editar ('tipoInstitucion', 'sector', 'perfil', 'tipoUsuario', 'cargo').
         */
        function openEditListModal(listType) {
            currentEditingListType = listType;
            const modalOverlay = document.getElementById('edit-list-modal-overlay');
            const modalTitle = document.getElementById('edit-list-modal-title');
            const listContainer = document.getElementById('edit-list-container');
            listContainer.innerHTML = '';

            let listToEdit;
            let titleText;

            switch (listType) {
                case 'tipoInstitucion':
                    listToEdit = tipoInstitucionList;
                    titleText = 'Tipo de Institución';
                    break;
                case 'sector':
                    listToEdit = sectorList;
                    titleText = 'Sector';
                    break;
                case 'perfil':
                    listToEdit = perfilesList;
                    titleText = 'Perfiles';
                    break;
                case 'tipoUsuario':
                    listToEdit = tiposUsuarioList;
                    titleText = 'Tipos de Usuario';
                    break;
                case 'cargo':
                    listToEdit = cargosList;
                    titleText = 'Cargos';
                    break;
                default:
                    return;
            }

            modalTitle.textContent = `Editar Lista de ${titleText}`;
            listToEdit.forEach((item, index) => {
                const listItemDiv = document.createElement('div');
                listItemDiv.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'border-b', 'last:border-b-0');
                listItemDiv.innerHTML = `
                    <span class="text-sm text-gray-700">${item}</span>
                    <div class="flex gap-1">
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-md text-xs" onclick="openEditSingleListItemModal('${listType}', ${index}, '${item}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="removeListItem('${listType}', ${index})" title="Borrar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>`;
                listContainer.appendChild(listItemDiv);
            });
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de edición de listas.
         */
        function closeEditListModal() {
            document.getElementById('edit-list-modal-overlay').classList.add('hidden');
            populateModalSelects(); 
            populateUserModalSelects(); 
        }

        /**
         * Abre el modal para editar un solo elemento de una lista.
         * @param {string} listType - El tipo de lista.
         * @param {number} index - El índice del elemento a editar.
         * @param {string} value - El valor actual del elemento.
         */
        function openEditSingleListItemModal(listType, index, value) {
            document.getElementById('edit-single-list-item-modal-overlay').classList.remove('hidden');
            document.getElementById('edit-single-list-item-index').value = index;
            document.getElementById('edit-single-list-item-type').value = listType;
            document.getElementById('edit-single-list-item-input').value = value;
            document.getElementById('edit-single-list-item-input').focus();
            document.getElementById('edit-list-modal-overlay').classList.add('hidden'); 
        }

        /**
         * Cierra el modal de edición de un solo elemento de lista.
         */
        function closeEditSingleListItemModal() {
            document.getElementById('edit-single-list-item-modal-overlay').classList.add('hidden');
            openEditListModal(document.getElementById('edit-single-list-item-type').value); 
        }

        /**
         * Guarda el elemento de lista editado.
         */
        function saveEditedListItem() {
            const index = document.getElementById('edit-single-list-item-index').value;
            const listType = document.getElementById('edit-single-list-item-type').value;
            const newValue = document.getElementById('edit-single-list-item-input').value.trim();
            if (!newValue) { showAlert('El nuevo valor no puede estar vacío.'); return; }

            let list;
            let localStorageKey;
            let affectedEntitiesProp;

            switch (listType) {
                case 'tipoInstitucion':
                    list = tipoInstitucionList;
                    localStorageKey = 'tipoInstitucionList_v11_1_1';
                    affectedEntitiesProp = 'tipo'; 
                    break;
                case 'sector':
                    list = sectorList;
                    localStorageKey = 'sectorList_v11_1_1';
                    affectedEntitiesProp = 'sector'; 
                    break;
                case 'perfil':
                    list = perfilesList;
                    localStorageKey = 'perfilesList_v11_1_1';
                    affectedEntitiesProp = 'perfil'; 
                    break;
                case 'tipoUsuario':
                    list = tiposUsuarioList;
                    localStorageKey = 'tiposUsuarioList_v11_1_1';
                    affectedEntitiesProp = 'tipoUsuario'; 
                    break;
                case 'cargo':
                    list = cargosList;
                    localStorageKey = 'cargosList_v11_1_1';
                    affectedEntitiesProp = 'cargo'; 
                    break;
                default:
                    return;
            }

            const oldItem = list[index];
            if (list.includes(newValue) && newValue !== oldItem) { showAlert(`Este ${listType} ya existe.`); return; }
            list[index] = newValue;
            localStorage.setItem(localStorageKey, JSON.stringify(list));

            if (listType === 'tipoInstitucion' || listType === 'sector') {
                institutions.forEach(inst => { if (inst[affectedEntitiesProp] === oldItem) inst[affectedEntitiesProp] = newValue; });
                localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                renderInstitutionsTable();
            } else { 
                users.forEach(user => { if (user[affectedEntitiesProp] === oldItem) user[affectedEntitiesProp] = newValue; });
                localStorage.setItem('users_v11_1_1', JSON.stringify(users));
                renderUsersTable();
            }
            closeEditSingleListItemModal();
        }

        /**
         * Agrega un nuevo elemento a una lista de opciones.
         */
        function addListItem() {
            const input = document.getElementById('new-list-item-input');
            const newItem = input.value.trim();
            if (!newItem) { showAlert('El nuevo elemento no puede estar vacío.'); return; }

            let list;
            let localStorageKey;
            let alertMessage;

            switch (currentEditingListType) {
                case 'tipoInstitucion':
                    list = tipoInstitucionList;
                    localStorageKey = 'tipoInstitucionList_v11_1_1';
                    alertMessage = 'Este tipo de institución ya existe.';
                    break;
                case 'sector':
                    list = sectorList;
                    localStorageKey = 'sectorList_v11_1_1';
                    alertMessage = 'Este sector ya existe.';
                    break;
                case 'perfil':
                    list = perfilesList;
                    localStorageKey = 'perfilesList_v11_1_1';
                    alertMessage = 'Este perfil ya existe.';
                    break;
                case 'tipoUsuario':
                    list = tiposUsuarioList;
                    localStorageKey = 'tiposUsuarioList_v11_1_1';
                    alertMessage = 'Este tipo de usuario ya existe.';
                    break;
                case 'cargo':
                    list = cargosList;
                    localStorageKey = 'cargosList_v11_1_1';
                    alertMessage = 'Este cargo ya existe.';
                    break;
                default:
                    return;
            }

            if (list.includes(newItem)) { showAlert(alertMessage); return; }
            list.push(newItem);
            localStorage.setItem(localStorageKey, JSON.stringify(list));
            input.value = '';
            openEditListModal(currentEditingListType); 
        }

        /**
         * Elimina un elemento de una lista de opciones.
         * @param {string} listType - El tipo de lista.
         * @param {number} indexToRemove - El índice del elemento a eliminar.
         */
        function removeListItem(listType, indexToRemove) {
            showConfirm('¿Está seguro de que desea eliminar este elemento? Las entidades que lo usen quedarán sin un valor asignado.', () => {
                let list;
                let localStorageKey;
                let affectedEntitiesProp;
                let itemToRemove;

                switch (listType) {
                    case 'tipoInstitucion':
                        list = tipoInstitucionList;
                        localStorageKey = 'tipoInstitucionList_v11_1_1';
                        affectedEntitiesProp = 'tipo';
                        break;
                    case 'sector':
                        list = sectorList;
                        localStorageKey = 'sectorList_v11_1_1';
                        affectedEntitiesProp = 'sector';
                        break;
                    case 'perfil':
                        list = perfilesList;
                        localStorageKey = 'perfilesList_v11_1_1';
                        affectedEntitiesProp = 'perfil';
                        break;
                    case 'tipoUsuario':
                        list = tiposUsuarioList;
                        localStorageKey = 'tiposUsuarioList_v11_1_1';
                        affectedEntitiesProp = 'tipoUsuario';
                        break;
                    case 'cargo':
                        list = cargosList;
                        localStorageKey = 'cargosList_v11_1_1';
                        affectedEntitiesProp = 'cargo';
                        break;
                    default:
                        return;
                }

                itemToRemove = list[indexToRemove];
                list.splice(indexToRemove, 1);
                localStorage.setItem(localStorageKey, JSON.stringify(list));

                if (listType === 'tipoInstitucion' || listType === 'sector') {
                    institutions.forEach(inst => { if (inst[affectedEntitiesProp] === itemToRemove) inst[affectedEntitiesProp] = ''; });
                    localStorage.setItem('institutions_v11_1_1', JSON.stringify(institutions));
                    renderInstitutionsTable();
                } else { 
                    users.forEach(user => { if (user[affectedEntitiesProp] === itemToRemove) user[affectedEntitiesProp] = ''; });
                    localStorage.setItem('users_v11_1_1', JSON.stringify(users));
                    renderUsersTable();
                }
                openEditListModal(listType); 
            });
        }


        // --- MÓDULO: PROGRAMACIÓN DE PERIODOS ---
        /**
         * Renderiza la tabla de programación de periodos.
         */
        function renderProgramacionPeriodosTable() {
            const tableBody = document.querySelector('#programacion-periodos-table tbody');
            tableBody.innerHTML = '';

            const institucionFilterInput = document.getElementById('programacion-institucion-filter');
            const institucionIdInput = document.getElementById('programacion-institucion-id'); 
            const ptciFilterSelect = document.getElementById('ptci-actualizado-filter');
            const tipoAperturaFilterSelect = document.getElementById('tipo-accion-filter');

            const institucionFilterText = institucionFilterInput ? institucionFilterInput.value.toLowerCase() : '';
            const institucionIdFilter = institucionIdInput ? institucionIdInput.value : ''; 
            const ptciFilter = ptciFilterSelect ? ptciFilterSelect.value : 'todos';
            const tipoAperturaFilter = tipoAperturaFilterSelect ? tipoAperturaFilterSelect.value : 'todos';

            let institutionsToDisplay = institutions.filter(inst => {
                const instName = inst.nombre.toLowerCase();
                const instSiglas = inst.siglas.toLowerCase();

                let matchesInstitution;
                if (institucionIdFilter) {
                    matchesInstitution = inst.id === institucionIdFilter;
                } else {
                    matchesInstitution = institucionFilterText === '' || instName.includes(institucionFilterText) || instSiglas.includes(institucionFilterText);
                }

                const matchesPtci = ptciFilter === 'todos' || inst.ptciActualizado === ptciFilter;

                const programmedPeriod = programmedPeriods.find(pp => pp.institucionId === inst.id);
                const hasMatchingProgrammedPeriod = tipoAperturaFilter === 'todos' || (programmedPeriod && programmedPeriod.accionesPermitidas && programmedPeriod.accionesPermitidas.includes(tipoAperturaFilter));

                return inst.estatus === 'Activa' && matchesInstitution && matchesPtci && hasMatchingProgrammedPeriod;
            });

            if (institutionsToDisplay.length === 0) {
                let noResultsMessage = "No se encontraron resultados.";
                if (institucionFilterText || ptciFilter !== 'todos' || tipoAperturaFilter !== 'todos') {
                    noResultsMessage = "No se encontraron instituciones que coincidan con los filtros aplicados.";
                }
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-3">${noResultsMessage}</td></tr>`;
                updateUiPostSelection();
                return;
            }

            institutionsToDisplay.forEach(inst => {
                const programmedPeriod = programmedPeriods.find(p => p.institucionId === inst.id) || {};
                const isSelected = selectedInstitutionsForProgramacion.some(sInst => sInst.id === inst.id);
                const row = tableBody.insertRow();
                row.classList.toggle('selected', isSelected);
                row.dataset.institutionId = inst.id;

                row.addEventListener('click', (event) => {
                    if (event.target.type !== 'checkbox' && event.target.tagName !== 'BUTTON' && event.target.tagName !== 'SVG' && event.target.tagName !== 'PATH') {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleInstitutionSelection(checkbox, inst.id);
                    }
                });

                row.innerHTML = `
                    <td class="text-center-col"><input type="checkbox" data-institution-id="${inst.id}" ${isSelected ? 'checked' : ''}></td>
                    <td class="text-center-col">${programmedPeriod.periodo || 'N/A'}</td>
                    <td class="text-center-col">${inst.siglas}</td>
                    <td>${inst.nombre}</td>
                    <td class="text-center-col">${inst.ptciActualizado}</td>
                    <td class="text-center-col">${programmedPeriod.trimestre || 'N/A'}</td>
                    <td>${(programmedPeriod.accionesPermitidas || []).join('<br>')}</td>
                    <td class="text-center-col">${programmedPeriod.fechaInicio || 'N/A'}</td>
                    <td class="text-center-col">${programmedPeriod.fechaFin || 'N/A'}</td>
                `;

                const checkbox = row.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', () => toggleInstitutionSelection(checkbox, inst.id));
            });
            updateUiPostSelection();
        }

        /**
         * Selecciona o deselecciona todas las instituciones visibles en la tabla de programación.
         * @param {boolean} isChecked - Si el checkbox maestro está marcado.
         */
        function toggleAllInstitutions(isChecked) {
            const checkboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                toggleInstitutionSelection(checkbox, checkbox.dataset.institutionId);
            });
        }

        /**
         * Alterna la selección de una institución individual.
         * @param {HTMLElement} checkbox - El checkbox de la fila.
         * @param {string} institutionId - El ID de la institución.
         */
        function toggleInstitutionSelection(checkbox, institutionId) {
            const institution = institutions.find(inst => inst.id === institutionId);
            if (!institution) return;

            if (checkbox.checked) {
                if (!selectedInstitutionsForProgramacion.some(inst => inst.id === institutionId)) {
                    selectedInstitutionsForProgramacion.push(institution);
                }
            } else {
                selectedInstitutionsForProgramacion = selectedInstitutionsForProgramacion.filter(inst => inst.id !== institutionId);
            }
            checkbox.closest('tr').classList.toggle('selected', checkbox.checked);
            updateUiPostSelection();
        }

        /**
         * Actualiza el estado del checkbox "seleccionar todo" y la visibilidad del botón de historial.
         */
        function updateUiPostSelection() {
            const allCheckboxes = document.querySelectorAll('#programacion-periodos-table tbody input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('select-all-institutions');
            if (selectAllCheckbox) { 
                if (allCheckboxes.length > 0) {
                    const allVisibleChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allVisibleChecked;
                    selectAllCheckbox.indeterminate = !allVisibleChecked && Array.from(allCheckboxes).some(cb => cb.checked);
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                }
            }
            const historyButton = document.getElementById('history-button');
            if (historyButton) { 
                historyButton.style.display = selectedInstitutionsForProgramacion.length === 1 ? 'inline-flex' : 'none';
            }
        }

        // --- MODALES Y LÓGICA DE DATOS ---
        /**
         * Popula los filtros de acción en el módulo de programación de periodos y el modal de historial.
         */
        function populateActionFilters() {
            const mainFilter = document.getElementById('tipo-accion-filter');
            const historyFilter = document.getElementById('history-action-filter');
            if (mainFilter) { 
                mainFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
                for (const category in availableActionsCategories) {
                    const mainOptgroup = document.createElement('optgroup');
                    mainOptgroup.label = category;
                    availableActionsCategories[category].forEach(action => {
                        const mainOption = new Option(action, action);
                        mainOptgroup.appendChild(mainOption);
                    });
                    mainFilter.appendChild(mainOptgroup);
                }
            }
            if (historyFilter) { 
                historyFilter.innerHTML = '<option value="todos">Todas las Acciones</option>';
                for (const category in availableActionsCategories) {
                    const historyOptgroup = document.createElement('optgroup');
                    historyOptgroup.label = category;
                    availableActionsCategories[category].forEach(action => {
                        const historyOption = new Option(action, action);
                        historyOptgroup.appendChild(historyOption);
                    });
                    historyFilter.appendChild(historyOptgroup);
                }
            }
        }

        /**
         * Popula el formulario del modal "Aperturar Sistema" con opciones de periodo y acciones.
         */
        function populateAperturarModalActions() {
            const form = document.getElementById('aperturar-form');
            if (!form) return; 
            form.innerHTML = '';

            const currentYear = new Date().getFullYear();
            const years = [currentYear - 1, currentYear, currentYear + 1];

            const periodosHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-field-group">
                        <label for="aperturar-periodo">Periodo</label>
                        <div class="select-wrapper">
                            <select id="aperturar-periodo" required onchange="updateDatesByPeriodAndTrimestre()">
                                ${years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-trimestre">Trimestre</label>
                        <div class="select-wrapper">
                            <select id="aperturar-trimestre" onchange="updateDatesByPeriodAndTrimestre()">
                                <option value="1T">1er Trimestre</option>
                                <option value="2T">2do Trimestre</option>
                                <option value="3T">3er Trimestre</option>
                                <option value="4T">4to Trimestre</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-inicio">Fecha Inicio</label>
                        <input type="date" id="aperturar-fecha-inicio" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                    <div class="form-field-group">
                        <label for="aperturar-fecha-fin">Fecha Fin</label>
                        <input type="date" id="aperturar-fecha-fin" class="w-full p-1 border rounded" required style="font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 0.3rem;">
                    </div>
                </div>
                <h4 class="text-md font-bold text-gray-700 mt-4 mb-2">Acciones a Habilitar</h4>`;
            form.insertAdjacentHTML('beforeend', periodosHTML);

            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            form.appendChild(actionsContainer);
            for (const category in availableActionsCategories) {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                let checkboxesHTML = `<h5>${category}</h5>`;
                availableActionsCategories[category].forEach(action => {
                    checkboxesHTML += `<label class="flex items-center text-xs py-1"><input type="checkbox" name="accion-permitida" value="${action}" class="mr-2">${action}</label>`;
                });
                gridItem.innerHTML = checkboxesHTML;
                actionsContainer.appendChild(gridItem);
            }

            const buttonsHTML = `<div class="modal-buttons"><button type="button" class="btn-cancel" onclick="closeAperturarModal()">Cancelar</button><button type="submit" class="btn-save">Aperturar</button></div>`;
            form.insertAdjacentHTML('beforeend', buttonsHTML);

            form.addEventListener('submit', handleAperturarSubmit);
        }

        /**
         * Maneja el envío del formulario "Aperturar Sistema".
         * @param {Event} event - El evento del submit.
         */
        function handleAperturarSubmit(event) {
            event.preventDefault();
            const periodo = document.getElementById('aperturar-periodo').value;
            const trimestre = document.getElementById('aperturar-trimestre').value;
            const fechaInicio = document.getElementById('aperturar-fecha-inicio').value;
            const fechaFin = document.getElementById('aperturar-fecha-fin').value;
            const accionesPermitidas = Array.from(document.querySelectorAll('input[name="accion-permitida"]:checked')).map(cb => cb.value);

            if (accionesPermitidas.length === 0) {
                showAlert('Debe seleccionar al menos una acción para habilitar.');
                return;
            }
             if (!fechaInicio || !fechaFin) {
                showAlert('Debe seleccionar una fecha de inicio y fin.');
                return;
            }

            selectedInstitutionsForProgramacion.forEach(inst => {
                const newAction = {
                    periodo, trimestre, fechaInicio, fechaFin,
                    accionesPermitidas,
                    usuario: 'admin_user', 
                    timestamp: new Date().toISOString()
                };

                const existingIndex = programmedPeriods.findIndex(p => p.institucionId === inst.id);
                if (existingIndex !== -1) {
                    programmedPeriods[existingIndex] = { institucionId: inst.id, ...newAction };
                } else {
                    programmedPeriods.push({ institucionId: inst.id, ...newAction });
                }

                if (!programmedPeriodsHistory[inst.id]) programmedPeriodsHistory[inst.id] = [];
                programmedPeriodsHistory[inst.id].push(newAction);
            });
            localStorage.setItem('programmedPeriods_v11_1_1', JSON.stringify(programmedPeriods));
            localStorage.setItem('programmedPeriodsHistory_v11_1_1', JSON.stringify(programmedPeriodsHistory));

            closeAperturarModal();
            renderProgramacionPeriodosTable();
            showAlert('Sistema aperturado/actualizado correctamente.');
        }

        /**
         * Abre el modal "Aperturar Sistema".
         */
        function openAperturarModal() {
            if (selectedInstitutionsForProgramacion.length === 0) {
                showAlert('Por favor, selecciona al menos una institución.');
                return;
            }
            document.querySelectorAll('input[name="accion-permitida"]').forEach(cb => cb.checked = false);
            updateDatesByPeriodAndTrimestre();

            const display = document.getElementById('selected-institutions-display');
            if (display) { 
                display.textContent = `Instituciones seleccionadas: ${selectedInstitutionsForProgramacion.map(i => i.siglas).join(', ')}`;
                display.classList.remove('hidden');
            }
            document.getElementById('aperturar-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal "Aperturar Sistema".
         */
        function closeAperturarModal() { document.getElementById('aperturar-modal-overlay').classList.add('hidden'); }

        /**
         * Calcula y establece automáticamente las fechas de inicio y fin basándose en el periodo y trimestre seleccionados.
         */
        function updateDatesByPeriodAndTrimestre() {
            const periodoSelect = document.getElementById('aperturar-periodo');
            const trimestreSelect = document.getElementById('aperturar-trimestre');
            const fechaInicioInput = document.getElementById('aperturar-fecha-inicio');
            const fechaFinInput = document.getElementById('aperturar-fecha-fin');

            if (!periodoSelect || !trimestreSelect || !fechaInicioInput || !fechaFinInput) return; 

            const year = parseInt(periodoSelect.value);
            const trimestre = trimestreSelect.value;

            if (isNaN(year) || !trimestre) return;

            let lastDayOfQuarter;
            switch (trimestre) {
                case '1T': 
                    lastDayOfQuarter = new Date(year, 2, 31); 
                    break;
                case '2T': 
                    lastDayOfQuarter = new Date(year, 5, 30); 
                    break;
                case '3T': 
                    lastDayOfQuarter = new Date(year, 8, 30); 
                    break;
                case '4T': 
                    lastDayOfQuarter = new Date(year, 11, 31); 
                    break;
                default:
                    return;
            }

            let startDate = new Date(lastDayOfQuarter);
            startDate.setMonth(startDate.getMonth() + 1);
            startDate.setDate(1); 

            fechaInicioInput.value = startDate.toISOString().split('T')[0];

            let endDate = new Date(startDate);
            let addedDays = 0;
            while (addedDays < 15) {
                endDate.setDate(endDate.getDate() + 1);
                if (endDate.getDay() !== 0 && endDate.getDay() !== 6) {
                    addedDays++;
                }
            }
            fechaFinInput.value = endDate.toISOString().split('T')[0];
        }

        /**
         * Abre el modal de historial para una institución seleccionada.
         */
        function openHistoryModal() {
            if (selectedInstitutionsForProgramacion.length !== 1) return; 
            const inst = selectedInstitutionsForProgramacion[0];
            const historyInstitutionName = document.getElementById('history-institution-name');
            const historyActionFilter = document.getElementById('history-action-filter');

            if (historyInstitutionName) { 
                historyInstitutionName.textContent = `${inst.siglas} - ${inst.nombre}`;
            }
            if (historyActionFilter) { 
                historyActionFilter.value = 'todos'; 
            }

            renderHistoryTable(); 
            document.getElementById('history-modal-overlay').classList.remove('hidden');
        }

        /**
         * Renderiza la tabla de historial de programación de periodos.
         */
        function renderHistoryTable() {
            const inst = selectedInstitutionsForProgramacion[0];
            if (!inst) return;

            const historyTableBody = document.getElementById('history-table-body');
            const actionFilterSelect = document.getElementById('history-action-filter');

            if (!historyTableBody || !actionFilterSelect) return; 

            historyTableBody.innerHTML = '';
            const actionFilter = actionFilterSelect.value;
            const historyForInst = (programmedPeriodsHistory[inst.id] || []).filter(entry =>
                actionFilter === 'todos' || (entry.accionesPermitidas && entry.accionesPermitidas.includes(actionFilter))
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 
            if (historyForInst.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-500 py-3">No hay historial para el filtro seleccionado.</td></tr>`;
                return;
            }

            historyForInst.forEach(entry => {
                const row = historyTableBody.insertRow();
                row.innerHTML = `
                    <td class="text-center-col">${entry.periodo || 'N/A'}</td>
                    <td class="text-center-col">${entry.trimestre || 'N/A'}</td>
                    <td>${(entry.accionesPermitidas || []).join('<br>')}</td>
                    <td class="text-center-col">${entry.fechaInicio || 'N/A'}</td>
                    <td class="text-center-col">${entry.fechaFin || 'N/A'}</td>
                    <td>${entry.usuario || 'N/A'}</td>
                `;
            });
        }

        /**
         * Cierra el modal de historial.
         */
        function closeHistoryModal() { document.getElementById('history-modal-overlay').classList.add('hidden'); }

        // --- MÓDULO: REPORTE DE AVANCE INSTITUCIONAL ---
        /**
         * Renderiza la tabla del reporte de avance institucional.
         */
        function renderReporteAvanceInstitucionalTable() {
            const table = document.querySelector('#module-reporte-avance-institucional .data-table');
            const tbody = table.querySelector('tbody');

            tbody.innerHTML = '';

            const estatusFilterInput = document.querySelector('input[name="estatus_reporte"]:checked');
            const anioFilterSelect = document.getElementById('anio_input');
            const trimestreReporteFilterSelect = document.getElementById('trimestre_reporte_input');

            const estatusFilter = estatusFilterInput ? estatusFilterInput.value : '1'; 
            const anioFilter = anioFilterSelect ? anioFilterSelect.value : 'todos';
            const trimestreReporteFilter = trimestreReporteFilterSelect ? trimestreReporteFilterSelect.value : 'todos';


            const filteredInstitutions = institutions.filter(inst => {
                const isActive = inst.estatus === 'Activa';
                return (estatusFilter === '1' && isActive) || (estatusFilter === '0' && !isActive);
            });

            if (filteredInstitutions.length === 0) {
                tbody.innerHTML = `<tr><td colspan="38" class="text-center text-gray-500 py-3">No se encontraron instituciones con el estatus seleccionado.</td></tr>`;
                return;
            }

            let hasData = false;
            filteredInstitutions.forEach(inst => {
                const programmedPeriod = programmedPeriods.find(p =>
                    p.institucionId === inst.id &&
                    (anioFilter === 'todos' || p.periodo === anioFilter) &&
                    (trimestreReporteFilter === 'todos' || p.trimestre === trimestreReporteFilter)
                );

                if (programmedPeriod) {
                    hasData = true;
                    const data = {
                        periodoCapturaSCII: '2024-01-01',
                        abiertoHastaSCII: '2024-03-31',
                        procesosPrioritarios: 'Sí',
                        evaluacionSCII: 'Finalizado',
                        informeAnual: 'Sí',
                        ptciFinalizado: 'Sí',
                        periodoCapturaPTCI: '2024-04-01',
                        abiertoHastaPTCI: '2024-06-30',
                        actualizarPTCI: 'Sí',
                        ptciActFinalizado: 'Sí',
                        periodoCapturaSeguimientoAM: '2024-07-01',
                        abiertoHastaSeguimientoAM: '2024-09-30',
                        finalizadoSeguimientoAM: 'Sí',
                        reporteTrimestralAM: 'Sí',
                        periodoCapturaPTAR: '2024-04-01',
                        abiertoHastaPTAR: '2024-06-30',
                        controles: 'Sí',
                        estrategia: 'Sí',
                        ptarFinalizado: 'Sí',
                        periodoCapturaSeguimientoAC: '2024-07-01',
                        abiertoHastaSeguimientoAC: '2024-09-30',
                        finalizadoSeguimientoAC: 'Sí',
                        reporteTrimestralAC: 'Sí',
                        periodoCapturaRevisionOIC: '2024-01-01',
                        abiertoHastaRevisionOIC: '2024-03-31',
                        informeOICFinalizado: 'Sí',
                        periodoCapturaOICSeguimientoAM: '2024-04-01',
                        abiertoHastaOICSeguimientoAM: '2024-06-30',
                        finalizadoOICSeguimientoAM: 'Sí',
                        reporteTrimestralOICAM: 'Sí',
                        periodoCapturaOICSeguimientoAC: '2024-07-01',
                        abiertoHastaOICSeguimientoAC: '2024-09-30',
                        finalizadoOICSeguimientoAC: 'Sí',
                        reporteTrimestralOICAC: 'Sí',
                    };

                    let dataRow = '<tr>';
                    dataRow += `<td class="text-center-col">${programmedPeriod.periodo || 'N/A'}</td>`;
                    dataRow += `<td class="text-center-col">${programmedPeriod.trimestre || 'N/A'}</td>`;
                    dataRow += `<td class="text-center-col">${inst.siglas}</td>`;
                    dataRow += `<td>${inst.nombre}</td>`;

                    dataRow += `<td class="text-center-col">${data.periodoCapturaSCII}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaSCII}</td>`;
                    dataRow += `<td class="text-center-col">${data.procesosPrioritarios}</td>`;
                    dataRow += `<td class="text-center-col">${data.evaluacionSCII}</td>`;
                    dataRow += `<td class="text-center-col">${data.informeAnual}</td>`;
                    dataRow += `<td class="text-center-col">${data.ptciFinalizado}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaPTCI}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaPTCI}</td>`;
                    dataRow += `<td class="text-center-col">${data.actualizarPTCI}</td>`;
                    dataRow += `<td class="text-center-col">${data.ptciActFinalizado}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.finalizadoSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.reporteTrimestralAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaPTAR}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaPTAR}</td>`;
                    dataRow += `<td class="text-center-col">${data.controles}</td>`;
                    dataRow += `<td class="text-center-col">${data.estrategia}</td>`;
                    dataRow += `<td class="text-center-col">${data.ptarFinalizado}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.finalizadoSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.reporteTrimestralAC}</td>`;

                    dataRow += `<td class="text-center-col">${data.periodoCapturaRevisionOIC}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaRevisionOIC}</td>`;
                    dataRow += `<td class="text-center-col">${data.informeOICFinalizado}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaOICSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaOICSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.finalizadoOICSeguimientoAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.reporteTrimestralOICAM}</td>`;
                    dataRow += `<td class="text-center-col">${data.periodoCapturaOICSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.abiertoHastaOICSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.finalizadoOICSeguimientoAC}</td>`;
                    dataRow += `<td class="text-center-col">${data.reporteTrimestralOICAC}</td>`;

                    dataRow += '</tr>';
                    tbody.innerHTML += dataRow;
                }
            });

            if (!hasData) {
                 tbody.innerHTML = `<tr><td colspan="38" class="text-center text-gray-500 py-3">No se encontraron datos para el filtro seleccionado.</td></tr>`;
            }
        }

        /**
         * Exporta los datos del reporte de avance institucional a un archivo CSV.
         */
        function exportReporteAvanceInstitucional() {
            const headers = [
                "Periodo", "Trimestre", "Siglas", "Institución",
                "Evaluación del SCII - Periodo Captura", "Evaluación del SCII - Abierto Hasta", "Evaluación del SCII - Procesos Prioritarios", "Evaluación del SCII - Evaluación del SCII",
                "Evaluación del SCII - Informe Anual", "Evaluación del SCII - PTCI Finalizado", "PTCI - Periodo Captura", "PTCI - Abierto Hasta",
                "PTCI - Actualizar PTCI", "PTCI - PTCI Act Finalizado", "Seguimiento de Acciones de Mejora - Periodo Captura", "Seguimiento de Acciones de Mejora - Abierto Hasta",
                "Seguimiento de Acciones de Mejora - Finalizado", "Seguimiento de Acciones de Mejora - Reporte Trimestral", "PTAR - Periodo Captura", "PTAR - Abierto Hasta",
                "PTAR - Controles", "PTAR - Estrategia", "PTAR - PTAR Finalizado", "Seguimiento de Acciones de Control - Periodo Captura",
                "Seguimiento de Acciones de Control - Abierto Hasta", "Seguimiento de Acciones de Control - Finalizado", "Seguimiento de Acciones de Control - Reporte Trimestral",
                "Revisión OIC - Periodo Captura", "Revisión OIC - Abierto Hasta", "Revisión OIC - Informe OIC Finalizado",
                "OIC - Seguimiento de Acciones de Mejora - Periodo Captura", "OIC - Seguimiento de Acciones de Mejora - Abierto Hasta", "OIC - Seguimiento de Acciones de Mejora - Finalizado", "OIC - Seguimiento de Acciones de Mejora - Reporte Trimestral",
                "OIC - Seguimiento de Acciones de Control - Periodo Captura", "OIC - Seguimiento de Acciones de Control - Abierto Hasta", "OIC - Seguimiento de Acciones de Control - Finalizado", "OIC - Seguimiento de Acciones de Control - Reporte Trimestral"
            ];

            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';
            const tableBody = document.querySelector('#module-reporte-avance-institucional .data-table tbody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));

            rows.forEach(row => {
                if (row.classList.contains('text-center')) {
                    return;
                }

                const rowData = Array.from(row.querySelectorAll('td')).map(td => {
                    let text = td.textContent.trim();
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                });
                csvContent += rowData.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAvanceInstitucional_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        // --- MÓDULO: CONTROL DE USUARIOS ---

        /**
         * Popula los selects del modal de agregar/editar usuario.
         */
        function populateUserModalSelects() {
            const perfilSelect = document.getElementById('user-perfil');
            const tipoUsuarioSelect = document.getElementById('user-tipo-usuario');
            const cargoSelect = document.getElementById('user-cargo');

            if (perfilSelect) { 
                perfilSelect.innerHTML = ''; 
                perfilesList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    perfilSelect.appendChild(option);
                });
            }

            if (tipoUsuarioSelect) { 
                tipoUsuarioSelect.innerHTML = ''; 
                tiposUsuarioList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    tipoUsuarioSelect.appendChild(option);
                });
            }

            if (cargoSelect) { 
                cargoSelect.innerHTML = ''; 
                cargosList.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    cargoSelect.appendChild(option);
                });
            }
        }

        /**
         * Renderiza la tabla de usuarios en el módulo de control de usuarios.
         */
        function renderUsersTable() {
            const tableBody = document.querySelector('#users-table tbody');
            if (!tableBody) return; 
            tableBody.innerHTML = '';

            const statusFilterInput = document.querySelector('input[name="user_status_filter"]:checked');
            const searchTermInput = document.getElementById('user-search-input');

            const statusFilter = statusFilterInput ? statusFilterInput.value : 'todos';
            const searchTerm = searchTermInput ? searchTermInput.value.toLowerCase() : '';


            const filteredUsers = users.filter(user => {
                const matchesStatus = statusFilter === 'todos' || user.estatus === statusFilter;
                const institution = institutions.find(inst => inst.siglas === user.siglasInstitucion);
                const institutionName = institution ? institution.nombre.toLowerCase() : '';

                const matchesSearch = searchTerm === '' ||
                                      user.clave.toLowerCase().includes(searchTerm) ||
                                      user.nombre.toLowerCase().includes(searchTerm) ||
                                      user.siglasInstitucion.toLowerCase().includes(searchTerm) ||
                                      institutionName.includes(searchTerm); 

                return matchesStatus && matchesSearch;
            });

            if (filteredUsers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center text-gray-500 py-3">No se encontraron usuarios.</td></tr>`;
                return;
            }

            filteredUsers.forEach(user => {
                const institution = institutions.find(inst => inst.siglas === user.siglasInstitucion);
                const institutionName = institution ? institution.nombre : 'N/A';
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td class="text-center-col">${user.siglasInstitucion}</td>
                    <td>${institutionName}</td>
                    <td>${user.nombre}</td>
                    <td>${user.perfil}</td>
                    <td class="text-center-col">${user.clave}</td>
                    <td class="text-center-col">**********</td>
                    <td class="text-center-col">${user.estatus}</td>
                    <td>${user.correo || 'N/A'}</td>
                    <td>${user.telefono || 'N/A'}</td>
                    <td>${user.tipoUsuario || 'N/A'}</td>
                    <td>${user.cargo || 'N/A'}</td>
                    <td class="flex gap-1 justify-center text-center-col">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="openUserModal('${user.id}')" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                <path d="M15 5l4 4"/>
                            </svg>
                        </button>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white p-1 rounded-md text-xs" onclick="openUserAccessReportModal('${user.id}')" title="Generar Reporte de Accesos">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white p-1 rounded-md text-xs" onclick="deleteUser('${user.id}')" title="Eliminar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
     
        /**
         * Limpia el filtro de búsqueda de usuarios y re-renderiza la tabla.
         */
        function clearUserSearchFilter() {
            document.getElementById('user-search-input').value = '';
            renderUsersTable();
        }

        /**
         * Abre el modal para agregar o editar un usuario.
         * @param {string} [userId=null] - El ID del usuario a editar. Si es null, se abre para agregar.
         */
        function openUserModal(userId = null) {
            const modalOverlay = document.getElementById('user-modal-overlay');
            const modalTitle = document.getElementById('user-modal-title');
            const form = document.getElementById('user-form');
            form.reset(); 
            populateUserModalSelects(); 

            document.getElementById('user-id-edit').value = '';
            document.getElementById('user-siglas-institucion-filter').value = ''; 
            document.getElementById('user-siglas-institucion-id').value = ''; 
            document.getElementById('user-password').value = ''; 
            document.getElementById('user-no-oficio').value = ''; 
            document.getElementById('user-file-name').value = ''; 

            if (userId) {
                modalTitle.textContent = 'Editar Usuario';
                const userToEdit = users.find(user => user.id === userId);
                if (userToEdit) {
                    document.getElementById('user-id-edit').value = userToEdit.id;
                    document.getElementById('user-clave').value = userToEdit.clave;
                    document.getElementById('user-nombre').value = userToEdit.nombre;
                    document.getElementById('user-perfil').value = userToEdit.perfil;
                    document.querySelector(`input[name="user-estatus"][value="${userToEdit.estatus}"]`).checked = true;
                    document.getElementById('user-correo').value = userToEdit.correo;
                    document.getElementById('user-telefono').value = userToEdit.telefono;
                    document.getElementById('user-tipo-usuario').value = userToEdit.tipoUsuario;
                    document.getElementById('user-cargo').value = userToEdit.cargo;
                    document.getElementById('user-no-oficio').value = userToEdit.noOficioDesignacion || ''; 
                    const institution = institutions.find(inst => inst.siglas === userToEdit.siglasInstitucion);
                    if (institution) {
                        document.getElementById('user-siglas-institucion-filter').value = `${institution.siglas} - ${institution.nombre}`;
                        document.getElementById('user-siglas-institucion-id').value = institution.siglas; 
                    }
                    document.getElementById('user-password').value = userToEdit.password; 
                }
            } else {
                modalTitle.textContent = 'Agregar Usuario';
                document.querySelector('input[name="user-estatus"][value="Activo"]').checked = true; 
            }
            modalOverlay.classList.remove('hidden');
        }

        /**
         * Cierra el modal de agregar/editar usuario.
         */
        function closeUserModal() {
            document.getElementById('user-modal-overlay').classList.add('hidden');
            document.getElementById('user-siglas-institucion-suggestions').classList.add('hidden'); 
        }

        /**
         * Maneja el envío del formulario de usuario (agregar/editar).
         * @param {Event} event - El evento del submit.
         */
        function handleUserFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('user-id-edit').value;
            const clave = document.getElementById('user-clave').value.trim();
            const password = document.getElementById('user-password').value.trim();
            const nombre = document.getElementById('user-nombre').value.trim();
            const perfil = document.getElementById('user-perfil').value;
            const estatus = document.querySelector('input[name="user-estatus"]:checked').value;
            const correo = document.getElementById('user-correo').value.trim();
            const telefono = document.getElementById('user-telefono').value.trim();
            const tipoUsuario = document.getElementById('user-tipo-usuario').value;
            const cargo = document.getElementById('user-cargo').value;
            const noOficioDesignacion = document.getElementById('user-no-oficio').value.trim(); 
            const siglasInstitucion = document.getElementById('user-siglas-institucion-id').value; 

            if (!clave || !password || !nombre || !perfil || !siglasInstitucion || !tipoUsuario || !cargo) {
                showAlert('Por favor, complete todos los campos obligatorios (Nombre de Usuario, Contraseña, Nombre, Perfil, Siglas Institución, Tipo Usuario, Cargo).');
                return;
            }

            let modifiedFields = 'N/A';
            if (id) {
                const index = users.findIndex(user => user.id === id);
                if (index !== -1) {
                    const oldUser = { ...users[index] }; 
                    users[index] = { ...oldUser, clave, password, nombre, perfil, estatus, correo, telefono, tipoUsuario, cargo, siglasInstitucion, noOficioDesignacion };

                    const changedFields = [];
                    for (const key in users[index]) {
                        if (users[index][key] !== oldUser[key] && key !== 'id') {
                            changedFields.push(key);
                        }
                    }
                    if (changedFields.length > 0) {
                        modifiedFields = `Datos de usuario modificados: ${changedFields.join(', ')}`;
                    } else {
                        modifiedFields = 'Ninguna';
                    }
                }
                logUserAccess(id, siglasInstitucion, clave, 'Control de Usuarios', 'Modificación', modifiedFields, 'Edición', 'Éxito');
            } else {
                const newId = 'user' + Date.now().toString(); 
                if (users.some(user => user.clave === clave)) {
                    showAlert('La clave de usuario ya existe. Por favor, utilice una clave diferente.');
                    return;
                }
                users.push({ id: newId, clave, password, nombre, perfil, estatus, correo, telefono, tipoUsuario, cargo, siglasInstitucion, noOficioDesignacion });
                logUserAccess(newId, siglasInstitucion, clave, 'Control de Usuarios', 'Agregación', 'Nuevo usuario creado', 'Creación', 'Éxito');
            }

            localStorage.setItem('users_v11_1_1', JSON.stringify(users));
            renderUsersTable(); 
            closeUserModal();
            showAlert('Usuario guardado correctamente.');
        }

        /**
         * Elimina un usuario del sistema.
         * @param {string} userId - El ID del usuario a eliminar.
         */
        function deleteUser(userId) {
            showConfirm('¿Está seguro de que desea eliminar este usuario? Esto también eliminará sus registros de acceso.', () => {
                const userToDelete = users.find(user => user.id === userId);
                if (userToDelete) {
                    users = users.filter(user => user.id !== userId);
                    userAccessLogs = userAccessLogs.filter(log => log.userId !== userId); 
                    localStorage.setItem('users_v11_1_1', JSON.stringify(users));
                    localStorage.setItem('userAccessLogs_v11_1_1', JSON.stringify(userAccessLogs));
                    renderUsersTable(); 
                    showAlert('Usuario eliminado correctamente.');
                    logUserAccess(userToDelete.id, userToDelete.siglasInstitucion, userToDelete.clave, 'Control de Usuarios', 'Eliminación', `Usuario ${userToDelete.clave} eliminado`, 'Eliminación', 'Éxito');
                }
            });
        }

        // --- Logging de Acceso de Usuarios ---
        /**
         * Registra un evento de acceso de usuario.
         */
        function logUserAccess(userId, siglas, claveUsuario, moduloAccedido, accionRealizada, campoModificado, tipoEvento, resultado) {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');

            const fechaAcceso = `${year}-${month}-${day}`;
            const horaInicio = `${hours}:${minutes}:${seconds}`;
            const horaCierre = `${hours}:${minutes}:${seconds}`; 

            userAccessLogs.push({
                userId,
                year,
                siglas,
                claveUsuario,
                fechaAcceso,
                horaInicio,
                horaCierre,
                duracionSesion: 0, 
                moduloAccedido,
                accionRealizada,
                campoModificado, 
                tipoEvento,
                resultado,
                direccionIP: '127.0.0.1', 
                agenteUsuario: navigator.userAgent 
            });
            localStorage.setItem('userAccessLogs_v11_1_1', JSON.stringify(userAccessLogs));
        }

        /**
         * Abre el modal para mostrar el reporte de acceso de un usuario específico.
         * @param {string} userId - El ID del usuario.
         */
        function openUserAccessReportModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const reportUserName = document.getElementById('report-user-name');
            const reportUserClave = document.getElementById('report-user-clave');
            const reportTableBody = document.getElementById('user-access-report-table-body');

            if (reportUserName) reportUserName.textContent = user.nombre;
            if (reportUserClave) reportUserClave.textContent = user.clave;
            if (reportTableBody) reportTableBody.innerHTML = '';

            const userLogs = userAccessLogs.filter(log => log.userId === userId);

            if (userLogs.length === 0) {
                if (reportTableBody) {
                    reportTableBody.innerHTML = `<tr><td colspan="14" class="text-center text-gray-500 py-3">No hay registros de acceso para este usuario.</td></tr>`;
                }
            } else {
                userLogs.forEach(log => {
                    const row = reportTableBody.insertRow();
                    row.innerHTML = `
                        <td class="text-center-col">${log.year || 'N/A'}</td>
                        <td class="text-center-col">${log.siglas || 'N/A'}</td>
                        <td class="text-center-col">${log.claveUsuario || 'N/A'}</td>
                        <td class="text-center-col">${log.fechaAcceso || 'N/A'}</td>
                        <td class="text-center-col">${log.horaInicio || 'N/A'}</td>
                        <td class="text-center-col">${log.horaCierre || 'N/A'}</td>
                        <td class="text-center-col">${log.duracionSesion || 'N/A'}</td>
                        <td>${log.moduloAccedido || 'N/A'}</td>
                        <td>${log.accionRealizada || 'N/A'}</td>
                        <td>${log.campoModificado || 'N/A'}</td>
                        <td>${log.tipoEvento || 'N/A'}</td>
                        <td>${log.resultado || 'N/A'}</td>
                        <td>${log.direccionIP || 'N/A'}</td>
                        <td>${log.agenteUsuario || 'N/A'}</td>
                    `;
                });
            }
            document.getElementById('user-access-report-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal del reporte de acceso de usuario.
         */
        function closeUserAccessReportModal() {
            document.getElementById('user-access-report-modal-overlay').classList.add('hidden');
        }

        /**
         * Descarga el reporte de acceso de un usuario específico como archivo CSV.
         */
        function downloadUserAccessReport() {
            const userClaveSpan = document.getElementById('report-user-clave');
            const userClave = userClaveSpan ? userClaveSpan.textContent : '';
            const user = users.find(u => u.clave === userClave);
            if (!user) return;

            const logs = userAccessLogs.filter(log => log.userId === user.id);

            const headers = ["Año", "Siglas", "Clave de Usuario", "Fecha de Acceso", "Hora de Inicio", "Hora de Cierre", "Duración (min)", "Módulo Accedido", "Acción Realizada", "Campo Modificado", "Tipo de Evento", "Resultado", "Dirección IP", "Agente de Usuario"];
            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';

            logs.forEach(log => {
                const rowData = [
                    log.year,
                    log.siglas,
                    log.claveUsuario,
                    log.fechaAcceso,
                    log.horaInicio,
                    log.horaCierre,
                    log.duracionSesion,
                    log.moduloAccedido,
                    log.accionRealizada,
                    log.campoModificado || 'N/A',
                    log.tipoEvento,
                    log.resultado,
                    log.direccionIP,
                    log.agenteUsuario
                ];
                csvContent += rowData.map(item => {
                    let text = String(item);
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAccesos_${user.clave}_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        /**
         * Genera y descarga el reporte histórico de accesos de todos los usuarios como archivo CSV.
         */
        function generateHistoricalAccessReport() {
            const headers = ["Año", "Siglas", "Clave de Usuario", "Fecha de Acceso", "Hora de Inicio", "Hora de Cierre", "Duración (min)", "Módulo Accedido", "Acción Realizada", "Campo Modificado", "Tipo de Evento", "Resultado", "Dirección IP", "Agente de Usuario"];
            let csvContent = headers.map(header => `"${header}"`).join(',') + '\n';

            userAccessLogs.forEach(log => {
                const rowData = [
                    log.year,
                    log.siglas,
                    log.claveUsuario,
                    log.fechaAcceso,
                    log.horaInicio,
                    log.horaCierre,
                    log.duracionSesion,
                    log.moduloAccedido,
                    log.accionRealizada,
                    log.campoModificado || 'N/A',
                    log.tipoEvento,
                    log.resultado,
                    log.direccionIP,
                    log.agenteUsuario
                ];
                csvContent += rowData.map(item => {
                    let text = String(item);
                    if (text.includes(',') || text.includes('"') || text.includes('\n')) {
                        text = `"${text.replace(/"/g, '""')}"`;
                    }
                    return text;
                }).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateString = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
            link.setAttribute('href', url);
            link.setAttribute('download', `ReporteAccesos_${dateString}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- MÓDULOS: MODIFICA AVANCE TRIMESTRAL (AM y AC) ---

        /**
         * Popula los selects de periodo para los módulos de avance (AM y AC).
         */
        function populateAvancePeriodoSelects() {
            const amPeriodoSelect = document.getElementById('am-periodo-select');
            const acPeriodoSelect = document.getElementById('ac-periodo-select');
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: 10 }, (_, i) => currentYear - i); 

            [amPeriodoSelect, acPeriodoSelect].forEach(select => {
                if (select) {
                    select.innerHTML = '';
                    years.forEach(year => {
                        const option = new Option(year, year);
                        select.appendChild(option);
                    });
                    select.value = currentYear; 
                }
            });
        }

        /**
         * Renderiza la tabla para el módulo de Avance Trimestral AM.
         */
        function renderAvanceAMTable() {
            const tableBody = document.querySelector('#avance-am-table tbody');
            if (!tableBody) return;

            const institucionId = document.getElementById('am-institucion-id').value;
            const periodo = document.getElementById('am-periodo-select').value;

            if (!institucionId) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-3">Por favor, seleccione una institución para visualizar los datos.</td></tr>`;
                return;
            }

            tableBody.innerHTML = '';
            if (avanceAMData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-3">No hay actividades registradas para el periodo ${periodo}.</td></tr>`;
                return;
            }

            avanceAMData.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${periodo}</td>
                    <td>${index + 1}</td>
                    <td>${item.actividad}</td>
                    <td class="text-center-col">${item.avances['1T']}%</td>
                    <td class="text-center-col">${item.avances['2T']}%</td>
                    <td class="text-center-col">${item.avances['3T']}%</td>
                    <td class="text-center-col">${item.avances['4T']}%</td>
                    <td class="text-center-col">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="openAMAdvanceModal('${item.id}')" title="Editar Avance">
                             <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                    </td>
                `;
            });
        }

        /**
         * Renderiza la tabla para el módulo de Avance Trimestral AC.
         */
        function renderAvanceACTable() {
            const tableBody = document.querySelector('#avance-ac-table tbody');
            if (!tableBody) return;

            const institucionId = document.getElementById('ac-institucion-id').value;
            const periodo = document.getElementById('ac-periodo-select').value;

            if (!institucionId) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-3">Por favor, seleccione una institución para visualizar los datos.</td></tr>`;
                return;
            }

            tableBody.innerHTML = '';
            if (avanceACData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-gray-500 py-3">No hay actividades registradas para el periodo ${periodo}.</td></tr>`;
                return;
            }

            avanceACData.forEach((item, index) => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${periodo}</td>
                    <td>${index + 1}</td>
                    <td>${item.actividad}</td>
                    <td class="text-center-col">${item.avances['1T']}%</td>
                    <td class="text-center-col">${item.avances['2T']}%</td>
                    <td class="text-center-col">${item.avances['3T']}%</td>
                    <td class="text-center-col">${item.avances['4T']}%</td>
                    <td class="text-center-col">
                        <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white p-1 rounded-md text-xs" onclick="openACAdvanceModal('${item.id}')" title="Editar Avance">
                             <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        </button>
                    </td>
                `;
            });
        }

        /**
         * Sincroniza el valor de un input numérico con un slider.
         * @param {string} numberInputId - ID del input numérico.
         * @param {string} sliderId - ID del slider.
         */
        function syncSlider(numberInputId, sliderId) {
            const numberInput = document.getElementById(numberInputId);
            const slider = document.getElementById(sliderId);
            let value = parseInt(numberInput.value);
            if (isNaN(value) || value < 0) value = 0;
            if (value > 100) value = 100;
            numberInput.value = value;
            slider.value = value;
        }

        /**
         * Sincroniza el valor de un slider con un input numérico.
         * @param {string} sliderId - ID del slider.
         * @param {string} numberInputId - ID del input numérico.
         */
        function syncNumberInput(sliderId, numberInputId) {
            const slider = document.getElementById(sliderId);
            const numberInput = document.getElementById(numberInputId);
            numberInput.value = slider.value;
        }

        /**
         * Abre el modal para modificar el avance de una actividad de AM.
         * @param {string} itemId - El ID de la actividad.
         */
        function openAMAdvanceModal(itemId) {
            currentAdvanceType = 'AM';
            currentEditingAdvanceItem = avanceAMData.find(item => item.id === itemId);
            if (!currentEditingAdvanceItem) return;

            const periodo = document.getElementById('am-periodo-select').value;
            document.getElementById('am-advance-modal-subtitle').textContent = `Acción #${avanceAMData.findIndex(i => i.id === itemId) + 1} - ${periodo}`;

            document.getElementById('am-avance-1t').value = currentEditingAdvanceItem.avances['1T'];
            document.getElementById('am-avance-2t').value = currentEditingAdvanceItem.avances['2T'];
            document.getElementById('am-avance-3t').value = currentEditingAdvanceItem.avances['3T'];
            document.getElementById('am-avance-4t').value = currentEditingAdvanceItem.avances['4T'];
            
            syncSlider('am-avance-1t', 'am-slider-1t');
            syncSlider('am-avance-2t', 'am-slider-2t');
            syncSlider('am-avance-3t', 'am-slider-3t');
            syncSlider('am-avance-4t', 'am-slider-4t');

            calculateAMAccumulated();
            document.getElementById('am-advance-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal de avance AM.
         */
        function closeAMAdvanceModal() {
            document.getElementById('am-advance-modal-overlay').classList.add('hidden');
            currentEditingAdvanceItem = null;
        }

        /**
         * Calcula y muestra el porcentaje acumulado en el modal de avance AM.
         */
        function calculateAMAccumulated() {
            const t1 = parseFloat(document.getElementById('am-avance-1t').value) || 0;
            const t2 = parseFloat(document.getElementById('am-avance-2t').value) || 0;
            const t3 = parseFloat(document.getElementById('am-avance-3t').value) || 0;
            const t4 = parseFloat(document.getElementById('am-avance-4t').value) || 0;
            const total = t1 + t2 + t3 + t4;
            document.getElementById('am-avance-acumulado').textContent = `${Math.min(total, 100)}%`;
        }

        /**
         * Guarda los cambios de avance para una actividad AM.
         */
        function saveAMAdvance() {
            if (!currentEditingAdvanceItem) return;
            const t1 = parseFloat(document.getElementById('am-avance-1t').value) || 0;
            const t2 = parseFloat(document.getElementById('am-avance-2t').value) || 0;
            const t3 = parseFloat(document.getElementById('am-avance-3t').value) || 0;
            const t4 = parseFloat(document.getElementById('am-avance-4t').value) || 0;
            
            if ((t1 + t2 + t3 + t4) > 100) {
                showAlert('El avance acumulado no puede ser mayor a 100%.');
                return;
            }

            currentEditingAdvanceItem.avances['1T'] = t1;
            currentEditingAdvanceItem.avances['2T'] = t2;
            currentEditingAdvanceItem.avances['3T'] = t3;
            currentEditingAdvanceItem.avances['4T'] = t4;

            localStorage.setItem('avanceAMData_v1_6', JSON.stringify(avanceAMData));
            renderAvanceAMTable();
            closeAMAdvanceModal();
            showAlert('Avance guardado correctamente.');
        }

        /**
         * Abre el modal para modificar el avance de una actividad de AC.
         * @param {string} itemId - El ID de la actividad.
         */
        function openACAdvanceModal(itemId) {
            currentAdvanceType = 'AC';
            currentEditingAdvanceItem = avanceACData.find(item => item.id === itemId);
            if (!currentEditingAdvanceItem) return;

            const periodo = document.getElementById('ac-periodo-select').value;
            document.getElementById('ac-advance-modal-subtitle').textContent = `Acción #${avanceACData.findIndex(i => i.id === itemId) + 1} - ${periodo}`;

            document.getElementById('ac-avance-1t').value = currentEditingAdvanceItem.avances['1T'];
            document.getElementById('ac-avance-2t').value = currentEditingAdvanceItem.avances['2T'];
            document.getElementById('ac-avance-3t').value = currentEditingAdvanceItem.avances['3T'];
            document.getElementById('ac-avance-4t').value = currentEditingAdvanceItem.avances['4T'];

            syncSlider('ac-avance-1t', 'ac-slider-1t');
            syncSlider('ac-avance-2t', 'ac-slider-2t');
            syncSlider('ac-avance-3t', 'ac-slider-3t');
            syncSlider('ac-avance-4t', 'ac-slider-4t');

            calculateACAccumulated();
            document.getElementById('ac-advance-modal-overlay').classList.remove('hidden');
        }

        /**
         * Cierra el modal de avance AC.
         */
        function closeACAdvanceModal() {
            document.getElementById('ac-advance-modal-overlay').classList.add('hidden');
            currentEditingAdvanceItem = null;
        }

        /**
         * Calcula y muestra el porcentaje acumulado en el modal de avance AC.
         */
        function calculateACAccumulated() {
            const t1 = parseFloat(document.getElementById('ac-avance-1t').value) || 0;
            const t2 = parseFloat(document.getElementById('ac-avance-2t').value) || 0;
            const t3 = parseFloat(document.getElementById('ac-avance-3t').value) || 0;
            const t4 = parseFloat(document.getElementById('ac-avance-4t').value) || 0;
            const total = t1 + t2 + t3 + t4;
            document.getElementById('ac-avance-acumulado').textContent = `${Math.min(total, 100)}%`;
        }

        /**
         * Guarda los cambios de avance para una actividad AC.
         */
        function saveACAdvance() {
            if (!currentEditingAdvanceItem) return;
            const t1 = parseFloat(document.getElementById('ac-avance-1t').value) || 0;
            const t2 = parseFloat(document.getElementById('ac-avance-2t').value) || 0;
            const t3 = parseFloat(document.getElementById('ac-avance-3t').value) || 0;
            const t4 = parseFloat(document.getElementById('ac-avance-4t').value) || 0;

            if ((t1 + t2 + t3 + t4) > 100) {
                showAlert('El avance acumulado no puede ser mayor a 100%.');
                return;
            }

            currentEditingAdvanceItem.avances['1T'] = t1;
            currentEditingAdvanceItem.avances['2T'] = t2;
            currentEditingAdvanceItem.avances['3T'] = t3;
            currentEditingAdvanceItem.avances['4T'] = t4;

            localStorage.setItem('avanceACData_v1_6', JSON.stringify(avanceACData));
            renderAvanceACTable();
            closeACAdvanceModal();
            showAlert('Avance guardado correctamente.');
        }

    </script>
</body>
</html>
